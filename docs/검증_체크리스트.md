# 지금 어때? (HowAreYou) — GPT 검증용 전체 콘텐츠·기능 체크리스트

> 앱/웹 전체 구축 내용 및 콘텐츠 상세 정리. GPT 최종 검증 시 참고용.

**목차 요약**: 1 프로젝트 개요 | 2 웹 홈페이지(메인·베타·약관) | 3 웹 1:1 문의 | 4 관리자(대시·회원·대기·공지·문의) | 5 앱 화면 전체 | 6~9 Firestore·API·Functions·규칙 | 10~12 유틸·인덱스 | 13 검증 시나리오 | 14~16 인증·환경·파일경로

---

## 1. 프로젝트 개요

| 구분 | 기술 스택 | 버전 |
|------|-----------|------|
| **앱** | Flutter, Firebase (Auth, Firestore, Messaging, Functions) | SDK ≥3.0 |
| **웹** | Next.js 15, Tailwind CSS, Firebase Admin SDK | React 19 |
| **백엔드** | Firestore, Cloud Functions | — |
| **배포** | Vercel(웹), Flutter iOS/Android | — |

**서비스명**: 지금 어때?  
**핵심 가치**: 매일 전화 대신 3초로 안부 확인. 보호대상자 ↔ 보호자 연결.

**설정 상수**:
- 베타 선착순: 100명
- 연 결제: 12,000원
- 앱 초대 링크: `https://howareyou-1c5de.web.app/invite`
- 약관/개인정보: `https://how-are-you-nu.vercel.app/terms`, `/privacy`

---

## 2. 웹 홈페이지 — 페이지별 콘텐츠

### 2.1 메인 페이지 (`/`)

**구성 섹션 순서**: HeroSection → ProblemSection → ServiceSection → PricingSection → RecommendSection → TrustSection → FaqSection → AnnouncementsSection → CtaSection → Footer

---

**HeroSection**:
- 브랜드: "여기 어때?" (로고 alt: 지금 어때)
- 헤드라인: "안부로 안심을 전하는 가족 앱"
- 부제: "매일 전화하지 않아도, 안부는 전해집니다. / 작은 기록 하나로 서로의 안심을 확인하세요."
- CTA: "베타 참여하기"
- 보조: "선착순 100명 · 출시 최우선 안내 · 1년 무료 이용"
- 캐러셀 이미지 4장: 역할 선택, 컨디션 기록, 최근 컨디션, 전달된 안부 (이전/다음 버튼 aria-label)

---

**ProblemSection** ("이런 분들께 필요합니다"):
1. 혼자 사는 부모님이 / 걱정될 때
2. 내가 혼자 사는데 / 연락할 보호자가 필요할 때
3. 타지에 있는 가족 또는 지인의 / 안부가 궁금할 때

---

**ServiceSection** ("이렇게 안부를 전합니다"):
1. **간단하게 남깁니다** — 버튼 한 번으로 오늘의 안부를 기록합니다. 길게 쓰지 않아도 괜찮습니다.
2. **필요한 순간에만 안내합니다** — 기록을 하면 보호자에게 알림이 전달됩니다. 기록이 없을 때는 당일 저녁 7시(보호대상자 기록 요청), 8시(보호자 안내)에만 발송됩니다. 불필요한 알림은 보내지 않습니다.
3. **3일 이상 신호가 없을 때** — 3일 연속 기록이 없으면 보호자에게 추가 안내가 전달됩니다. 조용하지만 놓치지 않는 구조입니다.
- 면책: ※ 본 서비스는 의료·응급 구조 서비스가 아닙니다. 네트워크 및 기기 환경에 따라 알림이 지연될 수 있습니다.

---

**PricingSection** ("요금 안내"):
- 설명: "1개월 무료 체험 후 연 결제됩니다. / 결제는 보호자만 진행합니다."
- 가격: "연 12,000원"
- 기능: 보호대상자 무제한 추가, 매일 안부 알림, 3일 무응답 통지, 1개월 무료 체험 (계정 생성일 기준)
- 안내: 결제는 보호자만 진행합니다. 언제든지 앱 설정에서 스토어로 이동해 연 결제를 취소할 수 있습니다.
- CTA: "1개월 무료로 시작하기" (스크롤 to CtaSection)

---

**RecommendSection** ("이런 분들께 추천합니다"):
1. 부모님과 떨어져 지내는 분
2. 매일 전화는 어렵지만 안부는 확인하고 싶은 분
3. 조용하게 서로의 안심을 확인하고 싶은 가족

---

**TrustSection** ("우리가 하지 않는 것"):
- 부제: 프라이버시를 지키기 위한 우리의 약속입니다.
1. 위치 추적하지 않습니다.
2. 감시하지 않습니다.
3. 평가하거나 점수화하지 않습니다.

---

**FaqSection** ("자주 묻는 질문") — 아코디언 7개:
- Q. 누가 결제하나요? → A. 보호자만 결제합니다. 보호대상자는 무료로 이용합니다.
- Q. 무료 체험은 어떻게 되나요? → A. 계정 생성일 기준 1개월 무료, 이후 연 12,000원 자동 결제. 만료 후 7일 유예, 결제 전 알림·기록 열람 제한.
- Q. 언제든 해지할 수 있나요? → A. 앱 설정에서 스토어로 이동해 연 결제 취소. 취소 시 다음 결제일부터 과금 없음. 위약금·숨은 비용 없음.
- Q. 위치 추적 기능이 있나요? → A. 제공하지 않습니다.
- Q. 알림은 어떻게 발송되나요? → A. 보호대상자: 당일 미기록 시 매일 19:00. 보호자: 기록 시 실시간, 미기록 시 20:00 1회, 3일 연속 없을 때 추가 1회.
- Q. 보호자는 어떤 기록을 볼 수 있나요? → A. 오늘 기록 여부만. 컨디션·메모·위치·상세 건강 정보 비공개.
- Q. 탈퇴하면 데이터와 과금은 어떻게 되나요? → A. 데이터 즉시 삭제. 연 결제는 스토어 자동 갱신이라 탈퇴만 하면 과금 계속됨. 과금 멈추려면 스토어에서 직접 취소.
- 하단 링크: "답을 찾지 못하셨나요? 1:1 문의하기"

---

**AnnouncementsSection** ("공지사항"):
- Firestore `announcements` 동적 로드 (title, content, createdAt, pinned)
- pinned 항목에 "중요" 배지
- 날짜: toLocaleDateString ko-KR (year, month long, day)

---

**CtaSection** (id="cta"):
- 제목: "지금 어때 시작하기"
- 부제: "정식 출시 후 1개월 무료 체험 · 지금 베타 참여 시 1년 무료"
- 버튼: "베타 참여하기"

---

**Footer**:
- 링크: 1:1 문의 | 이용약관 | 개인정보처리방침
- 회사명: 새봄인터내셔널 | 대표: 박진희 | 사업자등록번호: 129-09-53285
- 개인정보 보호책임자: 고형석 | 이메일: clubbob@naver.com | 연락처: 010-6391-4520
- Copyright © 2026 지금 어때. All rights reserved.

---

### 2.2 베타 참여 모달 (BetaModal)

**제목**: 베타 참여하기

**혜택 박스**: "베타 참여 혜택 (선착순 100명)" / "출시 시 최우선 안내 · 1년 무료 이용"

**입력**: 이메일(필수, placeholder: 이메일 example@email.com), 연락처(필수, placeholder: 연락처 010-1234-5678 - 코드 전달용)

**안내**: "이메일과 연락처를 입력해 주세요. 출시 시 안내 및 코드 전달에 사용됩니다."

**버튼**: 취소 | 참여 신청 (로딩: 등록 중...)

**성공 화면**: ✓ 아이콘 / "등록되었습니다." / "빠른 시일 내에 연락드리겠습니다." / [확인]

**마감 화면**: "마감되었습니다" / "선착순 100명이 마감되었습니다. 관심 가져 주셔서 감사합니다." / [확인]

**이미 신청**: "이미 신청하셨습니다." / "등록된 이메일로 출시 시 안내드리겠습니다." / [확인]

**에러**: "등록에 실패했습니다. 다시 시도해 주세요." (또는 API 에러 메시지)

---

### 2.3 이용약관·개인정보처리방침

**이용약관** (`/terms`): 제목 "이용약관 - 지금 어때", 네비 "← 홈으로", legal-content.ts TERMS_CONTENT (제1조~제11조)

**개인정보처리방침** (`/privacy`): 제목 "개인정보처리방침 - 지금 어때", 네비 "← 홈으로", PRIVACY_CONTENT (섹션 1~15)

### 2.2 1:1 문의 페이지 (`/inquiry`)

**탭**
- "문의 하기" | "문의 확인"

**문의 하기 탭 — 안내 문구**:
- "서비스 이용 중 궁금한 점이 있으시면 문의해 주세요. 영업일 기준 1~2일 내 답변 드립니다."

**문의 하기 폼**:
- 문의 내용 * (placeholder: "문의 내용을 입력해 주세요.", max 2000자, 글자수 표시)
- 비밀번호 * (placeholder: "답변 확인 시 사용할 비밀번호 (4자 이상)", min 4, max 50)
- 안내: "문의 확인 시 입력한 비밀번호가 필요합니다."
- 버튼: "문의 등록" / "등록 중..."

**문의 하기 성공 화면**:
- ✓ 아이콘
- "문의가 접수되었습니다."
- "빠른 시일 내에 답변 드리겠습니다."
- 박스: "문의 번호" (1.5rem bold monospace), "비밀번호" (1.25rem)
- "위 정보를 꼭 기억해 두세요. **문의 확인** 탭에서 답변을 확인할 수 있습니다."
- 버튼: "답변 확인하기" | "홈으로" | "다른 문의하기"

**문의 확인 탭 — 안내**:
- "문의 등록 시 안내된 문의 번호와 비밀번호로 답변 확인이 가능합니다."

**문의 확인 폼**:
- 문의 번호 (placeholder: "예: ABC123", maxLength 6, 대문자 변환)
- 비밀번호 (placeholder: "문의 등록 시 입력한 비밀번호")
- 버튼: "확인" / "조회 중..."

**문의 확인 결과 표시**:
- 작성일시 (toLocaleString ko-KR)
- 문의 내용
- "관리자 답변" 섹션 또는 "답변 대기 중입니다."
- "문의 삭제" 버튼 (확인: "문의를 삭제하시겠습니까? 삭제하시면 문의 확인 화면에서는 더 이상 볼 수 없습니다.")

**공통 하단**:
- "급한 문의는 clubbob@naver.com · 010-6391-4520 으로 연락해 주세요."

---

## 3. 웹 1:1 문의 API — 상세 스펙

### POST /api/inquiry (문의 등록)

**Request Body**:
```json
{
  "message": "string (필수, 1~2000자)",
  "password": "string (필수, 4~50자)"
}
```

**성공 200**:
```json
{ "success": true, "inquiryCode": "ABC123" }
```

**에러**:
- 400: `{ "error": "문의 내용을 입력해주세요." }` / `"문의 내용은 2000자 이내로 입력해주세요."` / `"비밀번호를 4자 이상 입력해주세요."` / `"비밀번호는 50자 이내로 입력해주세요."`
- 500: `{ "error": "문의 등록에 실패했습니다." }` / `"서비스를 일시적으로 사용할 수 없습니다."`

### GET /api/inquiry/check (문의 조회)

**Query**: `?code=ABC123&password=xxx`

**성공 200**:
```json
{
  "id": "docId",
  "inquiryCode": "ABC123",
  "message": "...",
  "createdAt": "ISO8601",
  "replies": [{ "message": "...", "createdAt": "ISO8601" }]
}
```

**에러**:
- 400: `"문의 번호를 입력해주세요."` / `"비밀번호를 입력해주세요."`
- 401: `"비밀번호가 일치하지 않습니다."`
- 404: `"문의를 찾을 수 없습니다."` (없음 또는 deletedByUserAt)
- 500: `"조회에 실패했습니다."` / `"서비스를 일시적으로 사용할 수 없습니다."`

### POST /api/inquiry/delete (문의자 삭제)

**Request Body**:
```json
{ "code": "ABC123", "password": "xxx" }
```

**성공 200**: `{ "success": true }`

**에러**:
- 400: `"문의 번호를 입력해주세요."` / `"비밀번호를 입력해주세요."` / `"이미 삭제된 문의입니다."`
- 401: `"비밀번호가 일치하지 않습니다."`
- 404: `"문의를 찾을 수 없습니다."`
- 500: `"삭제에 실패했습니다."`

---

## 4. 관리자 화면 — 콘텐츠

### 4.1 네비게이션 (AdminNav)

메뉴: 대시보드 | 회원관리 | 1:1 문의(미답변 배지) | 공지사항 | 베타 대기  
우측: "홈페이지" (새 탭) | "로그아웃"

### 4.2 대시보드 (`/admin`)

**제목**: 관리자 대시보드

**AdminStats 카드**: 가입 회원, 미답변 문의, 전체 문의, 공지사항, 베타 대기 (각 링크로 이동)

**에러**: Firebase 미연결 시 "Firebase Admin이 연결되지 않았습니다..." / 통계 로드 실패 "통계를 불러오지 못했습니다." + [다시 시도]

### 4.3 회원관리 (`/admin/members`)

**제목**: 회원관리

**역할 요약**: 보호대상자 N명, 보호자 N명, 둘 다 N명

**필터**: 전화번호·이름 검색, 역할(전체/보호대상자/보호자/둘 다), 정렬(가입일 최신순/오래된순, 이름 가나다순/역순)

**테이블**: 전화번호, 이름, 역할, 가입일

**버튼**: CSV 내보내기

**페이지네이션**: 이전, N / M 페이지, 다음

**빈 상태**: "등록된 회원이 없습니다." / "검색 결과가 없습니다."

**상세 모달**: 회원 상세 — 전화번호, 이름, 역할, 가입일, 회원 ID

### 4.4 베타 대기 (`/admin/waitlist`)

**제목**: 베타 대기

**검색**: 이메일

**안내**: 총 N명 / M명 (선착순 100명 한정)

**버튼**: 이메일 일괄 복사, CSV 내보내기, 선택 삭제 (N), 새로고침

**테이블**: 체크박스, 번호, 이메일, 연락처(편집), 신청일시

**연락처 편집**: placeholder 010-1234-5678, [저장] [취소]

**빈 상태**: "대기자가 없습니다." / "검색 결과가 없습니다."

### 4.5 공지사항 (`/admin/announcements`)

**제목**: 공지사항

**정렬**: 등록일 순 / 수정일 순

**폼**: 제목, 내용(글자 수), 상단 고정 체크

**버튼**: 미리보기, 등록/수정, 취소

**카드**: 제목, 등록/수정일, 상단고정 배지, 내용, [수정] [삭제]

**빈 상태**: "등록된 공지가 없습니다."

### 4.6 1:1 문의 관리 (`/admin/inquiries`)

**헤더**: "1:1 문의" | "새로고침"

**필터**: 상태(전체/미답변/답변완료), 기간(전체/최근 7일/최근 30일)

**문의 목록 (좌측)**: 문의 내용 요약, 배지 "문의자 삭제"/"답변완료"/"미답변", `문의번호 ABC123` 또는 `연락처`·작성일시·답변 N건

**빈 상태**: "문의를 선택하세요." / "문의가 없습니다." / "해당 조건의 문의가 없습니다."

**문의 상세 (우측)**: `문의번호 ABC123` 또는 `연락처·이름` · roleLabel · "문의자 삭제됨" 배지 / 문의 본문 / 답변 목록 / placeholder "답변을 입력하세요" / [답변 등록] [문의 삭제]

**roleLabel**: visitor→홈페이지 방문자, subject→보호대상자, guardian→보호자, both→둘 다

**에러**: "Failed to fetch" → "서버에 연결할 수 없습니다. 개발 서버가 실행 중인지 확인해 주세요." / 401 → "로그인이 필요합니다."

---

## 5. 앱 (Flutter) — 화면별 콘텐츠

### 5.1 인증 화면 (`auth_screen.dart`)

**전화번호 입력 전**:
- 제목: "지금 어때?"
- 부제: "매일 전화 대신 3초 확인. 하루 한 번이면 충분해요."
- 입력: "핸드폰 번호" (placeholder: 01012345678)
- 안내: "숫자만 입력하세요"
- 체크박스: "이용약관에 동의" + "보기 (필수)"
- 체크박스: "개인정보처리방침에 동의" + "보기 (필수)"
- 버튼: "인증번호 받기"

**인증번호 입력 시**:
- 제목: "인증번호 입력"
- 부제: "문자로 받은 6자리 인증번호를 입력해 주세요."

**전화번호 검증**:
- 클라이언트: 010으로 시작 11자리 (`_isValidKoreanMobile`)
- 미통과 시: "010으로 시작하는 11자리 번호를 입력해 주세요."
- 입력 제한: `FilteringTextInputFormatter.digitsOnly` → 숫자만 입력 가능
- **+82 형식 직접 입력 불가** (숫자 전용 포맷터로 `+`·공백·`-` 입력 차단)
- 허용 형식: `01012345678` (11자리 숫자만)

**국제번호(E.164) 처리**:
- `_toE164()`: `01012345678` → `+821012345678`로 변환 후 Firebase에 전달
- Firebase `verifyPhoneNumber`는 E.164 형식(`+821012345678`)을 요구하며, 현재 변환이 정확함
- 문제 없음 (010 → +82 10 변환 로직 검증 완료)

**Firebase verificationFailed 메시지**:
- invalid-phone-number: "입력한 핸드폰 번호 형식이 올바르지 않습니다. / 010으로 시작하는 11자리 번호를 입력해 주세요."
- missing-phone-number: "핸드폰 번호를 입력해주세요."
- quota-exceeded: "일일 인증 횟수를 초과했습니다. 잠시 후 다시 시도해주세요."
- too-many-requests: "너무 많은 요청이 발생했습니다. 5-10분 후 다시 시도해주세요."
- default: "인증에 실패했습니다. 핸드폰 번호를 확인한 후 다시 시도해 주세요."

**다른 번호 로그인 시**:
- "이전에 로그인한 번호와 다른 번호입니다."
- "다른 핸드폰 번호로 로그인하면 기존 계정과 다른 계정으로 로그인됩니다. 계속하시겠습니까?"

**약관 체크박스 (`_AgreeCheckRow`)**:
- Row(Checkbox 40×40, Expanded(Column(라벨, "보기 (필수)" 링크)))
- softWrap: true, 오버플로우 방지

### 5.2 앱 1:1 문의 (`inquiry_screen.dart`)

**조건**: 로그인 필수 (미로그인 시 "로그인이 필요합니다.")

**문의 하기 탭**: "서비스 이용 중 궁금한 점이 있으시면 문의해 주세요..." / **"로그인된 계정정보는 관리자에게 전달됩니다."** / 문의 내용 * (max 2000) / [문의 등록] / "급한 문의는 clubbob@naver.com · 010-6391-4520으로 연락해 주세요."

**문의 확인 탭**: 본인 문의만 Firestore 조회 (userId 일치)

**성공 화면**: "문의가 접수되었습니다." / "빠른 시일 내에 답변 드리겠습니다." / "문의 확인 탭에서 답변을 확인할 수 있습니다." / [다른 문의하기]

---

### 5.3 홈 화면 (`home_screen.dart`)

**제목**: 지금 어때?

**헤드라인**: "버튼 하나로 안부를 전해요." / "하루 한 번이면 충분해요."

**역할 선택**: "어떤 역할로 시작할까요?" / "언제든 바꿀 수 있어요."
- [보호대상자] 안부를 남겨요.
- [보호자] 전달된 안부를 확인해요.

**보호대상자 진입 시**: 보호자 없으면 GuardianScreen으로, 있으면 SubjectModeScreen

**디버그**: 테스트 알림 — 보호대상자 알림, 보호자 알림

---

### 5.4 보호대상자 모드 (`subject_mode_screen.dart`)

**제목**: 보호대상자 모드

**헤드라인**: "오늘도 잘 지내고 계신가요?" / "하루 한 번이면 충분합니다."

**버튼**: [오늘 컨디션 기록하기], [최근 컨디션], [보호자 관리]

**안내**: "하루 한 번, 버튼만 누르면 안부가 전달돼요." / "보호자에게 기록 내용은 공유되지 않으며, 안부가 전달되었는지만 표시됩니다."

**배너**: "알림을 켜야 컨디션 기록 알림을 받을 수 있습니다."

**연속 기록**: "N일 연속 기록 중"

**환영 다이얼로그**: "안내" — "하루 한 번이면 충분해요. / 간단히 컨디션을 기록해 두세요." / [확인]

**보호자 없음**: "보호자가 지정되지 않았습니다" / "안부를 전달하려면 먼저 보호자를 지정해주세요." / [보호자 관리]

---

### 5.5 컨디션 기록 (`question_screen.dart`)

**제목**: 오늘 컨디션 기록하기

**헤드라인**: "지금 어때?"

**선택 옵션** (Mood.selectableMoods): 괜찮아 🙂, 보통 😐, 별로 🙁

**메모**: "한 줄 메모 (선택)", placeholder "필요하면 한 줄만 남겨요.", max 50자

**버튼**: [저장] (로딩: 저장 중...)

**이미 기록 시**: "오늘 안부는 이미 전달됐어요. 자정(한국 시간) 이후에 다시 남길 수 있어요." 또는 다이얼로그 "오늘 안부는 이미 전달됐어요" / "오늘 기록은 이미 보호자에게 전달되었습니다." / [닫기] [다시 선택하기]

---

### 5.6 보호자 추가/관리 (`guardian_screen.dart`)

**입력**: 이름, 핸드폰 번호 (placeholder: 01012345678 숫자만)

**초대**: 보호자 초대 링크, 공유 예시 문구
- 대상자→보호자: "매일 전화 대신 3초로 확인할 수 있어요. / 설치하면 안부가 잘 전달됐는지 확인할 수 있어요."
- 보호자→대상자: "엄마, 매일 전화 대신 이거 하나만 눌러줘 😊"

**보호자 추가**: 전화번호로 등록된 사용자 검색 후 연결

---

### 5.7 보호자 모드 (`guardian_mode_screen.dart`)

**제목**: 보호자 모드

**헤드라인**: "보호자 모드" / "안부 확인과 보호 대상을 관리하세요"

**버튼**: [안부 확인], [보호 대상 관리]

**배너**: "알림을 켜야 안부 확인 알림을 받을 수 있습니다."

---

### 5.8 보호자 대시보드·대상자 상세 (`guardian_dashboard_screen.dart`, `subject_detail_screen.dart`)

**탭**: 안부 확인 | 보호 대상 관리

**보호대상자 추가**: 이름, 핸드폰 번호 (01012345678 숫자만)

**대상자별**: 전달된 안부 (오늘/최근 기록), 오늘 기록 여부만 표시 (컨디션·메모 비공개)

---

### 5.9 회신 없음 (`no_response_screen.dart`)

**제목**: 회신 없음

**헤드라인**: "{이름}님과 연락이 닿지 않고 있어요."

**부제**: "{slot} 회신이 없습니다. 연락해 보시거나, 나중에 다시 확인해 보세요."

**버튼**: [전화하기] → SnackBar: "{이름}님에게 전화해 보세요. (핸드폰 번호는 보호자 관리에서 확인)"

---

### 5.10 앱 설정·회원 탈퇴 (`subject_settings_screen.dart`, `guardian_dashboard_screen`)

**설정**: 결제 취소(스토어 이동), 회원 탈퇴(재인증 OTP 후 삭제)

**탈퇴 플로우**:
1. 1단계: "탈퇴하면 데이터 삭제. 연 결제(12,000원)는 스토어 자동 갱신. 탈퇴만 하면 결제 안 멈춤."
   - [취소] [과금 멈추러 가기] [탈퇴 계속]
2. 유료 결제 중이면 2단계: "연 결제가 진행 중입니다. 탈퇴해도 결제는 멈추지 않습니다."
   - [취소] [과금 멈추러 가기] [탈퇴]
3. 탈퇴 계속 → deleteAccount → 필요 시 재인증 OTP 후 삭제

---

## 6. Firestore — 전체 스키마

### 6.1 inquiries (1:1 문의)

앱(로그인): userId, userPhone, userDisplayName, role(subject|guardian|both), message, createdAt, replies  
웹(visitor): userId "", userPhone null, userDisplayName null, role "visitor", email null, message, inquiryCode, passwordHash, deletedByUserAt, createdAt, replies

### 6.2 users

id=Auth UID, phone(E.164), displayName, role(subject|guardian|both), createdAt, fcmTokens, termsAgreedAt, privacyAgreedAt, subjectLabels(map)

### 6.3 subjects

id=보호대상자 Auth UID, pairedGuardianUids, guardianInfos{uid:{phone, displayName, pairedAt}}, lastResponseAt, createdAt, displayName, currentStreak, longestStreak, lastGuardianAlertAt

### 6.4 subjects/{id}/prompts

id=yyyy-MM-dd, slot='daily', mood(1~5), note, answeredAt. (note는 보호자에게 비공개)

### 6.5 announcements

title, content, pinned, createdAt, updatedAt

### 6.6 waitlist

email, phone, createdAt

### 6.7 pending_guardian_invites, pending_subject_invites

가입 시 Cloud Functions에서 subject-guardian 자동 연결 후 삭제

### 6.8 notification_requests

앱에서 생성, Cloud Functions 전용

---

## 7. 웹·관리자 API 전체

### 7.1 POST /api/waitlist (베타 대기)

**Request**: `{ email: string, phone?: string }`  
**성공 200**: `{ status: 'success' | 'already_registered' | 'full' }`  
**에러**: 400 "이메일을 입력해 주세요." / 500 "등록에 실패했습니다." / "서비스를 일시적으로 사용할 수 없습니다."  
**로직**: 100명 초과 시 full, 동일 이메일 있으면 already_registered(연락처 없을 때 업데이트 가능)

### 7.2 관리자 API

| Route | Method | 용도 |
|-------|--------|------|
| /api/admin/login | POST | username, password → admin_session 쿠키 |
| /api/admin/auth | GET | 세션 확인 |
| /api/admin/logout | POST | 로그아웃 |
| /api/admin/stats | GET | usersCount, inquiriesCount, unansweredInquiriesCount, announcementsCount, waitlistCount |
| /api/admin/users | GET | 회원 목록 (필터·정렬·페이지네이션) |
| /api/admin/waitlist | GET | 대기 목록 |
| /api/admin/waitlist/[id] | PATCH | 연락처 수정 |
| /api/admin/waitlist/[id] | DELETE | 대기 삭제 |
| /api/admin/inquiries | GET | 문의 목록 |
| /api/admin/inquiries/[id] | DELETE | 문의 삭제(하드) |
| /api/admin/inquiries/[id]/reply | POST | 답변 등록 { message } |
| /api/admin/announcements | GET/POST | 공지 목록/등록 |
| /api/admin/announcements/[id] | PATCH/DELETE | 공지 수정/삭제 |

**에러**: 401 Unauthorized, Firestore 미설정, 로그인 실패 "아이디 또는 비밀번호가 올바르지 않습니다."

---

## 8. Cloud Functions

| Function | 트리거 | 용도 |
|----------|--------|------|
| processPendingInvitesOnSignup | Auth user.onCreate | 대기 초대 가입 시 subject-guardian 자동 연결 |
| removeGuardianFromSubject | HTTPS Callable | 보호자가 보호대상자 목록에서 자신 제거 |
| onResponseCreated | prompts onCreate | 응답 시 보호자 FCM 알림 |
| onResponseUpdated | prompts onUpdate | 응답 수정 시 보호자 FCM 알림 |
| sendSubjectReminder | Pub/Sub 19:00 KST | 보호대상자 리마인드 (당일 미기록) |
| sendGuardianReminder | Pub/Sub 20:00 KST | 보호자 리마인드 (당일 미기록) |
| sendThreeDayNoResponseAlert | Pub/Sub 20:05 KST | 3일 무응답 시 보호자 강화 알림 |

---

## 9. Firestore 보안 규칙 요약

- **users**: 본인만 read/write, 인증자 read
- **subjects**: 보호대상자 본인 read/write, 보호자 read, 보호자 추가/제거 시 허용된 필드만 write
- **prompts**: 보호대상자 read/write, 보호자 read (pairedGuardianUids 포함 시)
- **pending_*_invites**: create만 (본인 UID 일치), read/update/delete false
- **waitlist**: create만 누구나, read/update/delete false
- **announcements**: read만 누구나, write false
- **inquiries**: 앱 사용자 create/read/update/delete (본인 userId)

---

## 10. inquiry-utils.ts

**hashPassword**: scrypt N=4096, r=8, p=1, SALT 16, KEY 64 → `2:salt:hash`  
**verifyPassword**: 구형 `salt:hash`(default scrypt), 신규 `2:salt:hash`  
**generateInquiryCode**: 6자리, `ABCDEFGHJKLMNPQRSTUVWXYZ23456789` (혼동 문자 제외)

---

## 11. firebase-admin.ts

- 모듈 로드 시 `process.env.FIREBASE_SERVICE_ACCOUNT_JSON` 있으면 `getAdminFirestore()` 사전 호출
- Firestore 인스턴스 캐싱 (`_firestore`)

---

## 12. Firestore 인덱스

```json
[
  { "collectionGroup": "inquiries", "fields": ["userId", "createdAt"] },
  { "collectionGroup": "inquiries", "fields": ["role", "email", "createdAt"] },
  { "collectionGroup": "inquiries", "fields": ["role", "inquiryCode"] }
]
```

---

## 13. 검증 시나리오

### 웹 1:1 문의
1. `/inquiry` 접속 → 문의 하기
2. 문의 내용 + 비밀번호 입력 → 등록
3. 성공 화면에서 문의번호·비밀번호 확인
4. "답변 확인하기" 클릭 → 확인 탭 자동 조회
5. 문의 삭제 클릭 → 확인 → 조회 시 404

### 관리자
1. `/admin/login` 로그인
2. `/admin/inquiries` → visitor 문의는 "문의번호 ABC123", role "홈페이지 방문자"
3. 문의자 삭제 문의는 "문의자 삭제" 배지
4. 답변 등록, 문의 삭제(하드)

### 앱 인증
1. 010 12자리 입력 → "010으로 시작하는 11자리 번호를 입력해 주세요."
2. 010 11자리 정상 입력 → 인증번호 전송
3. 약관 미체크 → 버튼 비활성
4. 체크박스 오버플로우 없음 (다양한 화면 크기)
5. **국제번호 처리**: 01012345678 입력 → `+821012345678`로 변환해 Firebase 전달 (문제 없음)
6. **+82 직접 입력 불가**: 숫자만 허용되므로 `+82` 입력 시 `+`는 입력되지 않음

### 앱 1:1 문의
1. 로그인 후 문의 화면 진입
2. "로그인된 계정정보는 관리자에게 전달됩니다." 안내 노출
3. 문의 내용만 입력 후 등록
4. 문의 확인 탭에서 본인 문의 목록 확인

### 베타 참여
1. 메인 페이지 "베타 참여하기" 클릭 → 모달
2. 이메일·연락처 입력 → [참여 신청]
3. 성공: "등록되었습니다." / 이미 신청: "이미 신청하셨습니다." / 마감: "마감되었습니다"
4. 100명 초과 시 full 상태 반환

### 관리자 회원·대기·공지
1. 회원관리: 필터·검색·CSV 내보내기, 상세 모달
2. 베타 대기: 이메일 검색, 연락처 편집, 선택 삭제, 일괄 복사
3. 공지사항: 등록/수정/삭제, 상단 고정, 미리보기

### 앱 보호대상자 플로우
1. 홈 → 보호대상자 선택 → 보호자 없으면 GuardianScreen
2. 보호자 추가 후 SubjectModeScreen
3. "오늘 컨디션 기록하기" → 괜찮아/보통/별로 선택, 메모(선택) → 저장
4. 보호자에게 알림 전달 (기록 내용 비공개)

### 앱 보호자 플로우
1. 홈 → 보호자 선택 → GuardianModeScreen
2. 안부 확인 → 대상자별 오늘 기록 여부
3. 보호 대상 관리 → 대상자 추가(이름, 전화번호)
4. 회신 없음 시 NoResponseScreen

---

## 14. 관리자 인증

**미들웨어** (`middleware.ts`):
- matcher: `/admin`, `/admin/:path*`
- `/admin/login` 제외한 /admin 경로 → `admin_session` 쿠키 없으면 `/admin/login` 리다이렉트
- 이미 로그인 상태에서 `/admin/login` 접속 시 `/admin` 리다이렉트

**관리자 로그인 페이지** (`/admin/login`):
- 제목: "관리자 로그인"
- 입력: 아이디, 비밀번호
- 버튼: "로그인" / "로그인 중..."
- 에러: "로그인에 실패했습니다." / "네트워크 오류가 발생했습니다."
- 성공 시 `/admin` 이동

---

## 15. 환경 변수 (.env.local 예시)

```
NEXT_PUBLIC_FIREBASE_API_KEY, _AUTH_DOMAIN, _PROJECT_ID, _STORAGE_BUCKET, _MESSAGING_SENDER_ID, _APP_ID
ADMIN_USERNAME
ADMIN_PASSWORD
FIREBASE_SERVICE_ACCOUNT_JSON (JSON 문자열)
```

---

## 16. 주요 파일 경로

| 구분 | 경로 |
|------|------|
| 웹 메인 | `homepage/app/page.tsx` |
| 웹 섹션 | `homepage/components/HeroSection.tsx`, ProblemSection, ServiceSection, PricingSection, RecommendSection, TrustSection, FaqSection, AnnouncementsSection, CtaSection, Footer |
| 베타 모달 | `homepage/components/BetaModal.tsx` |
| 약관/개인정보 | `homepage/app/terms/page.tsx`, `privacy/page.tsx` |
| 웹 문의 | `homepage/app/inquiry/page.tsx` |
| 웹 문의 API | `homepage/app/api/inquiry/route.ts`, `check/route.ts`, `delete/route.ts` |
| 베타 대기 API | `homepage/app/api/waitlist/route.ts` |
| 관리자 | `homepage/app/admin/login/page.tsx`, `(dashboard)/page.tsx`, `members/page.tsx`, `waitlist/page.tsx`, `announcements/page.tsx`, `inquiries/page.tsx` |
| 관리자 API | `homepage/app/api/admin/login`, auth, logout, stats, users, waitlist, waitlist/[id], inquiries, inquiries/[id], inquiries/[id]/reply, announcements, announcements/[id] |
| 설정 | `homepage/lib/config/pricing.ts`, `beta.ts` |
| inquiry-utils | `homepage/lib/inquiry-utils.ts` |
| firebase-admin | `homepage/lib/firebase-admin.ts` |
| 앱 화면 | `lib/screens/auth_screen.dart`, home_screen, subject_mode_screen, question_screen, guardian_screen, guardian_mode_screen, guardian_dashboard_screen, subject_detail_screen, subject_my_status_screen, subject_settings_screen, inquiry_screen, no_response_screen, splash_screen, invited_*_welcome_screen |
| 앱 서비스 | `lib/services/auth_service.dart`, mood_service, guardian_service, inquiry_service, fcm_service, notification_service |
| 앱 상수 | `lib/utils/constants.dart` |
| Firestore 규칙 | `firestore.rules` |

---

*최종 수정: 2026년 2월 · GPT 검증용*
