# 1만 명 이용자 비용 예상

## 시나리오 가정

- **보호 대상(subject)**: 10,000명
- **보호자(guardian)**: 평균 2명/보호 대상 = 20,000명
- **각 보호 대상 응답 빈도**: 하루 3회 (아침/점심/저녁)

## 월 사용량 계산

### 1. 응답 알림 (processNotificationRequest)

**트리거 횟수:**
- 보호 대상 10,000명 × 하루 3회 × 30일 = **900,000회/월**

**함수 실행 시간:**
- FCM 토큰 조회: 약 0.5초
- FCM 메시지 발송: 약 0.5초
- 총 실행 시간: 약 **1-2초/회**

**메모리 사용량:**
- 기본 메모리: 256MB (0.256 GB)

**GB-초 계산:**
- 1회 실행: 0.256 GB × 2초 = 0.512 GB-초
- 월 총량: 900,000회 × 0.512 = **460,800 GB-초**

---

### 2. 미회신 판단 (checkUnreachableSubjects)

**트리거 횟수:**
- 매일 12:00 실행 = **30회/월**

**함수 실행 시간:**
- 보호 대상 10,000명 조회: 약 1초
- 각 보호 대상 응답 확인 (4회 쿼리): 약 0.1초 × 10,000 = 1,000초
- 총 실행 시간: 약 **1,001초 (약 16.7분)**

**메모리 사용량:**
- 기본 메모리: 256MB (0.256 GB)

**GB-초 계산:**
- 1회 실행: 0.256 GB × 1,001초 = 256.256 GB-초
- 월 총량: 30회 × 256.256 = **7,687.68 GB-초**

---

## 총 사용량

### Cloud Functions
- 응답 알림: 460,800 GB-초
- 미회신 판단: 7,687.68 GB-초
- **총 GB-초: 468,487.68 GB-초**

### 무료 할당량
- **월 400,000 GB-초 무료**

### 초과분
- 468,487.68 - 400,000 = **68,487.68 GB-초 초과**

---

## 비용 계산

### Cloud Functions 과금 (초과분)
- GB-초당: $0.0000025 (미국 동부 기준)
- 초과분 비용: 68,487.68 × $0.0000025 = **$0.1712/월**

**한화 환산 (1 USD = 1,300원 기준):**
- **약 223원/월**

---

### Cloud Scheduler
- 무료 할당량: 월 3개 작업
- 사용량: 1개 작업 (미회신 판단)
- **비용: 무료**

---

### FCM (Firebase Cloud Messaging)
- **무제한 무료**

---

### Firestore
- 읽기: 응답 알림 시 보호자 토큰 조회 등
- 쓰기: 알림 요청 생성 등
- 무료 할당량: 읽기 50,000/일, 쓰기 20,000/일

**예상 사용량:**
- 읽기: 약 900,000회/월 (보호자 토큰 조회)
- 쓰기: 약 900,000회/월 (알림 요청 생성)

**무료 할당량:**
- 읽기: 50,000 × 30 = 1,500,000/월 무료
- 쓰기: 20,000 × 30 = 600,000/월 무료

**초과분:**
- 읽기: 무료 할당량 내 (900,000 < 1,500,000)
- 쓰기: 900,000 - 600,000 = 300,000 초과

**비용:**
- 쓰기 초과분: 300,000 × $0.00018 = **$54/월**
- **한화 환산: 약 70,200원/월**

---

## 총 비용 예상

| 항목 | 월 비용 (USD) | 월 비용 (KRW) |
|------|--------------|--------------|
| Cloud Functions | $0.17 | 223원 |
| Cloud Scheduler | 무료 | 0원 |
| FCM | 무료 | 0원 |
| Firestore (쓰기 초과) | $54.00 | 70,200원 |
| **총계** | **$54.17** | **약 70,423원** |

---

## 비용 최적화 방안

### 1. Firestore 쓰기 최적화 (가장 중요)

**현재 문제:**
- 응답할 때마다 `notification_requests` 문서 생성 (900,000회/월)
- Firestore 쓰기 초과로 인한 비용 발생

**최적화 방안:**

#### 방안 A: 배치 처리
- 여러 알림을 하나의 문서에 모아서 처리
- 또는 Cloud Functions에서 직접 FCM 발송 (알림 요청 문서 생성 안 함)

#### 방안 B: Cloud Functions에서 직접 처리
- `notification_requests` 컬렉션 사용 안 함
- 응답 저장 시 Firestore 트리거로 바로 알림 발송

**예상 절감:**
- Firestore 쓰기: 900,000회 → 0회
- **월 비용: $54 → $0.17 (약 99.7% 절감)**

---

### 2. Cloud Functions 실행 시간 최적화

**현재 문제:**
- 미회신 판단 함수가 순차적으로 실행되어 느림 (16.7분)

**최적화 방안:**
- 병렬 처리 (Promise.all 사용)
- 또는 보호 대상 수가 많으면 배치로 나누어 처리

**예상 절감:**
- 실행 시간: 16.7분 → 약 1-2분
- GB-초: 7,687 → 약 460
- **월 비용: $0.17 → $0.01 (약 94% 절감)**

---

## 최적화 후 총 비용

| 항목 | 최적화 전 | 최적화 후 |
|------|----------|----------|
| Cloud Functions | $0.17 | $0.01 |
| Firestore | $54.00 | $0.00 |
| **총계** | **$54.17** | **$0.01** |

**한화 환산:**
- 최적화 전: 약 70,423원/월
- 최적화 후: 약 13원/월

---

## 결론

### 현재 구조 (최적화 전)
- **월 비용: 약 70,423원**
- 주요 비용: Firestore 쓰기 ($54/월)

### 최적화 후
- **월 비용: 약 13원**
- 거의 무료 수준

### 권장 사항
1. **Firestore 쓰기 최적화 필수** (가장 중요)
2. Cloud Functions 실행 시간 최적화 (선택)
3. 비용 모니터링 설정 (Firebase Console)

---

## 다음 단계

최적화된 코드로 수정할까요?
1. Firestore 트리거로 직접 알림 발송 (notification_requests 제거)
2. 병렬 처리로 실행 시간 단축
