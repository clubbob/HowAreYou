# 보호자 알림 확인 방법

보호대상자가 상태를 알려줬을 때 보호자에게 알림이 제대로 전송되었는지 확인하는 방법입니다.

## 1. Firebase Console에서 확인 (가장 확실한 방법)

### 1.1 Firestore 데이터 확인

1. **Firebase Console 열기**
   - 브라우저에서 https://console.firebase.google.com 접속
   - 프로젝트 `howareyou-1c5de` 선택

2. **응답 데이터 확인**
   - 왼쪽 메뉴: **Firestore Database** 클릭
   - `subjects` 컬렉션 → 보호대상자 UID 클릭
   - `prompts` 서브컬렉션 확인
   - 오늘 날짜의 문서가 생성되었는지 확인 (예: `2026-01-27_morning`)

3. **보호자 연결 확인**
   - `subjects/{subjectId}` 문서에서 `pairedGuardianUids` 배열 확인
   - 보호자 UID가 포함되어 있는지 확인

4. **보호자 FCM 토큰 확인**
   - `users` 컬렉션 → 보호자 UID 클릭
   - `fcmTokens` 배열에 토큰이 있는지 확인
   - 토큰이 없으면 알림을 받을 수 없습니다!

### 1.2 Cloud Functions 로그 확인

1. **Functions 로그 보기**
   - Firebase Console 왼쪽 메뉴: **Functions** 클릭
   - **Logs** 탭 클릭
   - 최근 로그에서 `onResponseCreated` 함수 실행 확인

2. **로그에서 확인할 내용**
   ```
   {보호대상자 이름}님 응답 알림: {성공 개수}개 성공, {실패 개수}개 실패
   ```
   - 성공 개수가 0이면 알림이 전송되지 않은 것
   - "보호자 FCM 토큰이 없습니다" 메시지가 있으면 토큰 문제

3. **오류 확인**
   - 빨간색 오류 로그가 있는지 확인
   - "응답 알림 발송 오류:" 메시지 확인

## 2. Android Studio에서 확인

### 2.1 Logcat에서 확인

1. **Logcat 열기**
   - Android Studio 하단의 **Logcat** 탭 클릭
   - 필터: `flutter` 또는 `FCM` 입력

2. **확인할 로그**
   - FCM 토큰 등록 로그: `FCM 토큰 등록됨: ...`
   - 알림 수신 로그: `FCM 메시지 수신: ...`

### 2.2 실제 기기에서 확인

1. **보호자 기기 확인**
   - 보호자 모드로 로그인한 기기 확인
   - 알림 권한이 허용되어 있는지 확인
   - 알림 센터에서 알림 확인

2. **알림 내용 확인**
   - 제목: "상태 확인 알림"
   - 내용: "{보호대상자 이름}님이 {아침/점심/저녁} 상태를 확인했습니다"
   - 소리: 알림 소리가 들려야 함

## 3. 문제 해결 체크리스트

### 알림이 오지 않을 때

- [ ] **보호자가 등록되어 있는가?**
  - Firestore → `subjects/{subjectId}` → `pairedGuardianUids` 확인

- [ ] **보호자 FCM 토큰이 있는가?**
  - Firestore → `users/{guardianUid}` → `fcmTokens` 배열 확인
  - 토큰이 없으면 보호자 앱을 다시 실행하여 토큰 등록

- [ ] **Cloud Functions가 배포되었는가?**
  - Firebase Console → Functions → 함수 목록에서 `onResponseCreated` 확인
  - 배포되지 않았다면: `firebase deploy --only functions`

- [ ] **Functions 로그에 오류가 있는가?**
  - Firebase Console → Functions → Logs 확인
  - 오류 메시지 확인 및 해결

- [ ] **보호자 앱에서 알림 권한이 허용되었는가?**
  - 기기 설정 → 앱 → 알림 권한 확인

- [ ] **응답이 실제로 저장되었는가?**
  - Firestore → `subjects/{subjectId}/prompts` 확인
  - 오늘 날짜의 문서가 생성되었는지 확인

## 4. 빠른 확인 명령어 (터미널)

### Firestore 데이터 확인
```bash
# Firebase CLI로 데이터 확인 (선택사항)
firebase firestore:get subjects/{subjectId}/prompts/{dateSlot}
```

### Functions 로그 확인
```bash
# 최근 Functions 로그 확인
firebase functions:log --only onResponseCreated --limit 10
```

## 5. 테스트 시나리오

1. **보호대상자 앱에서 상태 확인**
   - 보호대상자 모드로 로그인
   - "상태 알려주기" 버튼 클릭
   - 기분 선택 및 저장

2. **Firestore 확인**
   - `subjects/{subjectId}/prompts/{오늘날짜_시간대}` 문서 생성 확인

3. **Functions 로그 확인**
   - Firebase Console → Functions → Logs
   - `onResponseCreated` 실행 로그 확인

4. **보호자 기기 확인**
   - 보호자 기기에서 알림 수신 확인
   - 알림 내용 및 소리 확인

## 참고

- Cloud Functions는 Firestore 트리거로 자동 실행됩니다
- 알림은 보호대상자가 응답을 저장한 직후 자동으로 발송됩니다
- 로그는 Firebase Console에서 실시간으로 확인할 수 있습니다
