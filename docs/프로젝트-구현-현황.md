# 지금 어때? (HowAreYou) - 프로젝트 구현 현황

## 📋 프로젝트 개요

**서비스명**: 지금 어때? (How Are You?)  
**목적**: 하루 3번(아침/점심/저녁) 사용자의 상태를 간단히 확인하고, 완전 무응답 상태가 일정 기간 지속될 경우 보호자에게 알림을 발송하는 Flutter 앱

**핵심 원칙**:
- 감시하지 않는다
- 판단하지 않는다
- 사용 내역은 시스템에만 저장되고, 보호자에게는 전달하지 않는다

**타겟 사용자**:
- **보호대상자(Subject)**: 아이, 어르신, 또는 혼자 지내는 사용자
- **보호자(Guardian)**: 부모, 자녀, 배우자 등 연락 담당자

---

## 🛠 기술 스택

### 프론트엔드
- **Flutter**: 크로스 플랫폼 앱 개발 (Android/iOS)
- **상태 관리**: Provider 패턴
- **UI 라이브러리**: Material Design 3

### 백엔드 & 인프라
- **Firebase Authentication**: 전화번호 OTP 인증
- **Cloud Firestore**: NoSQL 데이터베이스
- **Firebase Cloud Messaging (FCM)**: 푸시 알림
- **Firebase Cloud Functions**: 서버리스 백엔드 로직
- **Cloud Scheduler**: 주기적 작업 실행 (미회신 판단)

### 주요 패키지
```yaml
dependencies:
  firebase_core: ^3.6.0
  firebase_auth: ^5.3.1
  cloud_firestore: ^5.4.4
  firebase_messaging: ^15.1.3
  flutter_local_notifications: ^18.0.1
  provider: ^6.1.2
  intl: ^0.19.0
  timezone: ^0.9.4
  shared_preferences: ^2.2.2
  fl_chart: ^0.69.0
```

---

## ✨ 주요 기능

### 1. 역할 선택 시스템
- 앱 실행 시 "보호대상자 모드" 또는 "보호자 모드" 선택
- 마지막 선택 모드 자동 저장 및 복원
- 한 사용자가 두 역할 모두 수행 가능

### 2. 보호대상자 기능

#### 일일 상태 확인 알림
- 매일 3회 로컬 알림 발송
  - 아침: 08:00
  - 점심: 12:00
  - 저녁: 18:00
- 알림 클릭 시 질문 화면으로 이동

#### 상태 응답
- 질문: "지금 어때?"
- 3가지 기분 선택:
  - 😊 좋아 (초록색)
  - 😐 보통 (주황색)
  - 😞 안좋아 (빨간색)
- 아이콘 선택 시 즉시 응답 완료
- 응답 완료 후 "고마워요." 메시지 표시

#### 보호자 지정
- 전화번호로 보호자 검색 및 추가
- 보호자 이름 커스터마이징 가능
- 여러 보호자 지정 가능

#### 내 상태 보기
- 오늘의 상태 (아침/점심/저녁) 한눈에 확인
- 최근 7일 추이 차트 (fl_chart 사용)
- 최근 7일 이력 테이블

### 3. 보호자 기능

#### 보호 대상 확인
- 보호 대상자 목록 표시
- 각 보호 대상자의 오늘 상태 확인
- 최근 7일 추이 및 이력 확인

#### 알림 수신
- **응답 알림**: 보호 대상자가 상태를 확인했을 때
  - 예: "OO님이 아침 상태를 확인했습니다"
  - 소리 ON (Android 채널: `guardian_notifications`)
- **미회신 알림**: 연속 미응답 시
  - 조건: 어제 3회 모두 미응답 + 오늘 아침 미응답
  - 예: "OO님이 상태를 확인하지 않고 있습니다"
  - 매일 12:00에 Cloud Functions에서 자동 판단

---

## 📱 화면 구조

### 화면 목록

1. **SplashScreen** (`splash_screen.dart`)
   - 앱 시작 화면
   - 인증 상태 확인 후 자동 라우팅

2. **AuthScreen** (`auth_screen.dart`)
   - 전화번호 OTP 로그인
   - Firebase Auth 연동

3. **HomeScreen** (`home_screen.dart`)
   - 역할 선택 화면
   - "보호대상자 모드" / "보호자 모드" 버튼
   - 마지막 선택 모드 자동 복원 옵션

4. **SubjectModeScreen** (`subject_mode_screen.dart`)
   - 보호대상자 메인 화면
   - "상태 알려주기" 버튼
   - "보호자 지정" 버튼
   - "내 상태 보기" 버튼

5. **QuestionScreen** (`question_screen.dart`)
   - 상태 응답 화면
   - 기분 선택 (3가지)
   - 응답 저장 및 완료 처리

6. **GuardianScreen** (`guardian_screen.dart`)
   - 보호자 추가/관리 화면
   - 전화번호 검색
   - 보호자 이름 설정

7. **SubjectMyStatusScreen** (`subject_my_status_screen.dart`)
   - 보호대상자 자신의 상태 이력 화면
   - 오늘 상태 위젯
   - 7일 추이 차트
   - 7일 이력 테이블

8. **GuardianModeScreen** (`guardian_mode_screen.dart`)
   - 보호자 메인 화면
   - "보호 대상 확인" 버튼

9. **GuardianDashboardScreen** (`guardian_dashboard_screen.dart`)
   - 보호 대상자 목록 화면
   - 각 보호 대상자 카드 표시

10. **SubjectDetailScreen** (`subject_detail_screen.dart`)
    - 보호 대상자 상세 상태 화면
    - 오늘 상태 위젯
    - 7일 추이 차트
    - 7일 이력 테이블

11. **NoResponseScreen** (`no_response_screen.dart`)
    - 미응답 안내 화면
    - 보호자가 미응답 알림 클릭 시 표시

### 공통 위젯

- **TodayStatusWidget** (`widgets/status_display_widgets.dart`)
  - 오늘의 상태 (아침/점심/저녁) 표시
  - 색상 코딩된 배경과 이모지

- **StatusTrendChart** (`widgets/status_display_widgets.dart`)
  - 최근 7일 추이 막대 차트
  - 시간대별 색상 구분

- **StatusHistoryTable** (`widgets/status_display_widgets.dart`)
  - 최근 7일 이력 테이블
  - 날짜, 시간대, 기분 표시

---

## 🗄 데이터 모델

### Firestore 컬렉션 구조

#### `/users/{uid}`
```dart
{
  phone: string,              // 전화번호
  displayName: string?,       // 표시 이름
  fcmTokens: string[],       // FCM 토큰 배열 (다중 기기 지원)
  createdAt: Timestamp,
  updatedAt: Timestamp
}
```

#### `/subjects/{subjectId}`
```dart
{
  displayName: string,                    // 보호 대상자 이름
  pairedGuardianUids: string[],           // 연결된 보호자 UID 배열
  createdAt: Timestamp,
  updatedAt: Timestamp
}
```

#### `/subjects/{subjectId}/prompts/{YYYY-MM-DD_slot}`
```dart
{
  slot: 'morning' | 'noon' | 'evening',   // 시간대
  answeredAt: Timestamp,                  // 응답 시각
  mood: 1 | 2 | 3,                        // 1=좋아, 2=보통, 3=안좋아
  note: string?                           // 메모 (현재 미사용)
}
```

### Dart 모델 클래스

#### `Mood` enum
```dart
enum Mood {
  good(emoji: '😊', label: '좋아', value: 1, color: Colors.green),
  normal(emoji: '😐', label: '보통', value: 2, color: Colors.orange),
  bad(emoji: '😞', label: '안좋아', value: 3, color: Colors.red);
}
```

#### `TimeSlot` enum
```dart
enum TimeSlot {
  morning('morning', '아침', '08:00'),
  noon('noon', '점심', '12:00'),
  evening('evening', '저녁', '18:00');
}
```

#### `MoodResponseModel`
```dart
class MoodResponseModel {
  final String subjectId;
  final String dateSlot;        // YYYY-MM-DD_slot 형식
  final TimeSlot slot;
  final DateTime answeredAt;
  final Mood mood;
  final String? note;
}
```

---

## 🔧 서비스 구조

### 주요 서비스 클래스

#### `AuthService` (`services/auth_service.dart`)
- Firebase Authentication 관리
- 전화번호 OTP 로그인
- 사용자 데이터 로드
- 로그아웃 처리
- `Provider`로 전역 상태 관리

#### `MoodService` (`services/mood_service.dart`)
- 기분 응답 저장 (`saveMoodResponse`)
- 오늘 응답 조회 (`getTodayResponses`)
- 최근 7일 응답 조회 (`getLast7DaysResponses`)
- 한국 시간대(Asia/Seoul) 처리

#### `NotificationService` (`services/notification_service.dart`)
- 로컬 알림 초기화 및 권한 요청
- 일일 알림 스케줄링 (아침/점심/저녁)
- 알림 클릭 처리 및 화면 라우팅
- Android 알림 채널 관리
  - `daily_notifications`: 일일 상태 확인 알림
  - `guardian_notifications`: 보호자 알림 (소리 ON)

#### `FCMService` (`services/fcm_service.dart`)
- FCM 토큰 등록 및 갱신
- 백그라운드 메시지 처리
- 포그라운드 메시지 처리

#### `GuardianService` (`services/guardian_service.dart`)
- 보호자 검색 (전화번호 기반)
- 보호자 추가/제거
- 보호 대상자-보호자 연결 관리

#### `ModeService` (`services/mode_service.dart`)
- 역할 선택 모드 저장/로드 (`shared_preferences` 사용)
- 마지막 선택 모드 복원

---

## ☁️ Firebase Cloud Functions

### 함수 목록

#### `onResponseCreated` (Firestore Trigger)
- **트리거**: `subjects/{subjectId}/prompts/{promptId}` 문서 생성 시
- **기능**: 보호 대상자가 상태를 응답했을 때 보호자에게 알림 발송
- **알림 내용**: "OO님이 [아침/점심/저녁] 상태를 확인했습니다"
- **최적화**: `notification_requests` 컬렉션 제거, 직접 알림 발송

#### `checkUnreachableSubjects` (Cloud Scheduler)
- **스케줄**: 매일 12:00 (한국 시간)
- **기능**: 미회신 조건 판단 및 알림 발송
- **미회신 조건**:
  - 어제(Day 1): 아침/점심/저녁 모두 미응답
  - 오늘(Day 2): 아침 미응답
- **알림 내용**: "OO님이 상태를 확인하지 않고 있습니다"
- **최적화**: 병렬 처리로 실행 시간 단축

### 비용 최적화
- `notification_requests` 컬렉션 제거 (Firestore 읽기/쓰기 비용 절감)
- Firestore 트리거를 통한 직접 알림 발송
- 병렬 처리로 Cloud Functions 실행 시간 단축

---

## 🎨 UI/UX 특징

### 디자인 원칙
- **명확한 역할 구분**: 보호대상자/보호자 모드 분리
- **일관된 UI**: 공통 위젯으로 상태 표시 통일
- **직관적인 네비게이션**: 명확한 뒤로 가기 버튼 ("← 뒤로")
- **색상 코딩**: 기분별 색상으로 시각적 구분
  - 좋아: 초록색
  - 보통: 주황색
  - 안좋아: 빨간색

### 주요 UI 컴포넌트
- **뒤로 가기 버튼**: 모든 화면에서 통일된 스타일
  - 아이콘: `arrow_back_ios_new` (18px)
  - 텍스트: "뒤로" (16px)
  - 패딩: `horizontal: 12, vertical: 8`
- **상태 아이콘**: 원형 배경에 이모지 표시
  - `buildColoredIcon()`: 상태 페이지용 (32px)
  - `buildLargeIcon()`: 선택 화면용 (52px)

---

## 📊 현재 구현 상태

### ✅ 완료된 기능

1. **인증 시스템**
   - 전화번호 OTP 로그인
   - 사용자 데이터 관리

2. **역할 선택 시스템**
   - 보호대상자/보호자 모드 선택
   - 마지막 선택 모드 저장/복원

3. **보호대상자 기능**
   - 일일 상태 확인 알림 (로컬 알림)
   - 상태 응답 (3가지 기분 선택)
   - 보호자 지정/관리
   - 내 상태 보기 (오늘 상태, 7일 추이, 7일 이력)

4. **보호자 기능**
   - 보호 대상자 목록 확인
   - 보호 대상자 상세 상태 확인
   - 응답 알림 수신
   - 미회신 알림 수신

5. **백엔드 로직**
   - 응답 시 보호자 알림 발송 (Cloud Functions)
   - 미회신 판단 및 알림 발송 (Cloud Scheduler)

6. **UI/UX 개선**
   - 공통 위젯으로 UI 통일
   - 색상 코딩된 기분 아이콘
   - 명확한 뒤로 가기 버튼

### ⚠️ 제한 사항

1. **PRD와의 차이점**
   - PRD: 5가지 기분 (😊 좋아, 🙂 괜찮아, 😐 보통, 🙁 별로, 😞 힘들어)
   - 현재 구현: 3가지 기분 (😊 좋아, 😐 보통, 😞 안좋아)
   - 이유: UI 단순화 및 사용자 경험 개선

2. **미사용 기능**
   - `note` 필드: 현재 저장되지만 UI에서 입력 불가
   - `NotificationRequestService`: 비용 최적화로 제거됨

### 🔄 향후 개선 가능 사항

1. **기능 추가**
   - 알림 설정 화면 (무음 모드)
   - 보호자 이름 편집
   - 통계 및 분석 기능

2. **성능 최적화**
   - Firestore 쿼리 최적화
   - 이미지 캐싱
   - 오프라인 지원

3. **테스트**
   - 단위 테스트
   - 통합 테스트
   - E2E 테스트

---

## 📁 프로젝트 구조

```
lib/
├── main.dart                          # 앱 진입점
├── models/
│   ├── mood_response_model.dart      # 기분 응답 모델
│   └── user_model.dart               # 사용자 모델
├── screens/
│   ├── splash_screen.dart            # 스플래시 화면
│   ├── auth_screen.dart              # 로그인 화면
│   ├── home_screen.dart              # 역할 선택 화면
│   ├── subject_mode_screen.dart      # 보호대상자 메인 화면
│   ├── question_screen.dart          # 상태 응답 화면
│   ├── guardian_screen.dart          # 보호자 지정 화면
│   ├── subject_my_status_screen.dart  # 내 상태 보기 화면
│   ├── guardian_mode_screen.dart     # 보호자 메인 화면
│   ├── guardian_dashboard_screen.dart # 보호 대상자 목록 화면
│   ├── subject_detail_screen.dart    # 보호 대상자 상세 화면
│   └── no_response_screen.dart       # 미응답 안내 화면
├── services/
│   ├── auth_service.dart             # 인증 서비스
│   ├── mood_service.dart             # 기분 응답 서비스
│   ├── notification_service.dart     # 로컬 알림 서비스
│   ├── fcm_service.dart              # FCM 서비스
│   ├── guardian_service.dart         # 보호자 관리 서비스
│   ├── mode_service.dart             # 역할 모드 서비스
│   └── notification_request_service.dart # (미사용)
├── widgets/
│   ├── app_logo.dart                 # 앱 로고 (현재 미사용)
│   └── status_display_widgets.dart  # 상태 표시 공통 위젯
└── utils/
    ├── button_styles.dart            # 버튼 스타일 유틸리티
    └── constants.dart                # 상수 정의

functions/
└── index.js                          # Cloud Functions 코드
```

---

## 🚀 실행 방법

### 필수 요구사항
- Flutter SDK (3.0.0 이상)
- Firebase 프로젝트 설정 완료
- Android Studio / Xcode (에뮬레이터/시뮬레이터)

### 실행 명령어

```bash
# 의존성 설치
flutter pub get

# Android 실행 (EGL 로그 제외)
.\run-android.ps1  # PowerShell
# 또는
flutter run --verbose 2>&1 | Select-String -Pattern "!EGL_emulation"
```

### Firebase 배포

```bash
# Cloud Functions 배포
cd functions
npm install
cd ..
firebase deploy --only functions
```

---

## 📝 참고 문서

- `HowAreYou_PRD_v1.0.md`: 프로젝트 요구사항 정의서
- `docs/개발-검토-결과.md`: 개발 검토 결과
- `docs/역할-구분-방안.md`: 역할 구분 방안 분석
- `docs/알림-확인-방법.md`: 알림 확인 방법 가이드
- `docs/Cloud-Functions-비용-분석.md`: 비용 분석 문서

---

## 💡 주요 설계 결정

1. **역할 선택 방식**: 자동 감지 대신 사용자 선택 방식 채택
   - 이유: 구현 단순성, 유연성, 사용자 제어

2. **기분 선택 단순화**: 5가지 → 3가지로 축소
   - 이유: UI 단순화, 사용자 경험 개선

3. **비용 최적화**: `notification_requests` 컬렉션 제거
   - 이유: Firestore 읽기/쓰기 비용 절감

4. **공통 위젯 사용**: 상태 표시 UI 통일
   - 이유: 코드 재사용, 일관된 UX

5. **로고 제거**: 화면 제목으로 대체
   - 이유: 기능 중심 UI, 명확한 네비게이션

---

## 📞 문의 및 지원

프로젝트 관련 문의사항이나 버그 리포트는 이슈 트래커를 통해 제출해주세요.

---

**최종 업데이트**: 2026-01-27
