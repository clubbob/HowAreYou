# 보호자·보호대상자 등록 및 Firestore 규칙 정리

## 1. 데이터 모델 (PRD §9)

- **users/{userId}**: 문서 ID = Firebase Auth UID. 본인만 읽기/쓰기.
- **subjects/{subjectUid}**: 문서 ID = 보호대상자 Auth UID (별도 식별자 없음).  
  - `displayName`, `pairedGuardianUids[]`, `guardianInfos{uid: {phone, displayName}}`, `phone` 등.
- **subjects/{subjectUid}/prompts/{promptId}**: 일일 상태 응답. 보호대상자 읽기/쓰기, 보호자 읽기만.

---

## 2. 등록 흐름 요약

### 2.1 보호자 → 보호대상자 추가 (보호자 앱에서 “내가 케어할 사람” 추가)

| 단계 | 위치 | 동작 |
|------|------|------|
| 1 | GuardianDashboardScreen | 보호대상자 전화번호 입력 후 추가 요청 |
| 2 | GuardianService.addMeAsGuardianToSubject | `users` 컬렉션에서 전화번호로 사용자 조회 → uid = subjectUid |
| 3 | 동일 | `subjects/{subjectUid}` get (기존 문서 확인) |
| 4 | 동일 | 본인(subjectUid == guardianUid)이면 예외 (프로덕션) |
| 5 | 동일 | 문서 있으면 **update**, 없으면 **set**: `pairedGuardianUids`, `guardianInfos`, 필요 시 `displayName`, `phone` |

**규칙 적용**

- **읽기**: `request.auth.uid != subjectUid` 로 “본인이 아닌 인증 사용자”가 기존 문서 읽기 가능.
- **쓰기**: `canAddSelfAsGuardian()` + **affectedKeys**가 다음만 허용:  
  `['pairedGuardianUids', 'guardianInfos']` 또는 `displayName`/`phone` 포함 조합.  
  새 문서(`!resource.exists`)면 위 필드들로 set 허용.

### 2.2 보호대상자 → 보호자 추가 (보호대상자 앱에서 “나를 케어할 보호자” 추가)

| 단계 | 위치 | 동작 |
|------|------|------|
| 1 | GuardianScreen | 보호자 이름·전화번호 입력 후 추가 |
| 2 | GuardianService.getUserByPhone (또는 기존 조회) | 전화번호로 `users` 조회 → 보호자 uid |
| 3 | GuardianScreen | 본인 uid == 보호자 uid 이면 차단 (프로덕션) |
| 4 | GuardianScreen | `subjects/{userId}` get (본인 문서) → 기존 pairedGuardianUids·guardianInfos 읽기 |
| 5 | GuardianScreen | **update** 또는 **set**: `displayName`, `pairedGuardianUids`, `guardianInfos` |

**규칙 적용**

- **읽기/쓰기**: `isSubject()` (즉 `request.auth.uid == subjectUid`) 로 **보호대상자 본인**이 자신의 `subjects` 문서 전체 읽기·쓰기 가능.  
  따라서 추가·수정·삭제·이름 수정(merge set) 모두 허용.

### 2.3 보호대상자 측 보호자 수정·삭제

- **이름 수정** (_showSetNameDialog): `subjects/{userId}.set({ guardianInfos }, merge: true)` → 본인 문서이므로 `isSubject()` 로 허용.
- **삭제**: `update` with `FieldValue.arrayRemove([uid])`, `guardianInfos.$uid` delete → 역시 본인 문서이므로 허용.

---

## 3. Firestore 규칙와 코드 일치 요약

| 대상 | 규칙 | 코드 측 동작 |
|------|------|----------------|
| subjects 읽기 (본인) | `isSubject()` | 보호대상자 본인이 자신 문서 get/snapshots |
| subjects 읽기 (보호자) | `isGuardian()` / `auth.uid != subjectUid` | 보호자가 대상자 문서 get 후 update/set |
| subjects 쓰기 (본인) | `isSubject()` | GuardianScreen의 추가/수정/삭제/merge set |
| subjects 쓰기 (보호자) | `canAddSelfAsGuardian()` + affectedKeys | GuardianService.addMeAsGuardianToSubject 의 update/set 필드만 사용 |
| prompts 읽기 (보호자) | 부모 문서 `get().data.get('pairedGuardianUids', [])` 에 uid 포함 | 보호자 대시보드 등에서 prompts 조회 |

- **prompts** 읽기 규칙: `pairedGuardianUids` 필드가 없을 수 있으므로 `.data.get('pairedGuardianUids', [])` 로 null 안전 처리됨.

---

## 4. 배포 및 검증

- 규칙 배포:  
  `firebase deploy --only firestore:rules`
- 등록 검증:
  1. **보호자 앱**: 보호대상자 전화번호로 “내가 케어할 사람” 추가 → 해당 사용자 `subjects` 문서에 본인 uid가 `pairedGuardianUids`·`guardianInfos`에 들어가는지 확인.
  2. **보호대상자 앱**: 보호자 전화번호로 “나를 케어할 보호자” 추가 → 본인 `subjects` 문서에 보호자 uid·guardianInfos 추가·수정·삭제가 되는지 확인.

---

## 5. 코드 정리 사항 (반영됨)

- **GuardianScreen**: 전화번호 조회를 `GuardianService.getUserByPhone`, E.164는 `GuardianService.toE164` 사용. 컬렉션명은 `AppConstants.subjectsCollection` 사용.
- **GuardianService**: `getUserByPhone(String)`, `toE164(String)` static 공개로 보호대상자/보호자 양쪽에서 재사용.

이 문서는 보호자·보호대상자 등록 흐름과 Firestore 규칙이 1:1로 맞도록 정리한 요약입니다.
