# PRD 기준 앱 변경 단계 및 수정 범위

**기준 문서**: HowAreYou_PRD_v1.0.md (데이터 모델 §9 고정 조건 포함)  
**SPEC**: JIGUM_EOTTAE_FULL_REBUILD_SPEC_v1.0.1.md

현재 앱은 이미 **subjectUid = 보호대상자 Auth UID**, **users/{uid} = Auth UID** 로 동작 중입니다.  
아래는 “PRD/데이터 모델을 명시적으로 맞추고, 불필요한 분기를 정리”하는 단계 제안입니다.

---

## 1. 검증 (이미 충족 여부 확인)

| 항목 | 내용 | 현재 상태 |
|------|------|-----------|
| DM-1 | subjects 문서 ID = 보호대상자 Auth UID | ✅ GuardianService.addMeAsGuardianToSubject, MoodService 등에서 subjectId = users 쿼리 결과 doc.id 사용 |
| DM-2 | users 문서 ID = Auth UID | ✅ AuthService._ensureUserDocument(uid, phone) 에서 users.doc(uid) 사용 |
| DM-3 | subject 전용 식별자 미사용 | ✅ 별도 ID 생성 없음, subjectUid = uid 로 통일 |

→ **데이터 모델 고정 조건은 이미 만족.** 코드 상에서 “subjectId”/“subjectUid” 네이밍만 PRD와 통일하면 됨.

---

## 2. 변경 단계 제안

### 2단계: 문서·주석 정리 (낮은 위험)

- **목적**: PRD §9·§10과 용어 일치.
- **작업**:
  - 코드·주석에서 `subjectId` 표현 시 “보호대상자 Auth UID와 동일” 명시.
  - Firestore 경로 주석: `subjects/{subjectUid}`, `subjectUid === users.uid` 등으로 통일.
- **범위**: GuardianService, MoodService, guardian_screen, guardian_dashboard_screen, subject_detail_screen, firestore.rules 주석 등.
- **산출**: PRD 데이터 모델과 1:1 대응된다는 확인.

### 2단계: 서비스·화면 역할 정리 (중간 위험)

- **목적**: Guardian / Mood / 조회가 “subjectUid = Auth UID” 전제만 사용하도록 명확화.
- **작업**:
  - Guardian: “보호대상자 추가” 시 users 쿼리로 얻은 uid만 사용해 subjects 문서 참조하는지 검토, 필요 시 분기 제거.
  - Mood: 응답 저장/조회가 항상 `subjects/{현재 사용자 uid}/prompts` 또는 `subjects/{선택된 보호대상자 uid}/prompts` 만 사용하는지 확인.
  - 조회: 보호자 대시보드 등에서 subject 목록·상세가 “subjects 문서 ID = 해당 유저 uid” 전제로만 동작하는지 확인.
- **범위**: lib/services (guardian_service, mood_service), lib/screens (guardian_dashboard, subject_detail, subject_my_status).
- **산출**: 데이터 모델 전제 위반 경로 제거 또는 주석으로 “PRD §9 준수” 표시.

### 3단계: Firestore 규칙·인덱스 점검 (낮은 위험)

- **목적**: PRD §9·§10 구조와 규칙 일치.
- **작업**:
  - firestore.rules 에서 `subjects/{subjectUid}`, `users/{userId}` 설명을 PRD §9와 동일하게 정리.
  - subjects/prompts 읽기 조건이 “subjectUid = 보호대상자 uid” 전제인지 확인.
  - 필요한 복합 인덱스만 firestore.indexes.json 에 유지.
- **범위**: firestore.rules, firestore.indexes.json.
- **산출**: 규칙 배포 후 기존 시나리오(보호자 추가, 응답 저장, 보호자 조회) 재테스트.

### 4단계 (선택): PRD와 충돌 구간 제거

- **목적**: PRD/SPEC에 없는 기능은 제거하거나 “실험/비공식” 표시.
- **작업**:
  - PRD §11 비범위(지정자 대시보드 등)와 현재 구현이 다른 경우, 제거할지 유지할지 결정 후, 유지 시 PRD 보완 또는 “예외” 명시.
  - 사용하지 않는 컬렉션/필드 참조 제거(예: alerts 사용 여부 확인).
- **범위**: 전 화면·서비스 훑어서 PRD 대조.
- **산출**: “구현 = PRD + 명시된 예외” 로 정리된 목록.

---

## 3. 수정 범위 요약

| 구분 | 수정 범위 | 목적 |
|------|-----------|------|
| 문서/주석 | GuardianService, MoodService, 관련 화면, firestore.rules | PRD §9·§10 용어·구조 반영 |
| 로직 | guardian/mood/조회 경로 | subjectUid = Auth UID 전제만 사용, 분기 정리 |
| 규칙 | firestore.rules, indexes | PRD 데이터 모델과 일치 |
| 선택 | 비범위·미사용 기능 | PRD/SPEC과 충돌 제거 또는 예외 문서화 |

---

## 4. 적용 순서 권장

1. **1단계** 적용 후, PRD §9·§10과 코드/규칙 설명이 일치하는지 검토.
2. **2단계** 적용 후, 보호자 추가·응답 저장·보호자 조회 시나리오로 회귀 테스트.
3. **3단계** 적용 후, 동일 시나리오로 규칙·인덱스 검증.
4. 필요 시 **4단계**로 PRD와 불일치 구간 정리.

이 순서대로 진행하면 “JIGUM_EOTTAE_FULL_REBUILD_SPEC + PRD 데이터 모델” 기준으로 앱을 정리할 수 있습니다.
