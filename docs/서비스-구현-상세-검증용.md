# 지금 어때 (HowAreYou) - 서비스 구현 상세 (GPT 검증용)

> 이 문서는 현재 구현된 서비스를 상세히 정리한 것으로, GPT가 로직·비즈니스·일관성 검증에 활용할 수 있도록 작성되었습니다.

---

## 1. 서비스 포지션

**"마음을 편하게 해주는 관계 습관 앱"**

- **역할**: 부모님 걱정을 줄여주는 일일 안부 확인 습관 앱
- **아님**: 3일 무응답 리스크 감지·긴급 알림 앱
- **원칙**: 리스크·고독사·사고 등 공포 유도 표현 최소화

---

## 2. 사용자 역할

| 역할 | 설명 | 주요 행동 |
|------|------|----------|
| **보호대상자 (Subject)** | 안부를 남기는 사람 (주로 부모님) | 하루 1회 컨디션 기록 |
| **보호자 (Guardian)** | 안부를 확인하는 사람 (주로 자녀) | 보호대상자 기록 확인 |

- **1인 2역 가능**: 한 사용자가 보호대상자이자 보호자일 수 있음 (예: 엄마가 멀리 사는 할머니 기록 확인)
- **1대다**: 한 보호자가 여러 보호대상자를, 한 보호대상자가 여러 보호자를 가질 수 있음

---

## 3. 인증 (Firebase Auth)

- **방식**: 전화번호 인증 (SMS OTP)
- **저장**: `users/{uid}` — phone (E.164), displayName, fcmTokens 등
- **로그인 유지**: Firebase Auth 기본 유지

---

## 4. Firestore 데이터 구조

### 4.1 users/{userId}

- 문서 ID = Firebase Auth UID
- 필드: phone, displayName, fcmTokens (배열), subjectLabels (보호자별 보호대상자 별칭)

### 4.2 subjects/{subjectUid}

- 문서 ID = 보호대상자 Auth UID
- **필수/주요 필드**:
  - `pairedGuardianUids`: string[] — 연결된 보호자 UID 목록
  - `guardianInfos`: map — { guardianUid: { phone, displayName, pairedAt } }
  - `lastResponseAt`: Timestamp — 마지막 기록 시각 (푸시 조건 쿼리용)
  - `displayName`, `phone`: 선택

- **스트릭 필드**:
  - `currentStreak`: number — 현재 연속 기록 일수
  - `longestStreak`: number — 최장 연속 기록 일수
  - `lastRecordedDate`: string — yyyy-MM-dd

- **3일 무응답 중복 방지**:
  - `lastGuardianAlertAt`: Timestamp — 마지막 3일 무응답 알림 발송 시각

### 4.3 subjects/{subjectUid}/prompts/{promptId}

- 문서 ID = `yyyy-MM-dd` (날짜 문자열)
- 필드: slot ('daily'), answeredAt, mood (1~5), note(선택)
- **보호자 공유**: mood·answeredAt만 공유, note는 제외

### 4.4 pending_guardian_invites, pending_subject_invites

- 미가입자 초대 대기. 가입 시 Cloud Function이 자동 연결 후 삭제

### 4.5 기타 컬렉션

- `waitlist`: 베타 대기 이메일
- `inquiries`: 1:1 문의
- `announcements`: 공지 (읽기만)

---

## 5. 시간 기준

- **모든 "오늘" 판단**: 한국 시간(KST, Asia/Seoul) 00:00~24:00
- **자정**: KST 기준 자정이 넘으면 새 날로 리셋

---

## 6. 푸시 알림 (FCM) — 생존 신호 기반 조건부

### 6.1 개요

- **목표**: 앱이 꺼져 있어도 OS 푸시로 수신
- **로컬 알림 19/20시**: 비활성화 (FCM으로 대체)
- **조건 쿼리**: `lastResponseAt` 기반, 전체 사용자 스캔 없음

### 6.2 스케줄 및 조건

| 시간(KST) | 대상 | 조건 | 문구 |
|-----------|------|------|------|
| **19:00** | 보호대상자 | `lastResponseAt < 오늘 00:00` | 오늘 상태를 남겨주세요. |
| **20:00** | 보호자 | 위와 동일한 subjects → pairedGuardianUids 수집 | 오늘 아직 신호가 없습니다. |
| **20:05** | 보호자 | `lastResponseAt < now - 72h` AND `lastGuardianAlertAt` 미설정 또는 72h 이전 | 3일간 신호가 없습니다. 확인이 필요합니다. |

### 6.3 Cloud Functions

| 함수명 | 트리거 | 역할 |
|--------|--------|------|
| `sendSubjectReminder` | pubsub 19:00 매일 | 당일 미기록 보호대상자에게 FCM |
| `sendGuardianReminder` | pubsub 20:00 매일 | 당일 미기록 보호대상자의 보호자에게 FCM |
| `sendThreeDayNoResponseAlert` | pubsub 20:05 매일 | 3일 무응답 시 보호자에게 FCM, `lastGuardianAlertAt` 갱신 |
| `onResponseCreated` | Firestore onCreate (prompts) | 보호대상자 기록 시 보호자에게 "기록 알림" FCM |
| `onResponseUpdated` | Firestore onUpdate (prompts) | 동일 |
| `processPendingInvitesOnSignup` | Auth user onCreate | 신규 가입 시 대기 초대 자동 연결 |
| `removeGuardianFromSubject` | https.onCall | 보호자가 자신을 보호대상자 목록에서 제거 |
| `addToWaitlist` | https.onCall | 베타 대기 이메일 등록 |
| `migrateReminderFields` | https.onRequest | 리마인드 필드 마이그레이션 (관리자 수동 호출) |

### 6.4 FCM data type → 앱 라우팅

| type | 이동 화면 |
|------|----------|
| DAILY_REMINDER | QuestionScreen (컨디션 기록) |
| GUARDIAN_REMINDER | GuardianDashboardScreen (안부 확인 탭) |
| ESCALATION_3DAYS | SubjectDetailScreen (subjectId 있으면) 또는 GuardianDashboardScreen |
| RESPONSE_RECEIVED | SubjectDetailScreen 또는 GuardianDashboardScreen |

---

## 7. 컨디션(기분) 기록

### 7.1 저장

- **제한**: 하루 1회 (KST 기준)
- **위치**: `subjects/{subjectId}/prompts/{yyyy-MM-dd}`
- **내용**: slot='daily', mood(1~5), answeredAt, note(선택)
- **선택지**: 괜찮아, 보통, 별로 (Mood.okay, normal, notGood)

### 7.2 저장 시 연쇄 처리

1. prompts 문서 생성
2. subjects 문서 업데이트:
   - `lastResponseAt` = 현재 시각
   - `lastResponseDate` = yyyy-MM-dd
   - 스트릭: 어제 기록 있으면 currentStreak+1, 없으면 1. longestStreak 갱신
3. onResponseCreated 트리거 → 보호자 FCM "기록 알림"

### 7.3 삭제

- `deleteTodayResponse`: 오늘 prompts 문서만 삭제 (subjects 스트릭/ lastResponseAt은 유지)

---

## 8. 스트릭(연속 기록)

- **currentStreak**: 연속 기록 일수 (오늘 기록 시 어제 기록 여부로 판단)
- **longestStreak**: 최장 연속 기록
- **표시**:
  - 보호대상자 메인: "🔥 N일 연속 기록 중"
  - 보호자 대시보드: "○○ N일 연속 기록 중"

---

## 9. 월간 요약

- **계산**: 해당 월 기록일수 / 해당 월 총 일수 × 100
- **표시**: 보호자 대시보드 상단 "이번 달 기록률 N%"
- **메시지**:
  - 80% 이상: "가족이 잘 연결되어 있습니다."
  - 50% 이상: "꾸준히 기록하고 계세요."
  - 1% 이상: "이번 달은 조금 여유로우셨나 봐요."

---

## 10. 보호자 대시보드

### 10.1 오늘 확인 카드

- **전원 기록 시**: "오늘 확인 완료" + "오늘 부모님은 괜찮다고 남기셨습니다. 이제 마음 놓으셔도 됩니다." + 감성 문구 (예: "오늘도 가족이 연결되어 있습니다.")
- **미기록 시**: "오늘 아직 안부가 없습니다. 간단히 확인해보세요."
- **일부 기록 시**: "오늘 일부 확인되었습니다. 남은 분도 확인해보세요."

### 10.2 보호대상자 목록 카드

- 상태: "오늘 확인 완료 ✅" / "오늘은 아직 기록이 없습니다." (공포 표현 금지)
- 마지막 기록: "마지막 기록: 오늘" / "n일 전" / "없음"
- 스트릭: "N일 연속 기록 중"

---

## 11. 초대·연결

### 11.1 초대 링크

- **보호자 → 보호대상자**: `?g=guardianUid`
- **보호대상자 → 보호자**: `?s=subjectUid`
- **베이스 URL**: https://howareyou-1c5de.web.app/invite

### 11.2 초대 메시지

- **보호자 → 보호대상자**: "엄마, 매일 전화 대신 이거 하나만 눌러줘 😊"
- **보호대상자 → 보호자**: "매일 전화 대신 3초로 확인할 수 있어요. 설치하면 안부가 잘 전달됐는지 확인할 수 있어요."

### 11.3 미가입자 초대

- 링크로 들어온 번호를 pending_guardian_invites / pending_subject_invites에 등록
- 해당 번호로 가입 시 `processPendingInvitesOnSignup`이 자동 연결

---

## 12. UI 카피 (핵심)

### 12.1 보호대상자 메인

- "오늘도 잘 지내고 계신가요?"
- "하루 한 번이면 충분합니다."
- "🔥 N일 연속 기록 중"

### 12.2 앱 설명/랜딩

- "매일 전화하지 않아도 됩니다."
- "하루 3초 기록으로 충분합니다."
- "부모님도 부담 없이 사용할 수 있습니다."

---

## 13. 금지 사항 (설계 원칙)

- 전체 사용자 매일 스캔
- 반복 루프, counter 증가 방식
- 긴급 알림, 공포 색상, 위험 강조, 카운트다운
- 리스크·고독사·사고 등 표현 과다

---

## 14. 검증 체크리스트 (GPT용)

- [ ] 19시 푸시: 당일 `lastResponseAt`이 오늘 00:00 이전인 사용자만?
- [ ] 20시 푸시: 동일 쿼리 후 pairedGuardianUids만 수집해 보호자에게 발송?
- [ ] 3일 푸시: lastResponseAt < now-72h, lastGuardianAlertAt으로 중복 방지?
- [ ] 기록 시 lastResponseAt·스트릭·lastRecordedDate 갱신?
- [ ] 보호자는 mood·answeredAt만 볼 수 있고 note는 제외?
- [ ] FCM type별 라우팅(DAILY_REMINDER, GUARDIAN_REMINDER, ESCALATION_3DAYS)이 일치?

---

*작성일: 2026-02 기준 구현 내용*
