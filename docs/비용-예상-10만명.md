# 10만명 이용자 비용 예상 (알림 조건 기준)

## 시나리오 가정

- **총 회원**: 100,000명
- **보호대상자(subject)**: 50,000명
- **보호자(guardian)**: 50,000명
- **보호대상자당 평균 보호자 수**: 1.5명
- **각 보호대상자 응답 빈도**: 하루 1회 (매일 18:00 알림 후 기록)
- **월 기준**: 30일

## 알림 조건

### 1. 보호대상자 로컬 알림
- **발송 시간**: 매일 18:00 (한국 시간)
- **발송 횟수**: 하루 1회
- **비용**: **무료** (로컬 알림, Firebase 비용 없음)

### 2. 보호자 FCM 알림
- **트리거**: 보호대상자가 컨디션을 기록했을 때
- **발송 횟수**: 보호대상자 기록 횟수 = 보호대상자 수 × 일수
- **FCM 비용**: **무료** (FCM은 무제한 무료)

---

## 월간 사용량 계산

### 1. 보호대상자 상태 기록
- **기록 횟수**: 50,000명 × 30일 = **1,500,000회/월**

### 2. Firestore 쓰기
- **prompts 문서 생성/업데이트**: 1,500,000회
- **실패 토큰 제거 시 쓰기**: 약 5% (75,000회)
- **총 쓰기**: **1,575,000회/월**

### 3. Cloud Functions 실행
- **onResponseCreated/onResponseUpdated 트리거**: 1,500,000회/월
- **함수 실행 시간**: 평균 1-2초/회 (보호자 조회 + FCM 발송)
- **메모리 사용량**: 256MB (0.256 GB)
- **GB-초 계산**: 1,500,000회 × 0.256 GB × 2초 = **768,000 GB-초/월**

### 4. Firestore 읽기 (Cloud Functions 내부)
- **subjects/{subjectId} 문서 읽기**: 1,500,000회
- **users/{guardianUid} 문서 읽기**: 1,500,000 × 1.5 = 2,250,000회
- **총 읽기**: **3,750,000회/월**

---

## Firebase 무료 할당량

### Firestore
- **읽기**: 50,000회/일 = 1,500,000회/월 무료
- **쓰기**: 20,000회/일 = 600,000회/월 무료
- **저장**: 1 GB 무료

### Cloud Functions
- **실행 횟수**: 2,000,000회/월 무료
- **GB-초**: 400,000 GB-초/월 무료
- **네트워크**: 5 GB/월 무료

### FCM
- **무제한 무료**

---

## 초과분 계산

### Firestore 읽기
- 사용량: 3,750,000회
- 무료 할당량: 1,500,000회
- **초과분: 2,250,000회**

### Firestore 쓰기
- 사용량: 1,575,000회
- 무료 할당량: 600,000회
- **초과분: 975,000회**

### Cloud Functions 실행 횟수
- 사용량: 1,500,000회
- 무료 할당량: 2,000,000회
- **초과분: 0회** (무료 할당량 내)

### Cloud Functions GB-초
- 사용량: 768,000 GB-초
- 무료 할당량: 400,000 GB-초
- **초과분: 368,000 GB-초**

---

## 비용 계산

### Firestore 읽기
- **가격**: $0.03 per 100,000 reads (표준 요금제)
- **초과분**: 2,250,000회
- **비용**: (2,250,000 / 100,000) × $0.03 = **$0.675/월**

### Firestore 쓰기
- **가격**: $0.09 per 100,000 writes (표준 요금제)
- **초과분**: 975,000회
- **비용**: (975,000 / 100,000) × $0.09 = **$0.8775/월** ≈ **$0.88/월**

### Cloud Functions GB-초
- **가격**: $0.0000025 per GB-초 (미국 동부 기준)
- **초과분**: 368,000 GB-초
- **비용**: 368,000 × $0.0000025 = **$0.92/월**

### FCM
- **비용**: 무료

---

## 총 비용 예상

| 항목 | 월 사용량 | 무료 할당량 | 초과분 | 월 비용 (USD) | 월 비용 (KRW) |
|------|----------|------------|--------|--------------|--------------|
| Firestore 읽기 | 3,750,000회 | 1,500,000회 | 2,250,000회 | $0.68 | 884원 |
| Firestore 쓰기 | 1,575,000회 | 600,000회 | 975,000회 | $0.88 | 1,144원 |
| Cloud Functions GB-초 | 768,000 | 400,000 | 368,000 | $0.92 | 1,196원 |
| Cloud Functions 실행 | 1,500,000회 | 2,000,000회 | 0회 | $0.00 | 0원 |
| FCM | 무제한 | 무제한 | - | $0.00 | 0원 |
| **총계** | - | - | - | **$2.48** | **약 3,224원** |

**환율 기준**: 1 USD = 1,300 KRW

---

## 비용 분석

### 주요 비용 항목
1. **Cloud Functions GB-초**: $0.92/월 (37.1%)
2. **Firestore 쓰기**: $0.88/월 (35.5%)
3. **Firestore 읽기**: $0.68/월 (27.4%)

### 비용 효율성
- **회원당 월 비용**: $2.48 / 100,000 = **$0.0000248** (약 **0.032원**)
- **보호대상자당 월 비용**: $2.48 / 50,000 = **$0.0000496** (약 **0.064원**)

---

## 비용 최적화 방안

### 1. Firestore 읽기 최적화
**현재 문제:**
- 각 보호자별로 `users/{guardianUid}` 문서를 개별 조회 (2,250,000회)

**최적화 방안:**
- 보호자 토큰을 `subjects/{subjectId}` 문서에 캐시하여 읽기 감소
- 또는 배치 읽기 사용

**예상 절감:**
- 읽기: 2,250,000회 → 1,500,000회 (무료 할당량 내)
- **절감액: $0.68/월**

### 2. Cloud Functions 실행 시간 최적화
**현재 문제:**
- 평균 실행 시간 2초 (병렬 처리 미흡)

**최적화 방안:**
- 보호자별 FCM 발송을 병렬 처리로 개선
- 실행 시간: 2초 → 1초로 단축

**예상 절감:**
- GB-초: 768,000 → 384,000 (무료 할당량 내)
- **절감액: $0.92/월**

### 3. Firestore 쓰기 최적화
**현재 문제:**
- 실패 토큰 제거 시 쓰기 발생 (75,000회)

**최적화 방안:**
- 토큰 제거를 배치 처리로 변경
- 또는 읽기 전용으로 변경하여 쓰기 감소

**예상 절감:**
- 쓰기: 1,575,000회 → 1,500,000회
- 초과분: 975,000회 → 900,000회
- **절감액: $0.14/월**

---

## 최적화 후 총 비용

| 항목 | 최적화 전 | 최적화 후 | 절감액 |
|------|----------|----------|--------|
| Firestore 읽기 | $0.68 | $0.00 | $0.68 |
| Firestore 쓰기 | $0.88 | $0.81 | $0.07 |
| Cloud Functions GB-초 | $0.92 | $0.00 | $0.92 |
| **총계** | **$2.48** | **$0.81** | **$1.67** |

**한화 환산:**
- 최적화 전: 약 3,224원/월
- 최적화 후: 약 1,053원/월
- **절감액: 약 2,171원/월 (67.3% 절감)**

---

## 결론

### 현재 구조 (최적화 전)
- **월 비용: 약 3,224원** ($2.48)
- **회원당 월 비용: 약 0.032원**
- 주요 비용: Cloud Functions 실행, Firestore 쓰기/읽기

### 최적화 후
- **월 비용: 약 1,053원** ($0.81)
- **회원당 월 비용: 약 0.011원**
- 거의 무료 수준 (무료 할당량 내에서 대부분 처리)

### 주요 특징
1. **FCM은 완전 무료**: 알림 발송 비용 없음
2. **비용이 매우 낮음**: 10만명 기준 월 3,224원
3. **최적화 가능**: 코드 개선으로 약 67% 비용 절감 가능
4. **Firebase 무료 할당량이 큼**: 대부분의 사용량이 무료 할당량 내

### 권장 사항
1. **Firestore 읽기 최적화** (보호자 토큰 캐싱)
2. **Cloud Functions 병렬 처리** (실행 시간 단축)
3. **비용 모니터링 설정** (Firebase Console)
4. **정기적인 비용 리뷰** (월 1회)

---

## 참고사항

- 위 비용은 **미국 동부(us-central1)** 기준입니다
- 다른 지역(아시아, 유럽)은 가격이 다를 수 있습니다
- 실제 사용량은 사용자 행동 패턴에 따라 달라질 수 있습니다
- 무료 할당량은 프로젝트당 1개 데이터베이스에만 적용됩니다
