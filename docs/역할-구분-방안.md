# ì—­í•  êµ¬ë¶„ ë°©ì•ˆ ë¶„ì„

## í•µì‹¬ ì§ˆë¬¸
**"ì•±ì´ ë³´í˜¸ ëŒ€ìƒì í•¸ë“œí°ì— ì„¤ì¹˜ë˜ëŠ”ì§€ ë³´í˜¸ì í•¸ë“œí°ì— ì„¤ì¹˜ë˜ëŠ”ì§€ ì–´ë–»ê²Œ ì•Œê¹Œ?"**

---

## ë°©ì•ˆ 1: ìë™ ê°ì§€ (ë°ì´í„° ê¸°ë°˜) â­ **ê¶Œì¥**

### ì›ë¦¬
Firestore ë°ì´í„°ë¥¼ í™•ì¸í•˜ì—¬ ì—­í• ì„ ìë™ìœ¼ë¡œ íŒë‹¨

### ë¡œì§
```dart
Future<UserRole> detectUserRole(String userId) async {
  // 1. subjects/{userId} ë¬¸ì„œ í™•ì¸
  final subjectDoc = await firestore.collection('subjects').doc(userId).get();
  final isSubject = subjectDoc.exists;
  
  // 2. ë‹¤ë¥¸ subjects ë¬¸ì„œì—ì„œ pairedGuardianUidsì— ë‚´ê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
  final guardianQuery = await firestore
    .collection('subjects')
    .where('pairedGuardianUids', arrayContains: userId)
    .limit(1)
    .get();
  final isGuardian = guardianQuery.docs.isNotEmpty;
  
  // 3. ì—­í•  ê²°ì •
  if (isSubject && isGuardian) return UserRole.both;
  if (isGuardian) return UserRole.guardian;
  return UserRole.subject; // ê¸°ë³¸ê°’
}
```

### ì¥ì 
- âœ… ì‚¬ìš©ìê°€ ë³„ë„ ì„¤ì • ë¶ˆí•„ìš”
- âœ… ìì—°ìŠ¤ëŸ¬ìš´ ì—­í•  ì „í™˜ (ë³´í˜¸ì ì¶”ê°€ ì‹œ ìë™ ê°ì§€)
- âœ… ì‹¤ì‹œê°„ ì—­í•  ë°˜ì˜
- âœ… í•˜ë‚˜ì˜ ì•±ìœ¼ë¡œ ëª¨ë“  ì—­í•  ì§€ì›

### ë‹¨ì 
- âš ï¸ ì´ˆê¸° ë¡œê·¸ì¸ ì‹œ ì•½ê°„ì˜ ì§€ì—° (ì¿¼ë¦¬ í•„ìš”)
- âš ï¸ ì—­í•  ë³€ê²½ ì‹œ UI ì—…ë°ì´íŠ¸ í•„ìš”

### êµ¬í˜„ ìœ„ì¹˜
- `AuthService._loadUserData()` ë˜ëŠ” ë³„ë„ ë©”ì„œë“œ
- í™ˆ í™”ë©´ ì§„ì… ì‹œ ì—­í•  í™•ì¸

---

## ë°©ì•ˆ 2: ì´ˆê¸° ì„¤ì • í™”ë©´ (ìˆ˜ë™ ì„ íƒ)

### ì›ë¦¬
ì²« ë¡œê·¸ì¸ ì‹œ ì‚¬ìš©ìê°€ ì—­í• ì„ ì„ íƒ

### UI íë¦„
```
ë¡œê·¸ì¸ ì„±ê³µ
  â†“
ì—­í•  ì„ íƒ í™”ë©´ (í•œ ë²ˆë§Œ í‘œì‹œ)
  - [ ] ë‚˜ëŠ” ë³´í˜¸ ëŒ€ìƒìì…ë‹ˆë‹¤ (ìƒíƒœë¥¼ ì•Œë ¤ì¤„ ì‚¬ëŒ)
  - [ ] ë‚˜ëŠ” ë³´í˜¸ìì…ë‹ˆë‹¤ (ë³´í˜¸ ëŒ€ìƒì„ í™•ì¸í•  ì‚¬ëŒ)
  - [ ] ë‘˜ ë‹¤
  â†“
ì„ íƒí•œ ì—­í• ë¡œ Firestoreì— ì €ì¥
  â†“
í™ˆ í™”ë©´ (ì—­í•  ê¸°ë°˜ UI)
```

### ì¥ì 
- âœ… ëª…í™•í•œ ì—­í•  êµ¬ë¶„
- âœ… ì‚¬ìš©ìê°€ ìì‹ ì˜ ì—­í• ì„ ì¸ì§€
- âœ… ë¹ ë¥¸ UI ê²°ì • (ì¿¼ë¦¬ ë¶ˆí•„ìš”)

### ë‹¨ì 
- âŒ ì‚¬ìš©ìê°€ í˜¼ë€ìŠ¤ëŸ¬ìš¸ ìˆ˜ ìˆìŒ ("ë‘˜ ë‹¤"ëŠ” ë­ì§€?)
- âŒ ì—­í•  ë³€ê²½ ì‹œ ì¬ì„¤ì • í•„ìš”
- âŒ ì‹¤ì œ ì‚¬ìš© íŒ¨í„´ê³¼ ë¶ˆì¼ì¹˜ ê°€ëŠ¥

### ê°œì„ ì•ˆ
- ì—­í•  ì„ íƒ í›„ì—ë„ ë³€ê²½ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì • í™”ë©´ ì œê³µ

---

## ë°©ì•ˆ 3: í–‰ë™ ê¸°ë°˜ ìë™ ê°ì§€

### ì›ë¦¬
ì‚¬ìš©ìê°€ ì–´ë–¤ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ëŠ”ì§€ì— ë”°ë¼ ì—­í•  ì¶”ë¡ 

### ë¡œì§
```dart
// ì‚¬ìš©ìê°€ "ë³´í˜¸ì ì§€ì •" í™”ë©´ì—ì„œ ë³´í˜¸ìë¥¼ ì¶”ê°€
â†’ roleì„ 'subject'ë¡œ ì¶”ë¡ 

// ì‚¬ìš©ìê°€ "ë³´í˜¸ ëŒ€ìƒ ì¶”ê°€" í™”ë©´ì—ì„œ ë³´í˜¸ ëŒ€ìƒì„ ì¶”ê°€
â†’ roleì„ 'guardian'ìœ¼ë¡œ ì¶”ë¡ 

// ë‘˜ ë‹¤ ìˆ˜í–‰
â†’ roleì„ 'both'ë¡œ ì¶”ë¡ 
```

### ì¥ì 
- âœ… ìì—°ìŠ¤ëŸ¬ìš´ ì—­í•  ì „í™˜
- âœ… ì‚¬ìš©ìê°€ ëª…ì‹œì ìœ¼ë¡œ ì„ íƒí•  í•„ìš” ì—†ìŒ

### ë‹¨ì 
- âŒ ì´ˆê¸°ì—ëŠ” ì—­í• ì„ ì•Œ ìˆ˜ ì—†ìŒ (ê¸°ë³¸ê°’ ì‚¬ìš©)
- âŒ í–‰ë™ì´ ì—†ìœ¼ë©´ ì—­í• ì´ ì—…ë°ì´íŠ¸ë˜ì§€ ì•ŠìŒ

---

## ë°©ì•ˆ 4: ë‘ ê°œì˜ ì•±ìœ¼ë¡œ ë¶„ë¦¬

### ì›ë¦¬
- **"ì§€ê¸ˆ ì–´ë•Œ? (ë³´í˜¸ ëŒ€ìƒììš©)"** ì•±
- **"ì§€ê¸ˆ ì–´ë•Œ? (ë³´í˜¸ììš©)"** ì•±

### ì¥ì 
- âœ… ì—­í• ì´ ëª…í™•íˆ êµ¬ë¶„ë¨
- âœ… ê° ì•±ì˜ UIê°€ ë‹¨ìˆœí•¨
- âœ… ì•±ìŠ¤í† ì–´ì—ì„œ ì—­í• ë³„ë¡œ ê²€ìƒ‰ ê°€ëŠ¥

### ë‹¨ì 
- âŒ ë‘ ê°œì˜ ì•± ê°œë°œ/ìœ ì§€ë³´ìˆ˜ í•„ìš”
- âŒ ì½”ë“œ ì¤‘ë³µ
- âŒ ë‘˜ ë‹¤ ì—­í•  ì‚¬ìš©ì ë¶ˆí¸ (ì•± 2ê°œ ì„¤ì¹˜)
- âŒ ë°°í¬/ì—…ë°ì´íŠ¸ ë³µì¡ë„ ì¦ê°€

---

## ë°©ì•ˆ 5: í•˜ì´ë¸Œë¦¬ë“œ (ìë™ ê°ì§€ + ìˆ˜ë™ ì˜¤ë²„ë¼ì´ë“œ)

### ì›ë¦¬
1. ìë™ ê°ì§€ë¡œ ê¸°ë³¸ ì—­í•  ê²°ì •
2. ì„¤ì • í™”ë©´ì—ì„œ ì—­í•  ìˆ˜ë™ ë³€ê²½ ê°€ëŠ¥

### UI íë¦„
```
ë¡œê·¸ì¸
  â†“
ìë™ ì—­í•  ê°ì§€ (ë°©ì•ˆ 1)
  â†“
í™ˆ í™”ë©´ (ì—­í•  ê¸°ë°˜ UI)
  â†“
ì„¤ì • â†’ ì—­í•  ë³€ê²½ (ì„ íƒì )
```

### ì¥ì 
- âœ… ìë™ ê°ì§€ì˜ í¸ë¦¬í•¨
- âœ… í•„ìš” ì‹œ ìˆ˜ë™ ì¡°ì • ê°€ëŠ¥
- âœ… ìœ ì—°í•œ ì—­í•  ê´€ë¦¬

---

## ğŸ¯ **ìµœì¢… ê¶Œì¥ ë°©ì•ˆ: ë°©ì•ˆ 1 (ìë™ ê°ì§€)**

### ì´ìœ 
1. **ì‚¬ìš©ì ê²½í—˜**: ë³„ë„ ì„¤ì • ì—†ì´ ìì—°ìŠ¤ëŸ¬ìš´ ì—­í•  ì „í™˜
2. **ì‹¤ì œ ì‚¬ìš© íŒ¨í„´ ë°˜ì˜**: ë³´í˜¸ìë¥¼ ì¶”ê°€í•˜ë©´ ìë™ìœ¼ë¡œ ì—­í• ì´ ì—…ë°ì´íŠ¸ë¨
3. **ë‹¨ì¼ ì•±**: í•˜ë‚˜ì˜ ì•±ìœ¼ë¡œ ëª¨ë“  ì—­í•  ì§€ì›
4. **ìœ ì§€ë³´ìˆ˜**: ì½”ë“œ ì¤‘ë³µ ì—†ì´ ê´€ë¦¬ ê°€ëŠ¥

### êµ¬í˜„ ì˜ˆì‹œ

#### 1. AuthServiceì— ì—­í•  ê°ì§€ ë©”ì„œë“œ ì¶”ê°€

```dart
// lib/services/auth_service.dart

Future<UserRole> _detectUserRole(String uid) async {
  try {
    // 1. subjects/{uid} ë¬¸ì„œ í™•ì¸ (ë³´í˜¸ ëŒ€ìƒì ì—¬ë¶€)
    final subjectDoc = await _firestore
      .collection('subjects')
      .doc(uid)
      .get();
    final isSubject = subjectDoc.exists;
    
    // 2. ë‹¤ë¥¸ subjectsì—ì„œ ë‚´ê°€ ë³´í˜¸ìì¸ì§€ í™•ì¸
    final guardianQuery = await _firestore
      .collection('subjects')
      .where('pairedGuardianUids', arrayContains: uid)
      .limit(1)
      .get();
    final isGuardian = guardianQuery.docs.isNotEmpty;
    
    // 3. ì—­í•  ê²°ì •
    if (isSubject && isGuardian) {
      return UserRole.both;
    } else if (isGuardian) {
      return UserRole.guardian;
    } else {
      return UserRole.subject; // ê¸°ë³¸ê°’
    }
  } catch (e) {
    debugPrint('ì—­í•  ê°ì§€ ì˜¤ë¥˜: $e');
    return UserRole.subject; // ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ê°’
  }
}

Future<void> _loadUserData(String uid) async {
  try {
    final doc = await _firestore.collection('users').doc(uid).get();
    UserRole detectedRole = UserRole.subject;
    
    if (doc.exists) {
      final data = doc.data();
      if (data != null && data is Map<String, dynamic>) {
        // ê¸°ì¡´ roleì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ìë™ ê°ì§€
        final existingRole = data['role'];
        if (existingRole != null && existingRole is String) {
          detectedRole = UserModel._roleFromString(existingRole);
        } else {
          // roleì´ ì—†ìœ¼ë©´ ìë™ ê°ì§€
          detectedRole = await _detectUserRole(uid);
          // ê°ì§€í•œ ì—­í• ì„ Firestoreì— ì €ì¥
          await _firestore.collection('users').doc(uid).update({
            'role': UserModel._roleToString(detectedRole),
          });
        }
        
        // ë°ì´í„° ë¡œë“œ
        final updatedData = Map<String, dynamic>.from(data);
        updatedData['role'] = UserModel._roleToString(detectedRole);
        _userModel = UserModel.fromMap(updatedData, uid);
      }
    } else {
      // ë¬¸ì„œê°€ ì—†ìœ¼ë©´ ìë™ ê°ì§€ í›„ ìƒì„±
      detectedRole = await _detectUserRole(uid);
      await _firestore.collection('users').doc(uid).set({
        'phone': '', // ë‚˜ì¤‘ì— ì—…ë°ì´íŠ¸ë¨
        'role': UserModel._roleToString(detectedRole),
        'fcmTokens': [],
      });
      _userModel = UserModel(
        uid: uid,
        phone: '',
        role: detectedRole,
      );
    }
    
    // FCM ì„œë¹„ìŠ¤ ì´ˆê¸°í™”
    await FCMService.instance.initialize(uid);
    notifyListeners();
  } catch (e, stack) {
    debugPrint('ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: $e');
    debugPrint('ìŠ¤íƒ: $stack');
  }
}
```

#### 2. ì—­í•  ë³€ê²½ ì‹œ ìë™ ì—…ë°ì´íŠ¸

```dart
// ë³´í˜¸ì ì¶”ê°€ ì‹œ (guardian_screen.dart)
// ë³´í˜¸ ëŒ€ìƒ ì¶”ê°€ ì‹œ (guardian_dashboard_screen.dart)
// â†’ ì—­í•  ìë™ ì—…ë°ì´íŠ¸ íŠ¸ë¦¬ê±°

Future<void> _updateUserRole(String userId) async {
  final detectedRole = await AuthService()._detectUserRole(userId);
  await _firestore.collection('users').doc(userId).update({
    'role': UserModel._roleToString(detectedRole),
  });
  // AuthServiceì˜ userModelë„ ì—…ë°ì´íŠ¸ í•„ìš”
}
```

---

## ì¶”ê°€ ê³ ë ¤ì‚¬í•­

### 1. ì—­í•  ë³€ê²½ ì‹œ UI ì—…ë°ì´íŠ¸
- ì—­í• ì´ ë³€ê²½ë˜ë©´ í™ˆ í™”ë©´ì„ ë‹¤ì‹œ ë¹Œë“œí•´ì•¼ í•¨
- `AuthService`ì—ì„œ `notifyListeners()` í˜¸ì¶œë¡œ ìë™ ì—…ë°ì´íŠ¸

### 2. ì„±ëŠ¥ ìµœì í™”
- ì—­í•  ê°ì§€ ì¿¼ë¦¬ë¥¼ ìºì‹±
- ë˜ëŠ” `subjects` ë¬¸ì„œì— ì—­í•  ì •ë³´ë¥¼ í•¨ê»˜ ì €ì¥

### 3. ì´ˆê¸° ë¡œë”© ì‹œê°„
- ì—­í•  ê°ì§€ê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ë¡œë”© í‘œì‹œ
- ë˜ëŠ” ê¸°ë³¸ê°’(subject)ìœ¼ë¡œ ë¨¼ì € í‘œì‹œ í›„ ì—…ë°ì´íŠ¸

---

## ê²°ë¡ 

**ê¶Œì¥: ë°©ì•ˆ 1 (ìë™ ê°ì§€)**
- ì‚¬ìš©ì ê²½í—˜ì´ ê°€ì¥ ì¢‹ìŒ
- ì‹¤ì œ ì‚¬ìš© íŒ¨í„´ì„ ìì—°ìŠ¤ëŸ½ê²Œ ë°˜ì˜
- í•˜ë‚˜ì˜ ì•±ìœ¼ë¡œ ëª¨ë“  ì—­í•  ì§€ì›

**ëŒ€ì•ˆ: ë°©ì•ˆ 5 (í•˜ì´ë¸Œë¦¬ë“œ)**
- ìë™ ê°ì§€ + ì„¤ì •ì—ì„œ ìˆ˜ë™ ë³€ê²½ ê°€ëŠ¥
- ë” ìœ ì—°í•˜ì§€ë§Œ ë³µì¡ë„ ì¦ê°€
