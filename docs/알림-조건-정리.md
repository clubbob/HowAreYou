# 알림 조건 정리

## 📱 보호대상자 알림 (로컬 알림)

### 알림 유형
- **로컬 알림** (앱 내부에서 스케줄링, `flutter_local_notifications` 사용)

### 발송 조건
1. **앱이 설치되어 있고 로그인되어 있음**
2. **알림 권한이 허용되어 있음** (Android 13 이상)
3. **앱 초기화 시 자동 스케줄링** (`NotificationService.initialize()`)
4. **보호대상자 모드로 진입** (`SubjectModeScreen`)

### 발송 시간
- **매일 18:00** (한국 시간, 저녁 시간, `Asia/Seoul` 타임존)
- 하루 1회만 발송 (기존 3회에서 변경)

### 알림 내용
- **제목**: "지금 어때?"
- **내용**: "오늘 컨디션을 기록해 주세요."
- **채널 ID**: `daily_mood_check`
- **채널 이름**: "일일 상태 확인"
- **채널 설명**: "하루 1번 상태를 확인하는 알림"
- **소리**: ON (기본값, 앱 설정에서 무음 가능)
- **진동**: ON (패턴: 0, 500, 200, 500ms)
- **우선순위**: `high`

### 알림 탭 시 동작
1. 보호대상자 모드로 자동 전환 (`ModeService.saveSelectedMode(ModeService.modeSubject)`)
2. 홈 화면으로 이동 후 `SubjectModeScreen`으로 전환
3. 질문 화면(`QuestionScreen`)으로 이동 (`TimeSlot.daily`)

### 알림 스케줄링
- **정확 알람 모드**: `AndroidScheduleMode.exactAllowWhileIdle` (기본)
- **정확 알람 권한 없을 경우**: `AndroidScheduleMode.inexactAllowWhileIdle`로 대체
- **매일 반복**: `matchDateTimeComponents: DateTimeComponents.time`

---

## 👨‍👩‍👧 보호자 알림 (FCM 푸시 알림)

### 알림 유형
- **FCM 푸시 알림** (Firebase Cloud Messaging)
- **포그라운드 알림**: 앱이 열려있을 때도 로컬 알림으로 표시

### 발송 조건

#### 1. 보호대상자가 컨디션을 기록했을 때
**트리거**: 
- `subjects/{subjectId}/prompts/{promptId}` 문서 생성 시 (`onResponseCreated`)
- `subjects/{subjectId}/prompts/{promptId}` 문서 업데이트 시 (`onResponseUpdated`)

**조건**:
- 보호대상자 문서(`subjects/{subjectId}`)에 `pairedGuardianUids` 배열이 존재하고 비어있지 않음
- 각 보호자(`users/{guardianUid}`) 문서에 `fcmTokens` 배열이 존재하고 비어있지 않음
- 보호자의 알림 권한이 허용되어 있음

**알림 내용**:
- **제목**: "상태 확인 알림"
- **내용**: 
  - `slot === 'daily'`인 경우: "OO님이 오늘 컨디션을 기록했습니다"
  - 그 외: "OO님이 컨디션을 기록했습니다"
- **채널 ID**: `guardian_notifications`
- **채널 이름**: "보호자 알림"
- **채널 설명**: "보호 대상의 상태 확인 및 미회신 알림"
- **소리**: ON (설정에서 무음 가능)
- **진동**: ON
- **우선순위**: `high`
- **데이터 타입**: `RESPONSE_RECEIVED`
- **데이터 필드**:
  - `type`: `RESPONSE_RECEIVED`
  - `subjectId`: 보호대상자 UID
  - `subjectDisplayName`: 보호대상자 이름
  - `click_action`: `FLUTTER_NOTIFICATION_CLICK`

**알림 탭 시 동작**:
- **앱이 열려있을 때**: `GuardianDashboardScreen`으로 이동
- **앱이 닫혀있을 때**: 앱 시작 후 `SplashScreen`에서 알림 타입 확인하여 `GuardianDashboardScreen`으로 이동

**포그라운드 알림 처리**:
- 앱이 포그라운드에 있을 때도 로컬 알림으로 표시 (`FlutterLocalNotificationsPlugin.show()`)
- 알림 소리 설정(`notification_sound_enabled`)에 따라 소리 ON/OFF

---

## 🔔 알림 권한 요청

### 보호대상자
- **위치**: `SubjectModeScreen` 진입 시 (`initState`의 `WidgetsBinding.instance.addPostFrameCallback`)
- **순서**: 
  1. 환영 다이얼로그 표시 (최초 1회만)
  2. 알림 권한 요청 (다이얼로그 닫힌 후 또는 바로)
- **메시지**: 
  ```
  하루 한 번 컨디션 기록 알림을 받으려면 알림 권한이 필요해요.
  
  다음 화면에서 「허용」을 눌러 주세요.
  ```
- **목적**: 로컬 알림 수신 (일일 상태 확인 알림)
- **권한 확인**: `PermissionHelper.isNotificationPermissionGranted()`로 먼저 확인
- **권한 요청**: `PermissionHelper.requestNotificationPermission(context, isForSubject: true)`

### 보호자
- **위치**: 
  - `GuardianModeScreen` 진입 시 (`_initializeFCM`)
  - `GuardianDashboardScreen` 진입 시 (`_initializeFCM`)
- **메시지**: 
  ```
  "보호대상자"가 상태를 등록한 경우 "보호자"께 알림을 보내도록 허용하시겠습니까?
  
  다음 화면에서 「허용」을 눌러 주세요.
  ```
- **목적**: FCM 푸시 알림 수신 (보호대상자 상태 등록 알림)
- **권한 확인**: `PermissionHelper.isNotificationPermissionGranted()`로 먼저 확인
- **권한 요청**: `PermissionHelper.requestNotificationPermission(context, isForSubject: false)`

**통일된 정책**: 보호대상자와 보호자 모두 각 모드 진입 시에만 알림 권한을 요청합니다. 역할 선택 화면(`HomeScreen`)에서는 권한을 요청하지 않습니다.

### 권한 요청 플로우
1. **권한 상태 확인**: 이미 허용되었으면 다이얼로그 표시하지 않고 종료
2. **한글 커스텀 다이얼로그 표시**: 사용자에게 권한 필요성 설명
3. **시스템 권한 요청**: `AndroidFlutterLocalNotificationsPlugin.requestNotificationsPermission()`
4. **권한 거부 시**: 안내 다이얼로그 표시 (설정에서 변경 가능 안내)

---

## ⚠️ 알림 발송 실패 조건

### 보호대상자 로컬 알림 실패 시
1. 알림 권한이 거부됨 (Android 13 이상)
2. 정확 알람 권한이 없고 대략적 알람도 실패한 경우
3. 앱이 완전히 종료되어 알림 스케줄이 취소된 경우

### 보호대상자 → 보호자 FCM 알림 실패 시
1. 보호자가 없음 (`pairedGuardianUids`가 비어있음)
2. 보호자 문서가 없음 (`users/{guardianUid}` 문서가 존재하지 않음)
3. 보호자의 FCM 토큰이 없음 (`fcmTokens` 배열이 비어있음)
4. 보호자의 알림 권한이 거부됨
5. FCM 토큰이 만료되거나 무효함 (자동 정리됨)
6. 네트워크 오류 또는 Firebase 서비스 오류

### FCM 토큰 자동 정리
- **Invalid 토큰 에러 코드**:
  - `messaging/registration-token-not-registered`
  - `messaging/invalid-registration-token`
- **정리 방식**: Cloud Functions에서 발송 실패 시 자동으로 `users/{guardianUid}` 문서의 `fcmTokens` 배열에서 제거

---

## 📊 알림 발송 로직

### 보호대상자 로컬 알림 스케줄링
```
1. 앱 초기화 시 NotificationService.initialize() 호출
   ↓
2. timezone 초기화 (Asia/Seoul)
   ↓
3. scheduleDailyNotifications() 호출
   ↓
4. 기존 알림 모두 취소 (cancelAll)
   ↓
5. 매일 18:00에 알림 스케줄 설정
   - 정확 알람 모드 시도
   - 실패 시 대략적 알람 모드로 대체
   ↓
6. 매일 지정된 시간에 알림 발송
```

### 보호대상자 상태 등록 시 보호자 알림 발송
```
1. 보호대상자가 상태 등록 (QuestionScreen)
   ↓
2. Firestore에 prompts/{date} 문서 생성/업데이트
   ↓
3. Cloud Functions onResponseCreated/onResponseUpdated 트리거
   ↓
4. sendResponseNotification() 함수 실행
   ↓
5. 보호대상자 문서(subjects/{subjectId})에서 pairedGuardianUids 조회
   ↓
6. 보호자가 없으면 종료
   ↓
7. 각 보호자별로 병렬 처리:
   - users/{guardianUid} 문서에서 fcmTokens 조회
   - sendToGuardian() 헬퍼 함수 호출
   - FCM 메시지 발송 (sendEachForMulticast)
   - 실패한 토큰 자동 제거
   ↓
8. 발송 결과 로깅 (성공/실패 개수)
```

---

## 🔧 알림 설정

### Android 알림 채널
1. **`daily_mood_check`**: 
   - 이름: "일일 상태 확인"
   - 설명: "하루 1번 상태를 확인하는 알림"
   - 중요도: `Importance.high`
   - 소리: ON
   - 진동: ON
   
2. **`guardian_notifications`**: 
   - 이름: "보호자 알림"
   - 설명: "보호 대상의 상태 확인 및 미회신 알림"
   - 중요도: `Importance.high`
   - 소리: ON (설정에서 변경 가능)
   - 진동: ON

### 알림 우선순위
- 보호자 알림: `Priority.high` (즉시 표시)
- 보호대상자 알림: `Priority.high` (즉시 표시)

### 알림 소리 설정
- **보호자 알림**: `SharedPreferences`의 `notification_sound_enabled` 키로 관리
- **기본값**: `true` (소리 ON)
- **설정 위치**: 앱 설정 화면 (구현 예정)

---

## 📝 참고사항

1. **하루 1회 응답 및 알림**: 하루 1회만 응답하도록 변경되었고, 알림도 하루 1회(18:00)만 발송됩니다.
2. **미회신 체크 제거**: 미회신 자동 체크 기능(`checkUnreachableSubjects`)은 제거되었습니다. 보호자가 직접 앱에서 확인해야 합니다.
3. **보호자 → 보호대상자 알림 제거**: 보호자가 보호대상자에게 알림을 보내는 기능(`sendReminderToSubject`)은 제거되었습니다. 코드에는 `REMIND_RESPONSE` 타입 처리 로직이 남아있지만 실제로는 발송되지 않습니다.
4. **FCM 토큰 관리**: Invalid 토큰은 자동으로 제거됩니다. 여러 기기 지원을 위해 `fcmTokens`는 배열로 관리됩니다.
5. **알림 권한**: Android 13 이상에서만 런타임 권한 요청이 필요합니다. iOS는 Firebase Messaging이 자동으로 처리합니다.
6. **타임존**: 모든 알림 스케줄링은 `Asia/Seoul` 타임존을 사용합니다.
7. **포그라운드 알림**: 보호자 알림은 앱이 포그라운드에 있을 때도 로컬 알림으로 표시됩니다.
