# ë¹„ë°€ë²ˆí˜¸ ì¬ë¡œê·¸ì¸ êµ¬í˜„ ë°©ì•ˆ

## ğŸ“Œ ëª©ì 
ì¬ë¡œê·¸ì¸ ì‹œ SMS ì¸ì¦ ëŒ€ì‹  ë¹„ë°€ë²ˆí˜¸/PINì„ ì‚¬ìš©í•˜ì—¬ Firebase Authentication SMS ë¹„ìš©ì„ ì ˆê°í•©ë‹ˆë‹¤.

## ğŸ’° ë¹„ìš© ì ˆê° íš¨ê³¼

### í˜„ì¬ ë°©ì‹ (SMS ë§¤ë²ˆ ì‚¬ìš©)
- **ì²« ë¡œê·¸ì¸**: SMS 1íšŒ ($0.06)
- **ì¬ë¡œê·¸ì¸**: SMS 1íšŒ ($0.06)
- **100ë§Œëª… ê¸°ì¤€**: ì›” 10ë§Œ ì‹ ê·œ + 10ë§Œ ì¬ë¡œê·¸ì¸ = **$12,000/ì›”**

### ë¹„ë°€ë²ˆí˜¸ ë°©ì‹ ì ìš© ì‹œ
- **ì²« ë¡œê·¸ì¸**: SMS 1íšŒ ($0.06) + ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
- **ì¬ë¡œê·¸ì¸**: ë¹„ë°€ë²ˆí˜¸ë§Œ ì‚¬ìš© (SMS $0)
- **100ë§Œëª… ê¸°ì¤€**: ì›” 10ë§Œ ì‹ ê·œë§Œ SMS = **$6,000/ì›”**
- **ì ˆê°ì•¡**: **$6,000/ì›” (50% ì ˆê°)**

## ğŸ” êµ¬í˜„ ë°©ì‹ ë¹„êµ

### ë°©ì‹ 1: Firestoreì— ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ ì €ì¥ (ê¶Œì¥)

**ì¥ì :**
- âœ… Firebase Authentication êµ¬ì¡° ë³€ê²½ ìµœì†Œí™”
- âœ… ê¸°ì¡´ ì „í™”ë²ˆí˜¸ ì¸ì¦ ìœ ì§€
- âœ… êµ¬í˜„ì´ ìƒëŒ€ì ìœ¼ë¡œ ê°„ë‹¨
- âœ… ë¹„ë°€ë²ˆí˜¸ ë³µêµ¬ ê¸°ëŠ¥ êµ¬í˜„ ê°€ëŠ¥

**ë‹¨ì :**
- âš ï¸ Firestore ì½ê¸° ë¹„ìš© ì†ŒëŸ‰ ì¦ê°€ (ì¬ë¡œê·¸ì¸ ì‹œ 1íšŒ)
- âš ï¸ ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ ì €ì¥ ê´€ë¦¬ í•„ìš”

**êµ¬í˜„ êµ¬ì¡°:**
```
1. ì²« ë¡œê·¸ì¸ (SMS ì¸ì¦)
   â†’ Firestore users/{uid}ì— passwordHash ì €ì¥ (ì„ íƒì )
   â†’ ë¹„ë°€ë²ˆí˜¸ ì„¤ì • í™”ë©´ í‘œì‹œ

2. ì¬ë¡œê·¸ì¸
   â†’ ì „í™”ë²ˆí˜¸ ì…ë ¥
   â†’ Firestoreì—ì„œ í•´ë‹¹ ì „í™”ë²ˆí˜¸ë¡œ users ë¬¸ì„œ ì¡°íšŒ
   â†’ passwordHash ì¡´ì¬ ì—¬ë¶€ í™•ì¸
   â†’ ì¡´ì¬í•˜ë©´: ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í™”ë©´
   â†’ ì—†ìœ¼ë©´: SMS ì¸ì¦ í™”ë©´ (ê¸°ì¡´ ì‚¬ìš©ì í˜¸í™˜)
```

### ë°©ì‹ 2: Firebase Email/Password ì¸ì¦ í™œìš©

**ì¥ì :**
- âœ… Firebaseì˜ í‘œì¤€ ì¸ì¦ ë°©ì‹
- âœ… ë³´ì•ˆ ê´€ë¦¬ê°€ Firebaseì— ìœ„ì„ë¨

**ë‹¨ì :**
- âš ï¸ ì „í™”ë²ˆí˜¸ë¥¼ ì´ë©”ì¼ì²˜ëŸ¼ ì‚¬ìš©í•´ì•¼ í•¨ (êµ¬ì¡° ë³€ê²½ í•„ìš”)
- âš ï¸ ê¸°ì¡´ ì‚¬ìš©ì ë§ˆì´ê·¸ë ˆì´ì…˜ ë³µì¡
- âš ï¸ ì „í™”ë²ˆí˜¸ í˜•ì‹ ì œì•½

**êµ¬í˜„ êµ¬ì¡°:**
```
ì „í™”ë²ˆí˜¸ë¥¼ ì´ë©”ì¼ì²˜ëŸ¼ ì‚¬ìš©: "01012345678@howareyou.app"
â†’ Firebase Email/Password ì¸ì¦ ì‚¬ìš©
â†’ ì²« ë¡œê·¸ì¸ ì‹œ SMSë¡œ ì¸ì¦ í›„ ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
â†’ ì¬ë¡œê·¸ì¸ ì‹œ ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¡œ ì¸ì¦
```

### ë°©ì‹ 3: PIN ì½”ë“œ ë°©ì‹ (4-6ìë¦¬)

**ì¥ì :**
- âœ… ì…ë ¥ì´ ê°„ë‹¨í•¨
- âœ… ì‚¬ìš©ì ë¶€ë‹´ ì ìŒ
- âœ… ì•±ì˜ "ë¶€ë‹´ ì—†ìŒ" ì² í•™ê³¼ ë¶€í•©

**ë‹¨ì :**
- âš ï¸ ë³´ì•ˆ ìˆ˜ì¤€ì´ ë‚®ìŒ (í•˜ì§€ë§Œ ì´ ì•± íŠ¹ì„±ìƒ ì í•©í•  ìˆ˜ ìˆìŒ)
- âš ï¸ PIN ë¶„ì‹¤ ì‹œ SMSë¡œ ë³µêµ¬ í•„ìš”

**êµ¬í˜„ êµ¬ì¡°:**
```
1. ì²« ë¡œê·¸ì¸ (SMS ì¸ì¦)
   â†’ 4-6ìë¦¬ PIN ì„¤ì • í™”ë©´
   â†’ Firestoreì— PIN í•´ì‹œ ì €ì¥

2. ì¬ë¡œê·¸ì¸
   â†’ ì „í™”ë²ˆí˜¸ ì…ë ¥
   â†’ PIN ì…ë ¥ í™”ë©´
   â†’ PIN ì¼ì¹˜ ì‹œ Firebase Authì˜ ê¸°ì¡´ ì„¸ì…˜ í™œìš© ë˜ëŠ” ì¬ì¸ì¦
```

## ğŸ¯ ê¶Œì¥ êµ¬í˜„: ë°©ì‹ 1 (Firestore ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ)

### êµ¬í˜„ ë‹¨ê³„

#### 1ë‹¨ê³„: Firestore ìŠ¤í‚¤ë§ˆ í™•ì¥
```dart
// users/{uid}
{
  'phone': '+821012345678',
  'role': 'subject',
  'passwordHash': 'bcrypt_hash...', // ì„ íƒì , ì²« ë¡œê·¸ì¸ í›„ ì„¤ì •
  'hasPassword': true, // ë¹„ë°€ë²ˆí˜¸ ì„¤ì • ì—¬ë¶€
  'createdAt': Timestamp,
}
```

#### 2ë‹¨ê³„: ë¹„ë°€ë²ˆí˜¸ í•´ì‹± ìœ í‹¸ë¦¬í‹°
```dart
// lib/utils/password_helper.dart
import 'package:crypto/crypto.dart';
import 'dart:convert';

class PasswordHelper {
  static String hashPassword(String password) {
    // bcrypt ë˜ëŠ” SHA-256 + salt ì‚¬ìš©
    // ê°„ë‹¨í•œ êµ¬í˜„: SHA-256 + salt (ì‹¤ì œë¡œëŠ” bcrypt ê¶Œì¥)
    final bytes = utf8.encode(password + 'salt_key');
    final digest = sha256.convert(bytes);
    return digest.toString();
  }
  
  static bool verifyPassword(String password, String hash) {
    return hashPassword(password) == hash;
  }
}
```

#### 3ë‹¨ê³„: AuthService í™•ì¥
```dart
// lib/services/auth_service.dartì— ì¶”ê°€

/// ì „í™”ë²ˆí˜¸ë¡œ ì‚¬ìš©ì ì¡°íšŒ (ë¹„ë°€ë²ˆí˜¸ ì¡´ì¬ ì—¬ë¶€ í™•ì¸)
Future<Map<String, dynamic>?> findUserByPhone(String phoneNumber) async {
  final normalizedPhone = _toE164(phoneNumber);
  final query = await _firestore
      .collection('users')
      .where('phone', isEqualTo: normalizedPhone)
      .limit(1)
      .get();
  
  if (query.docs.isEmpty) return null;
  
  final doc = query.docs.first;
  return {
    'uid': doc.id,
    'hasPassword': doc.data()['hasPassword'] ?? false,
    'passwordHash': doc.data()['passwordHash'],
  };
}

/// ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸ (ì¬ë¡œê·¸ì¸ìš©)
Future<String?> loginWithPassword(String phoneNumber, String password) async {
  try {
    final userInfo = await findUserByPhone(phoneNumber);
    if (userInfo == null) {
      return 'ë“±ë¡ë˜ì§€ ì•Šì€ ì „í™”ë²ˆí˜¸ì…ë‹ˆë‹¤.';
    }
    
    if (userInfo['hasPassword'] != true) {
      // ë¹„ë°€ë²ˆí˜¸ê°€ ì—†ëŠ” ì‚¬ìš©ìëŠ” SMS ì¸ì¦ìœ¼ë¡œ ìœ ë„
      return null; // SMS ì¸ì¦ í•„ìš”
    }
    
    final passwordHash = userInfo['passwordHash'] as String?;
    if (passwordHash == null || 
        !PasswordHelper.verifyPassword(password, passwordHash)) {
      return 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•Šì•„ìš”.';
    }
    
    // Firebase Authì— ì´ë¯¸ ë¡œê·¸ì¸ëœ ìƒíƒœì¸ì§€ í™•ì¸
    // ë˜ëŠ” ì „í™”ë²ˆí˜¸ ì¸ì¦ì„ ë‹¤ì‹œ ìˆ˜í–‰í•´ì•¼ í•  ìˆ˜ë„ ìˆìŒ
    // (Firebase AuthëŠ” ì „í™”ë²ˆí˜¸ë§Œìœ¼ë¡œëŠ” ì¬ë¡œê·¸ì¸ ë¶ˆê°€)
    
    // í•´ê²°ì±…: Custom Token ì‚¬ìš© ë˜ëŠ” ê¸°ì¡´ ì„¸ì…˜ í™•ì¸
    // ë˜ëŠ” SMS ì—†ì´ PhoneAuthCredentialì„ ìƒì„±í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ
    // ì´ ë°©ì‹ì€ ì œí•œì ì„
    
    return 'ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ ì„±ê³µ (ì¶”ê°€ êµ¬í˜„ í•„ìš”)';
  } catch (e) {
    return 'ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
  }
}

/// ì²« ë¡œê·¸ì¸ í›„ ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
Future<String?> setPassword(String password) async {
  if (_user == null) return 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.';
  
  try {
    final passwordHash = PasswordHelper.hashPassword(password);
    await _firestore.collection('users').doc(_user!.uid).update({
      'passwordHash': passwordHash,
      'hasPassword': true,
    });
    return null;
  } catch (e) {
    return 'ë¹„ë°€ë²ˆí˜¸ ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
  }
}
```

#### 4ë‹¨ê³„: AuthScreen ìˆ˜ì •
```dart
// lib/screens/auth_screen.dart

// ì „í™”ë²ˆí˜¸ ì…ë ¥ í›„
Future<void> _checkLoginMethod(String phoneNumber) async {
  final authService = Provider.of<AuthService>(context, listen: false);
  final userInfo = await authService.findUserByPhone(phoneNumber);
  
  if (userInfo != null && userInfo['hasPassword'] == true) {
    // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í™”ë©´ìœ¼ë¡œ ì´ë™
    setState(() {
      _showPasswordInput = true;
      _currentPhoneNumber = phoneNumber;
    });
  } else {
    // SMS ì¸ì¦ í™”ë©´ìœ¼ë¡œ ì´ë™ (ê¸°ì¡´ ë°©ì‹)
    await _sendOTP(phoneNumber);
  }
}

// ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í›„
Future<void> _loginWithPassword(String password) async {
  final authService = Provider.of<AuthService>(context, listen: false);
  final error = await authService.loginWithPassword(
    _currentPhoneNumber!,
    password,
  );
  
  if (error == null) {
    // ë¡œê·¸ì¸ ì„±ê³µ ì²˜ë¦¬
  } else {
    // ì—ëŸ¬ í‘œì‹œ
  }
}
```

## âš ï¸ ì£¼ì˜ì‚¬í•­

### Firebase Auth ì œì•½
Firebase Authenticationì€ **ì „í™”ë²ˆí˜¸ë§Œìœ¼ë¡œëŠ” ì¬ë¡œê·¸ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤**. SMS ì¸ì¦ ì—†ì´ PhoneAuthCredentialì„ ìƒì„±í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

**í•´ê²° ë°©ì•ˆ:**
1. **Custom Token ì‚¬ìš©**: Cloud Functionsì—ì„œ Custom Token ìƒì„±
2. **ê¸°ì¡´ ì„¸ì…˜ í™•ì¸**: Firebase Authì˜ ì˜êµ¬ ì„¸ì…˜ í™œìš© (ë¡œê·¸ì•„ì›ƒí•˜ì§€ ì•Šìœ¼ë©´ ìœ ì§€)
3. **í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹**: ë¹„ë°€ë²ˆí˜¸ë¡œ Firestore ì¸ì¦ í›„, Firebase AuthëŠ” ê¸°ì¡´ ì„¸ì…˜ ìœ ì§€

### ë³´ì•ˆ ê³ ë ¤ì‚¬í•­
- ë¹„ë°€ë²ˆí˜¸ëŠ” ë°˜ë“œì‹œ í•´ì‹œí•˜ì—¬ ì €ì¥ (bcrypt ê¶Œì¥)
- ì „í™”ë²ˆí˜¸ ì¡°íšŒ ì‹œ Firestore Security Rulesë¡œ ì ‘ê·¼ ì œì–´
- ë¹„ë°€ë²ˆí˜¸ ë¶„ì‹¤ ì‹œ SMSë¡œ ë³µêµ¬ ê¸°ëŠ¥ ì œê³µ

### ì‚¬ìš©ì ê²½í—˜
- ì²« ë¡œê·¸ì¸ ì‹œ ë¹„ë°€ë²ˆí˜¸ ì„¤ì •ì„ **ì„ íƒì ìœ¼ë¡œ** ì œê³µ
- "ë‚˜ì¤‘ì— ì„¤ì •í•˜ê¸°" ì˜µì…˜ ì œê³µ
- ë¹„ë°€ë²ˆí˜¸ ë¶„ì‹¤ ì‹œ "SMSë¡œ ë¡œê·¸ì¸" ì˜µì…˜ ì œê³µ

## ğŸ“Š ë¹„ìš© ë¹„êµ (100ë§Œëª… ê¸°ì¤€)

| ì‹œë‚˜ë¦¬ì˜¤ | ì›” SMS ë°œì†¡ | ì›” ë¹„ìš© |
|---------|------------|---------|
| **í˜„ì¬ (SMSë§Œ)** | 20ë§Œê±´ (ì‹ ê·œ 10ë§Œ + ì¬ë¡œê·¸ì¸ 10ë§Œ) | $12,000 |
| **ë¹„ë°€ë²ˆí˜¸ ë°©ì‹** | 10ë§Œê±´ (ì‹ ê·œë§Œ) | $6,000 |
| **ì ˆê°ì•¡** | 10ë§Œê±´ | **$6,000** |

## ğŸ¯ ê²°ë¡ 

**ë¹„ë°€ë²ˆí˜¸ ì¬ë¡œê·¸ì¸ ë°©ì‹ì€ SMS ë¹„ìš©ì„ 50% ì ˆê°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

ë‹¤ë§Œ Firebase Authì˜ êµ¬ì¡°ì  ì œì•½ìœ¼ë¡œ ì¸í•´ ì™„ì „í•œ êµ¬í˜„ì—ëŠ” ì¶”ê°€ ì‘ì—…ì´ í•„ìš”í•©ë‹ˆë‹¤. ê°€ì¥ í˜„ì‹¤ì ì¸ ë°©ë²•ì€:

1. **Firestoreì— ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ ì €ì¥**
2. **ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ ì„±ê³µ ì‹œ Firebase Custom Token ìƒì„±** (Cloud Functions)
3. **Custom Tokenìœ¼ë¡œ Firebase Auth ë¡œê·¸ì¸**

ë˜ëŠ” ë” ê°„ë‹¨í•œ ë°©ë²•ìœ¼ë¡œ:
- **ì•± ë‚´ë¶€ì—ì„œ ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ë§Œ ìˆ˜í–‰**
- **Firebase AuthëŠ” ê¸°ì¡´ ì„¸ì…˜ ìœ ì§€** (ë¡œê·¸ì•„ì›ƒí•˜ì§€ ì•Šìœ¼ë©´ ìë™ ìœ ì§€)
- **ì¬ë¡œê·¸ì¸ì€ ì•± ë ˆë²¨ì—ì„œë§Œ ì²˜ë¦¬**

ì´ ë°©ì‹ì€ ë³´ì•ˆ ìˆ˜ì¤€ì´ ë‚®ì„ ìˆ˜ ìˆì§€ë§Œ, ì´ ì•±ì˜ íŠ¹ì„±ìƒ ì¶©ë¶„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
