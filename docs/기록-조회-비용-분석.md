# 기록 조회 범위 확대 시 비용 분석

## 현재 상황

### 데이터 저장
- **모든 기록은 이미 Firestore에 저장됨** (삭제하지 않음)
- 보호대상자가 기록할 때마다 `subjects/{subjectId}/prompts/{YYYY-MM-DD}` 문서 생성
- 저장 비용은 이미 발생 중 (조회 범위와 무관)

### 현재 조회 범위
- **보호대상자**: 최근 7일만 조회 (`getLast7DaysResponses`)
- **보호자**: 최근 7일만 조회 (보안 규칙에 의해 제한)

---

## 비용 영향 분석

### 기준 설정
- **총 회원**: 100,000명
- **보호대상자**: 50,000명
- **보호자**: 50,000명
- **보호대상자당 평균 보호자 수**: 1.5명

---

### 1. 저장 비용 (변화 없음)

**현재 구조:**
- 모든 기록이 이미 저장되고 있음
- 조회 범위를 늘려도 저장 비용은 변하지 않음

**10만명 기준 저장 비용:**
- 보호대상자 5만명 × 하루 1회 × 30일 = 150만 문서/월
- 문서당 평균 크기: 약 200 bytes (mood, answeredAt, slot, note)
- 월 저장량: 약 300 MB
- **무료 할당량**: 1 GB/월
- **저장 비용**: **$0.00** (무료 할당량 내)

**1년 후 누적 저장량:**
- 5만명 × 365일 = 1,825만 문서
- 총 저장량: 약 3.65 GB
- **비용**: (3.65 - 1) GB × $0.18/GB = **$0.477/월** (약 620원)

---

### 2. 읽기 비용 (조회 범위에 따라 증가)

#### 현재 (최근 7일만 조회)

**보호대상자가 기록 화면 조회 시:**
- 7개 문서 읽기 (최근 7일)
- 사용자당 월 조회 횟수: 약 10회 가정
- 총 읽기: 5만명 × 10회 × 7개 = **350만회/월**

**보호자가 기록 화면 조회 시:**
- 보호자 5만명 × 평균 1.5명의 보호대상자 = 7.5만 연결
- 각 보호대상자당 7개 문서 읽기 (최근 7일)
- 보호자당 월 조회 횟수: 약 5회 가정 (알림 받고 확인)
- 총 읽기: 5만명 × 5회 × 1.5명 × 7개 = **262.5만회/월**

**총 읽기 비용:**
- 보호대상자 조회: 350만회
- 보호자 조회: 262.5만회
- **총 읽기: 612.5만회/월**

**비용:**
- 무료 할당량: 150만회/월
- 초과분: 462.5만회
- **비용**: (462.5만 / 10만) × $0.03 = **$1.3875/월** ≈ **$1.39/월** (약 1,807원)

---

#### 시나리오 1: 최근 30일 조회

**보호대상자가 기록 화면 조회 시:**
- 30개 문서 읽기 (최근 30일)
- 사용자당 월 조회 횟수: 약 10회 가정
- 총 읽기: 5만명 × 10회 × 30개 = **1,500만회/월**

**보호자가 기록 화면 조회 시:**
- 보호자 5만명 × 평균 1.5명의 보호대상자
- 각 보호대상자당 30개 문서 읽기 (최근 30일)
- 보호자당 월 조회 횟수: 약 5회 가정
- 총 읽기: 5만명 × 5회 × 1.5명 × 30개 = **1,125만회/월**

**총 읽기 비용:**
- 보호대상자 조회: 1,500만회
- 보호자 조회: 1,125만회
- **총 읽기: 2,625만회/월**

**비용:**
- 무료 할당량: 150만회/월
- 초과분: 2,475만회
- **비용**: (2,475만 / 10만) × $0.03 = **$7.425/월** ≈ **$7.43/월** (약 9,659원)

**증가분**: $6.04/월 (약 7,852원)

---

#### 시나리오 2: 최근 90일 조회

**보호대상자가 기록 화면 조회 시:**
- 90개 문서 읽기 (최근 90일)
- 사용자당 월 조회 횟수: 약 10회 가정
- 총 읽기: 5만명 × 10회 × 90개 = **4,500만회/월**

**보호자가 기록 화면 조회 시:**
- 보호자 5만명 × 평균 1.5명의 보호대상자
- 각 보호대상자당 90개 문서 읽기 (최근 90일)
- 보호자당 월 조회 횟수: 약 5회 가정
- 총 읽기: 5만명 × 5회 × 1.5명 × 90개 = **3,375만회/월**

**총 읽기 비용:**
- 보호대상자 조회: 4,500만회
- 보호자 조회: 3,375만회
- **총 읽기: 7,875만회/월**

**비용:**
- 무료 할당량: 150만회/월
- 초과분: 7,725만회
- **비용**: (7,725만 / 10만) × $0.03 = **$23.175/월** ≈ **$23.18/월** (약 30,134원)

**증가분**: $21.79/월 (약 28,327원)

---

#### 시나리오 3: 최근 1년 조회

**보호대상자가 기록 화면 조회 시:**
- 365개 문서 읽기 (최근 1년)
- 사용자당 월 조회 횟수: 약 10회 가정
- 총 읽기: 5만명 × 10회 × 365개 = **18,250만회/월**

**보호자가 기록 화면 조회 시:**
- 보호자 5만명 × 평균 1.5명의 보호대상자
- 각 보호대상자당 365개 문서 읽기 (최근 1년)
- 보호자당 월 조회 횟수: 약 5회 가정
- 총 읽기: 5만명 × 5회 × 1.5명 × 365개 = **13,687.5만회/월**

**총 읽기 비용:**
- 보호대상자 조회: 18,250만회
- 보호자 조회: 13,687.5만회
- **총 읽기: 31,937.5만회/월**

**비용:**
- 무료 할당량: 150만회/월
- 초과분: 31,787.5만회
- **비용**: (31,787.5만 / 10만) × $0.03 = **$95.3625/월** ≈ **$95.36/월** (약 123,968원)

**증가분**: $93.97/월 (약 122,161원)

---

## 비용 비교표 (10만명 기준)

| 조회 범위 | 보호대상자 읽기 | 보호자 읽기 | 총 읽기 | 초과분 | 월 비용 (USD) | 월 비용 (KRW) | 증가분 |
|----------|---------------|-----------|---------|--------|--------------|--------------|--------|
| **현재 (7일)** | 350만회 | 262.5만회 | 612.5만회 | 462.5만회 | $1.39 | 1,807원 | - |
| **30일** | 1,500만회 | 1,125만회 | 2,625만회 | 2,475만회 | $7.43 | 9,659원 | +$6.04 |
| **90일** | 4,500만회 | 3,375만회 | 7,875만회 | 7,725만회 | $23.18 | 30,134원 | +$21.79 |
| **1년** | 18,250만회 | 13,687.5만회 | 31,937.5만회 | 31,787.5만회 | $95.36 | 123,968원 | +$93.97 |

---

## 결론

### 저장 비용
- ✅ **변화 없음**: 모든 기록이 이미 저장되고 있음
- 1년 후에도 월 약 620원 수준 (매우 낮음)

### 읽기 비용
- ⚠️ **조회 범위에 비례하여 증가**
- 7일 → 30일: 약 5.3배 증가 ($1.39 → $7.43)
- 7일 → 1년: 약 68.6배 증가 ($1.39 → $95.36)
- **보호자 조회 비용 포함**: 보호자도 기록을 조회하므로 비용이 더 높음

### 권장사항

#### 1. 현재 구조 유지 (최근 7일)
- **장점**: 비용이 매우 낮음 ($1.39/월, 약 1,807원)
- **단점**: 오래된 기록을 볼 수 없음

#### 2. 점진적 확대 (최근 30일)
- **비용**: 월 약 9,659원 (여전히 낮은 수준)
- **장점**: 한 달 단위 패턴 파악 가능
- **단점**: 7일 대비 약 5.3배 비용 증가

#### 3. 스크롤 기반 지연 로딩
- **구조**: 처음에는 7일만 로드, 스크롤 시 추가 로드
- **비용**: 사용자가 실제로 스크롤할 때만 비용 발생
- **장점**: 대부분의 사용자는 7일만 보고, 필요할 때만 추가 조회
- **예상 비용**: 월 약 $1.50-2.50 (1,950-3,250원)

#### 4. 선택적 조회 (권장)
- **구조**: "더 보기" 버튼으로 추가 날짜 조회
- **비용**: 사용자가 명시적으로 요청할 때만 비용 발생
- **예상 비용**: 월 약 $1.60-2.20 (2,080-2,860원)
- **장점**: 
  - 대부분의 사용자는 7일만 조회 (기본 비용 유지)
  - 필요한 사용자만 추가 조회 (비용 효율적)

---

## 최종 권장안

### 옵션 A: 현재 구조 유지 (최근 7일)
- **비용**: 월 $1.39 (1,807원)
- **장점**: 비용 최소화, 단순한 구조

### 옵션 B: 선택적 확대 (7일 기본 + "더 보기" 버튼)
- **기본 비용**: 월 $1.39 (7일 조회)
- **추가 비용**: 사용자가 "더 보기" 클릭 시에만 발생
- **예상 총 비용**: 월 $1.60-2.20 (2,080-2,860원)
- **장점**: 
  - 대부분의 사용자는 기본 비용만 발생
  - 필요한 사용자만 추가 조회
  - 비용 효율적

### 옵션 C: 자동 확대 (최근 30일)
- **비용**: 월 $7.43 (9,659원)
- **장점**: 한 달 단위 패턴 파악 가능
- **단점**: 7일 대비 약 5.3배 비용 증가

---

## 참고사항

1. **저장 비용은 이미 발생 중**: 조회 범위와 무관하게 모든 기록이 저장됨
2. **읽기 비용만 증가**: 조회할 때만 비용 발생
3. **사용자 행동에 따라 달라짐**: 실제 조회 횟수에 따라 비용 변동
4. **무료 할당량 활용**: 월 150만회 무료 할당량 내에서 최대한 활용

---

## 결론

더 많은 날짜를 보려고 하면:
- ✅ **저장 비용**: 변화 없음 (이미 저장 중)
- ⚠️ **읽기 비용**: 조회 범위에 비례하여 증가
- 💡 **권장**: 선택적 확대 (7일 기본 + "더 보기" 버튼)로 비용 효율성 극대화
