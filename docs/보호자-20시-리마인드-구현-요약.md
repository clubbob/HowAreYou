# 매일 반복 로컬 알림 구현 요약 (GPT 검증용)

## 개요

**앱이 백그라운드/종료 상태여도** 매일 정해진 시간에 알림이 뜨도록,  
**서버 비용 0원**(Cloud Functions/FCM/Firestore 스캔 없음)으로 구현합니다.

- **ID 1**: 보호대상자(Subject) — 매일 19:00(KST) "오늘 안부 남겨볼까요?"
- **ID 2**: 보호자(Guardian) — 매일 20:00(KST) "오늘 안부 확인하기"

**기록/확인 여부와 무관하게 무조건 매일 반복** (guardianCheckedDate 등 생략 로직 제거)

**보완 (4가지)**:
- 스케줄 기준: `roles.subjectEnabled` / `roles.guardianEnabled` (둘 다 true면 둘 다 등록)
- 스케줄 호출: auth_service(로그인 시) + _AppLifecycleHandler(포그라운드 복귀) 2곳만
- 둘 다 false면 아무 것도 하지 않음 (취소 안 함)
- SubjectMode/GuardianMode 진입 시 역할 플래그만 설정, 스케줄 호출 안 함

---

## 1. 구현 내용

### 1.1 보호자 로컬 알림 스케줄

| 항목 | 내용 |
|------|------|
| 대상 | 보호자 모드 활성 사용자 |
| 시간 | 매일 20:00 (KST) |
| 문구 | "오늘 안부 확인하기" |
| 방식 | `flutter_local_notifications` (기존 라이브러리) |
| 알림 ID | `2` (보호대상자 7시 알림 id:1과 구분) |

### 1.2 "확인했다"의 정의

- **GuardianDashboardScreen(보호자 목록 화면) 진입** = 오늘 확인 완료
- 상세 화면까지 들어가지 않아도 목록 진입만으로 처리

### 1.3 확인 완료 시 알림 생략

- **SharedPreferences** 키: `guardianCheckedDate` (값: `yyyy-MM-dd`)
- GuardianDashboardScreen `initState`에서 `markGuardianCheckedToday()` 호출
- 오늘 날짜 저장 + id:2 알림 취소

### 1.4 보호자 모드/앱 시작 시 예약/취소

- **GuardianModeScreen** `initState`에서 `scheduleGuardianReminderIfNeeded()` 호출
- **SplashScreen** (앱 시작), **HomeScreen** (Home 진입): `lastSelectedMode == guardian`이면 `scheduleGuardianReminderIfNeeded()` 호출
- → "오늘 보호자 모드 안 들어갔는데 알림이 와야 하는" 케이스 보완
- `guardianCheckedDate == today` → 오늘 20시 알림 취소
- `guardianCheckedDate != today` → 오늘 20시 알림 예약

### 1.5 중복 예약 방지

- 오늘 20:00(KST)이 이미 지났으면 스킵 (내일 예약은 다음 앱 실행에서)
- 예약 직전 `cancel(2)` 후 스케줄 (플러그인/OS별 중복 방지)

### 1.6 KST 날짜 통일

- `lib/utils/korea_date_util.dart`: `todayKoreaStr()`, `nowKorea()` 제공
- `guardianCheckedDate`, `notification_dismissed_date` 등 날짜 저장 시 모두 `todayKoreaStr()` 사용
- 날짜 경계(23:59~00:01)에서 꼬이지 않도록 KST 기준 고정

### 1.7 알림 탭 시 동작

- payload `GUARDIAN_REMINDER` 또는 id `2` → GuardianDashboardScreen으로 이동

---

## 2. 수정/추가된 파일

| 파일 | 변경 내용 |
|------|-----------|
| `lib/utils/korea_date_util.dart` | **신규**. `todayKoreaStr()`, `nowKorea()` - KST 기준 날짜/시각 통일 |
| `lib/services/notification_service.dart` | `guardianReminderNotificationId`, `_keyGuardianCheckedDate`, `isGuardianCheckedToday()`, `markGuardianCheckedToday()`, `scheduleGuardianReminderIfNeeded()` (20시 지남 스킵, cancel(2) 후 예약), 알림 탭 핸들러. `scheduleDailyNotifications`에서 `cancelAll()` → `cancel(1)`로 변경. 날짜는 `todayKoreaStr()` 사용 |
| `lib/screens/guardian_dashboard_screen.dart` | `initState`에 `markGuardianCheckedToday()` 호출. `_loadAndSortCheckSubjects()`, `_SubjectCheckStatus`. 정렬: 기록 없음 → 미기록 최상단 |
| `lib/screens/guardian_mode_screen.dart` | `initState`에 `scheduleGuardianReminderIfNeeded()` 호출 |
| `lib/screens/splash_screen.dart` | 앱 시작 시 `lastSelectedMode == guardian`이면 `scheduleGuardianReminderIfNeeded()` 호출 |
| `lib/screens/home_screen.dart` | Home 진입 시 `lastSelectedMode == guardian`이면 `scheduleGuardianReminderIfNeeded()` 호출 |

---

## 3. 카드 UX 보강 (안부 확인 탭)

| 항목 | 내용 |
|------|------|
| 오늘 기록 | `오늘 기록 ✅` (녹색) / `미기록 ⏳` (주황) |
| 마지막 기록 | `마지막 기록: 오늘` / `1일 전` / `n일 전` / `없음` / `M/d` (7일 이상) |
| 정렬 | **미기록 먼저** → **기록 없음(최상단)** → **오래된 순** (마지막 기록일 기준) |

---

## 4. 검증 포인트 (GPT용)

1. **로직 검증**
   - GuardianModeScreen 진입 → 오늘 미확인이면 20시 알림 예약
   - GuardianDashboardScreen 진입 → `guardianCheckedDate` 저장, 20시 알림 취소
   - 다음날 GuardianModeScreen 진입 → 새 날짜이므로 다시 20시 알림 예약

2. **알림 충돌 방지**
   - 보호대상자 7시 알림 스케줄 시 `cancel(1)`만 사용 → 보호자 8시 알림(id:2) 유지
   - `cancelAll()`은 **로그아웃 시에만** 사용 (auth_service). 알림 예약 경로에는 없음

3. **KST 기준**
   - `todayKoreaStr()`, `nowKorea()` (korea_date_util) 사용. `tz.setLocalLocation(tz.getLocation('Asia/Seoul'))` (NotificationService 초기화 시)

4. **비용**
   - Cloud Functions, Firestore 추가 쿼리, FCM 발송 없음

---

## 5. 한계·의도 정리 (운영 체크포인트)

| 케이스 | 동작 | 비고 |
|--------|------|------|
| **① 20시 이후 첫 실행** | 20시 지났으면 예약 스킵 → 그날 알림 없음 | 의도된 설계. 선택사항: 20시 이후 첫 실행 시 즉시 1회 로컬 알림 |
| **② 폰 재부팅** | 앱 실행 시 `scheduleGuardianReminderIfNeeded()` 재확인 | 그날 앱 미실행 시 알림 없음 = 로컬 알림 한계 |
| **③ 알림 권한 거부** | 보호자/보호대상자 모드 진입 시 상단 배너 표시 | 보호자: "안부 확인 알림", 보호대상자: "컨디션 기록 알림" |

---

## 6. 테스트 시나리오

1. 앱 시작(Splash) 또는 Home 진입 시 `lastSelectedMode == guardian`이면 20시 알림 예약 (보호자 모드 안 들어가도 알림 옴)
2. 보호자 모드 진입 → 20시 알림 예약 확인 (오늘 아직 확인 안 한 경우)
3. GuardianDashboardScreen(안부 확인 탭) 진입 → `guardianCheckedDate` 저장, 20시 알림 취소
4. 같은 날 다시 보호자 모드 진입 → 20시 알림 예약 안 함 (이미 확인)
5. 다음날 앱 시작/보호자 모드 진입 → 20시 알림 다시 예약
6. 20시 알림 탭 → GuardianDashboardScreen으로 이동
7. 안부 확인 탭 카드 → "오늘 기록 ✅/미기록 ⏳", "마지막 기록: n일 전" 표시
8. 목록 정렬 → 미기록 먼저, 기록 없음 최상단, 그다음 오래된 순
9. 알림 권한 거부 상태에서 보호자 모드 진입 → 상단 배너 표시
