# ë¦¬ë§ˆì¸ë“œ í‘¸ì‹œ ì¸ë±ìŠ¤ ë°©ì‹ ë³€ê²½ - ë³€ê²½ì‚¬í•­ ì •ë¦¬

## ğŸ“‹ ëª©ì°¨
1. [Cloud Function ì½”ë“œ diff](#1-cloud-function-ì½”ë“œ-diff)
2. [Firestore í•„ë“œ ë³€ê²½ ë‚´ì—­](#2-firestore-í•„ë“œ-ë³€ê²½-ë‚´ì—­)
3. [ì¸ë±ìŠ¤ ìƒì„± í•„ìš” ëª©ë¡](#3-ì¸ë±ìŠ¤-ìƒì„±-í•„ìš”-ëª©ë¡)
4. [Flutter ì•± ì½”ë“œ ë³€ê²½ ë‚´ì—­](#4-flutter-ì•±-ì½”ë“œ-ë³€ê²½-ë‚´ì—­)

---

## 1. Cloud Function ì½”ë“œ diff

### íŒŒì¼: `functions/index.js`

#### ì¶”ê°€ëœ í•¨ìˆ˜ 1: `sendDailyReminder` (ë¼ì¸ 197-346)

```javascript
/**
 * ë§¤ì¼ 19:00 (Asia/Seoul) ë¦¬ë§ˆì¸ë“œ í‘¸ì‹œ ë°œì†¡
 * ì¸ë±ìŠ¤ ê¸°ë°˜ ì¿¼ë¦¬: nextReminderAt <= now && reminderSentForDate == null
 */
exports.sendDailyReminder = functions.pubsub
  .schedule('0 19 * * *')
  .timeZone('Asia/Seoul')
  .onRun(async (context) => {
    const now = admin.firestore.Timestamp.now();
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    const todayStr = `${year}-${month}-${day}`;
    
    console.log(`[ë¦¬ë§ˆì¸ë“œ í‘¸ì‹œ] ${todayStr} 19:00 ì‹¤í–‰ ì‹œì‘`);
    
    try {
      // ì¸ë±ìŠ¤ ê¸°ë°˜ ì¿¼ë¦¬: ë°œì†¡ ëŒ€ìƒë§Œ ì¡°íšŒ
      const querySnapshot = await admin.firestore()
        .collection('subjects')
        .where('nextReminderAt', '<=', now)
        .where('reminderSentForDate', '==', null)
        .get();
      
      console.log(`[ë¦¬ë§ˆì¸ë“œ í‘¸ì‹œ] ë°œì†¡ ëŒ€ìƒ: ${querySnapshot.size}ëª…`);
      
      if (querySnapshot.empty) {
        console.log('[ë¦¬ë§ˆì¸ë“œ í‘¸ì‹œ] ë°œì†¡ ëŒ€ìƒ ì—†ìŒ');
        return null;
      }
      
      // ë‚´ì¼ 19:00 ê³„ì‚° (Asia/Seoul ê¸°ì¤€)
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      tomorrow.setHours(19, 0, 0, 0);
      const tomorrowTimestamp = admin.firestore.Timestamp.fromDate(tomorrow);
      
      // ê° ì‚¬ìš©ìë³„ë¡œ ì•Œë¦¼ ë°œì†¡ ë° í•„ë“œ ì—…ë°ì´íŠ¸
      const sendPromises = querySnapshot.docs.map(async (doc) => {
        const subjectId = doc.id;
        const subjectData = doc.data();
        
        try {
          // FCM í† í° ì¡°íšŒ (users ì»¬ë ‰ì…˜)
          const userDoc = await admin.firestore().collection('users').doc(subjectId).get();
          if (!userDoc.exists) {
            console.log(`[ë¦¬ë§ˆì¸ë“œ í‘¸ì‹œ] ì‚¬ìš©ì ë¬¸ì„œ ì—†ìŒ: ${subjectId}`);
            return { success: false, reason: 'user_not_found' };
          }
          
          const userData = userDoc.data();
          const tokens = (userData?.fcmTokens || []).filter(Boolean);
          
          if (tokens.length === 0) {
            console.log(`[ë¦¬ë§ˆì¸ë“œ í‘¸ì‹œ] FCM í† í° ì—†ìŒ: ${subjectId}`);
            // í† í°ì´ ì—†ì–´ë„ í•„ë“œëŠ” ì—…ë°ì´íŠ¸í•˜ì—¬ ë‹¤ìŒ ë°œì†¡ ëŒ€ìƒì—ì„œ ì œì™¸
            await doc.ref.update({
              reminderSentForDate: todayStr,
              nextReminderAt: tomorrowTimestamp,
            });
            return { success: false, reason: 'no_tokens' };
          }
          
          // FCM ì•Œë¦¼ ë°œì†¡
          const messagePayload = {
            notification: {
              title: '',
              body: 'ì˜¤ëŠ˜ ì•ˆë¶€ ë‚¨ê²¨ë³¼ê¹Œìš”?',
            },
            data: {
              type: 'DAILY_REMINDER',
              click_action: 'FLUTTER_NOTIFICATION_CLICK',
            },
            android: {
              priority: 'high',
              notification: {
                sound: 'default',
                channelId: 'daily_mood_check',
              },
            },
            apns: {
              payload: {
                aps: {
                  sound: 'default',
                  badge: 1,
                },
              },
            },
            tokens: tokens,
          };
          
          const response = await admin.messaging().sendEachForMulticast(messagePayload);
          console.log(`[ë¦¬ë§ˆì¸ë“œ í‘¸ì‹œ] ${subjectId}: ${response.successCount}ê°œ ì„±ê³µ, ${response.failureCount}ê°œ ì‹¤íŒ¨`);
          
          // Invalid í† í° ì •ë¦¬
          const invalidTokenErrors = new Set([
            'messaging/registration-token-not-registered',
            'messaging/invalid-registration-token',
          ]);
          
          const invalidTokens = [];
          response.responses.forEach((resp, idx) => {
            if (!resp.success && invalidTokenErrors.has(resp.error?.code)) {
              invalidTokens.push(tokens[idx]);
            }
          });
          
          if (invalidTokens.length > 0) {
            await admin.firestore().collection('users').doc(subjectId).update({
              fcmTokens: admin.firestore.FieldValue.arrayRemove(...invalidTokens),
            });
            console.log(`[ë¦¬ë§ˆì¸ë“œ í‘¸ì‹œ] ${subjectId}: Invalid í† í° ${invalidTokens.length}ê°œ ì œê±°`);
          }
          
          // ë°œì†¡ ì„±ê³µ í›„ í•„ë“œ ì—…ë°ì´íŠ¸ (ì¤‘ë³µ ë°œì†¡ ë°©ì§€)
          await doc.ref.update({
            reminderSentForDate: todayStr,
            nextReminderAt: tomorrowTimestamp,
          });
          
          return { success: true, successCount: response.successCount, failureCount: response.failureCount };
        } catch (error) {
          console.error(`[ë¦¬ë§ˆì¸ë“œ í‘¸ì‹œ] ${subjectId} ë°œì†¡ ì˜¤ë¥˜:`, error);
          // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ í•„ë“œëŠ” ì—…ë°ì´íŠ¸í•˜ì—¬ ë¬´í•œ ì¬ì‹œë„ ë°©ì§€
          try {
            await doc.ref.update({
              reminderSentForDate: todayStr,
              nextReminderAt: tomorrowTimestamp,
            });
          } catch (updateError) {
            console.error(`[ë¦¬ë§ˆì¸ë“œ í‘¸ì‹œ] ${subjectId} í•„ë“œ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:`, updateError);
          }
          return { success: false, reason: 'error', error: error.message };
        }
      });
      
      const results = await Promise.all(sendPromises);
      const totalSuccess = results.filter(r => r.success).length;
      const totalFailure = results.filter(r => !r.success).length;
      const totalSent = results.reduce((sum, r) => sum + (r.successCount || 0), 0);
      
      console.log(`[ë¦¬ë§ˆì¸ë“œ í‘¸ì‹œ] ì™„ë£Œ: ${totalSuccess}ëª… ì„±ê³µ, ${totalFailure}ëª… ì‹¤íŒ¨, ì´ ${totalSent}ê°œ ì•Œë¦¼ ë°œì†¡`);
      
      return null;
    } catch (error) {
      console.error('[ë¦¬ë§ˆì¸ë“œ í‘¸ì‹œ] ì „ì²´ ì˜¤ë¥˜:', error);
      return null;
    }
  });
```

**ì£¼ìš” íŠ¹ì§•:**
- Cloud Schedulerë¡œ ë§¤ì¼ 19:00 (Asia/Seoul) ìë™ ì‹¤í–‰
- ì¸ë±ìŠ¤ ê¸°ë°˜ ì¿¼ë¦¬ë¡œ ë°œì†¡ ëŒ€ìƒë§Œ ì¡°íšŒ (ì „ì²´ ìŠ¤ìº” ì œê±°)
- ì¤‘ë³µ ë°œì†¡ ë°©ì§€ ë¡œì§ í¬í•¨
- Invalid FCM í† í° ìë™ ì •ë¦¬

#### ì¶”ê°€ëœ í•¨ìˆ˜ 2: `migrateReminderFields` (ë¼ì¸ 348-437)

```javascript
/**
 * ê¸°ì¡´ ì‚¬ìš©ì ë§ˆì´ê·¸ë ˆì´ì…˜: ë¦¬ë§ˆì¸ë“œ í•„ë“œ ì´ˆê¸°í™”
 * í•œ ë²ˆë§Œ ì‹¤í–‰í•˜ë©´ ë˜ëŠ” ë°°ì¹˜ ì‘ì—… (ìˆ˜ë™ í˜¸ì¶œ)
 */
exports.migrateReminderFields = functions.https.onRequest(async (req, res) => {
  // ë³´ì•ˆ: ê´€ë¦¬ìë§Œ ì‹¤í–‰ ê°€ëŠ¥í•˜ë„ë¡ (ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ì¸ì¦ ì¶”ê°€ í•„ìš”)
  const adminKey = req.query.key;
  if (adminKey !== 'migrate_reminder_2026') {
    res.status(403).send('Unauthorized');
    return;
  }
  
  console.log('[ë§ˆì´ê·¸ë ˆì´ì…˜] ì‹œì‘');
  
  try {
    const now = admin.firestore.Timestamp.now();
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    const todayStr = `${year}-${month}-${day}`;
    
    // ë‚´ì¼ 19:00 ê³„ì‚° (Asia/Seoul ê¸°ì¤€)
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    tomorrow.setHours(19, 0, 0, 0);
    const tomorrowTimestamp = admin.firestore.Timestamp.fromDate(tomorrow);
    
    // ëª¨ë“  subjects ë¬¸ì„œ ì¡°íšŒ (ë°°ì¹˜ ì²˜ë¦¬)
    let batch = admin.firestore().batch();
    let batchCount = 0;
    let migratedCount = 0;
    const batchSize = 500; // Firestore ë°°ì¹˜ ì œí•œ
    
    const subjectsSnapshot = await admin.firestore().collection('subjects').get();
    console.log(`[ë§ˆì´ê·¸ë ˆì´ì…˜] ì „ì²´ subjects ë¬¸ì„œ ìˆ˜: ${subjectsSnapshot.size}`);
    
    for (const doc of subjectsSnapshot.docs) {
      const data = doc.data();
      const needsUpdate = {};
      
      // í•„ë“œê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
      if (!data.nextReminderAt) {
        needsUpdate.nextReminderAt = tomorrowTimestamp;
      }
      if (!data.hasOwnProperty('reminderSentForDate')) {
        needsUpdate.reminderSentForDate = null;
      }
      if (!data.lastResponseAt) {
        needsUpdate.lastResponseAt = null;
      }
      if (!data.lastResponseDate) {
        needsUpdate.lastResponseDate = null;
      }
      
      if (Object.keys(needsUpdate).length > 0) {
        batch.update(doc.ref, needsUpdate);
        batchCount++;
        migratedCount++;
        
        // ë°°ì¹˜ ì œí•œ ë„ë‹¬ ì‹œ ì»¤ë°‹
        if (batchCount >= batchSize) {
          await batch.commit();
          console.log(`[ë§ˆì´ê·¸ë ˆì´ì…˜] ë°°ì¹˜ ì»¤ë°‹: ${migratedCount}ê°œ ë¬¸ì„œ ì²˜ë¦¬`);
          batch = admin.firestore().batch();
          batchCount = 0;
        }
      }
    }
    
    // ë‚¨ì€ ë°°ì¹˜ ì»¤ë°‹
    if (batchCount > 0) {
      await batch.commit();
      console.log(`[ë§ˆì´ê·¸ë ˆì´ì…˜] ìµœì¢… ë°°ì¹˜ ì»¤ë°‹: ${batchCount}ê°œ ë¬¸ì„œ ì²˜ë¦¬`);
    }
    
    console.log(`[ë§ˆì´ê·¸ë ˆì´ì…˜] ì™„ë£Œ: ì´ ${migratedCount}ê°œ ë¬¸ì„œ ë§ˆì´ê·¸ë ˆì´ì…˜`);
    res.status(200).json({
      success: true,
      totalDocuments: subjectsSnapshot.size,
      migratedCount: migratedCount,
    });
  } catch (error) {
    console.error('[ë§ˆì´ê·¸ë ˆì´ì…˜] ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: error.message,
    });
  }
});
```

**ì£¼ìš” íŠ¹ì§•:**
- HTTP í•¨ìˆ˜ë¡œ ìˆ˜ë™ í˜¸ì¶œ ê°€ëŠ¥
- ê¸°ì¡´ ì‚¬ìš©ì ì¤‘ í•„ë“œê°€ ì—†ëŠ” ê²½ìš° ì¼ê´„ ì´ˆê¸°í™”
- ë°°ì¹˜ ì²˜ë¦¬ë¡œ ëŒ€ëŸ‰ ë¬¸ì„œ ì²˜ë¦¬ ì§€ì› (500ê°œì”©)

---

## 2. Firestore í•„ë“œ ë³€ê²½ ë‚´ì—­

### ì»¬ë ‰ì…˜: `subjects/{subjectUid}`

#### ì¶”ê°€ëœ í•„ë“œ

| í•„ë“œëª… | íƒ€ì… | ì„¤ëª… | ê¸°ë³¸ê°’ |
|--------|------|------|--------|
| `lastResponseAt` | `Timestamp` | ë§ˆì§€ë§‰ ì‘ë‹µ ì‹œê° | `null` (ê¸°ë¡ ì—†ìŒ) |
| `lastResponseDate` | `string` | ë§ˆì§€ë§‰ ì‘ë‹µ ë‚ ì§œ (YYYY-MM-DD í˜•ì‹) | `null` (ê¸°ë¡ ì—†ìŒ) |
| `nextReminderAt` | `Timestamp` | ë‹¤ìŒ ë¦¬ë§ˆì¸ë“œ ë°œì†¡ ì‹œê° (Asia/Seoul ê¸°ì¤€ 19:00) | ì‹ ê·œ: ì˜¤ëŠ˜/ë‚´ì¼ 19:00<br>ê¸°ì¡´: `null` (ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”) |
| `reminderSentForDate` | `string \| null` | ë°œì†¡ ì™„ë£Œ ë‚ ì§œ (YYYY-MM-DD í˜•ì‹)<br>`null`ì´ë©´ ë°œì†¡ ê°€ëŠ¥ ìƒíƒœ | `null` (ë°œì†¡ ê°€ëŠ¥) |

#### í•„ë“œ ì—…ë°ì´íŠ¸ ì‹œì 

1. **ì‹ ê·œ ì‚¬ìš©ì ë¡œê·¸ì¸ ì‹œ** (`AuthService._ensureSubjectDocument`)
   ```dart
   {
     'nextReminderAt': Timestamp (ì˜¤ëŠ˜/ë‚´ì¼ 19:00),
     'reminderSentForDate': null,
     'lastResponseAt': null,
     'lastResponseDate': null,
   }
   ```

2. **ì»¨ë””ì…˜ ê¸°ë¡ ì‹œ** (`MoodService.saveMoodResponse`)
   ```dart
   {
     'lastResponseAt': Timestamp (í˜„ì¬ ì‹œê°),
     'lastResponseDate': string (ì˜¤ëŠ˜ ë‚ ì§œ YYYY-MM-DD),
     'reminderSentForDate': string (ì˜¤ëŠ˜ ë‚ ì§œ YYYY-MM-DD), // ì˜¤ëŠ˜ ë°œì†¡ ì™„ë£Œ
     'nextReminderAt': Timestamp (ë‚´ì¼ 19:00),
   }
   ```

3. **19:00 ë¦¬ë§ˆì¸ë“œ ë°œì†¡ í›„** (`sendDailyReminder`)
   ```javascript
   {
     'reminderSentForDate': string (ì˜¤ëŠ˜ ë‚ ì§œ YYYY-MM-DD),
     'nextReminderAt': Timestamp (ë‚´ì¼ 19:00),
   }
   ```

#### ê¸°ì¡´ í•„ë“œ (ë³€ê²½ ì—†ìŒ)

- `displayName`: string
- `phone`: string
- `pairedGuardianUids`: string[]
- `guardianInfos`: object

---

## 3. ì¸ë±ìŠ¤ ìƒì„± í•„ìš” ëª©ë¡

### í•„ìˆ˜ ì¸ë±ìŠ¤ (1ê°œ)

#### ì¸ë±ìŠ¤ 1: ë¦¬ë§ˆì¸ë“œ í‘¸ì‹œ ì¿¼ë¦¬ìš© ë³µí•© ì¸ë±ìŠ¤

**ì»¬ë ‰ì…˜**: `subjects`

**í•„ë“œ êµ¬ì„±**:
```
Field 1: nextReminderAt (Ascending)
Field 2: reminderSentForDate (Ascending)
```

**ì¿¼ë¦¬ ë²”ìœ„**: Collection

**ì‚¬ìš© ì¿¼ë¦¬**:
```javascript
admin.firestore()
  .collection('subjects')
  .where('nextReminderAt', '<=', now)
  .where('reminderSentForDate', '==', null)
```

**ìƒì„± ë°©ë²•**:
1. Firebase Console ì ‘ì†
2. Firestore Database â†’ Indexes íƒ­
3. "Create Index" í´ë¦­
4. Collection ID: `subjects` ì…ë ¥
5. Fields ì¶”ê°€:
   - `nextReminderAt` â†’ Ascending ì„ íƒ
   - `reminderSentForDate` â†’ Ascending ì„ íƒ
6. Query scope: Collection ì„ íƒ
7. "Create" í´ë¦­

**ì˜ˆìƒ ìƒì„± ì‹œê°„**: ëª‡ ë¶„ ~ ëª‡ ì‹œê°„ (ë°ì´í„° ì–‘ì— ë”°ë¼ ë‹¤ë¦„)

**ì£¼ì˜ì‚¬í•­**:
- ì¸ë±ìŠ¤ ìƒì„± ì™„ë£Œ ì „ê¹Œì§€ëŠ” `sendDailyReminder` í•¨ìˆ˜ê°€ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ë°°í¬ ì „ì— ë¯¸ë¦¬ ìƒì„±í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.
- ì¸ë±ìŠ¤ ìƒì„± ìƒíƒœëŠ” Firebase Consoleì—ì„œ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.

---

## 4. Flutter ì•± ì½”ë“œ ë³€ê²½ ë‚´ì—­

### íŒŒì¼ 1: `lib/services/mood_service.dart`

#### ë³€ê²½ ë‚´ìš©: `saveMoodResponse()` ë©”ì„œë“œ í™•ì¥

**ì¶”ê°€ëœ ì½”ë“œ** (ë¼ì¸ 50-66):
```dart
// ë¦¬ë§ˆì¸ë“œ í•„ë“œ ì—…ë°ì´íŠ¸: ê¸°ë¡í•˜ë©´ ì˜¤ëŠ˜ ë¦¬ë§ˆì¸ë“œ ëŒ€ìƒì—ì„œ ì¦‰ì‹œ ì œì™¸
final nowKorea = tz.TZDateTime.now(tz.getLocation('Asia/Seoul'));
final tomorrow = tz.TZDateTime(
  tz.getLocation('Asia/Seoul'),
  nowKorea.year,
  nowKorea.month,
  nowKorea.day + 1,
  19,
  0,
);

await _firestore.collection('subjects').doc(subjectId).update({
  'lastResponseAt': Timestamp.fromDate(now),
  'lastResponseDate': dateStr,
  'reminderSentForDate': dateStr, // ì˜¤ëŠ˜ ë°œì†¡ ì™„ë£Œë¡œ í‘œì‹œ
  'nextReminderAt': Timestamp.fromDate(tomorrow.toUtc()), // ë‚´ì¼ 19:00ìœ¼ë¡œ ì„¤ì • (UTC ë³€í™˜)
});
```

**ë³€ê²½ ì‚¬í•­ ìš”ì•½**:
- ì»¨ë””ì…˜ ì €ì¥ ì„±ê³µ ì‹œ `subjects/{subjectUid}` ë¬¸ì„œì˜ ë¦¬ë§ˆì¸ë“œ í•„ë“œ ìë™ ì—…ë°ì´íŠ¸
- ê¸°ë¡ ì™„ë£Œ ì‹œ ì˜¤ëŠ˜ ë¦¬ë§ˆì¸ë“œ ëŒ€ìƒì—ì„œ ì¦‰ì‹œ ì œì™¸

### íŒŒì¼ 2: `lib/services/auth_service.dart`

#### ë³€ê²½ ë‚´ìš© 1: Import ì¶”ê°€

**ì¶”ê°€ëœ import** (ë¼ì¸ 6):
```dart
import 'package:timezone/timezone.dart' as tz;
```

#### ë³€ê²½ ë‚´ìš© 2: `verifyOTP()` ë©”ì„œë“œ ìˆ˜ì •

**ì¶”ê°€ëœ ì½”ë“œ** (ë¼ì¸ 113):
```dart
await _ensureSubjectDocument(user.uid);
debugPrint('verifyOTP: ë³´í˜¸ëŒ€ìƒì ë¬¸ì„œ í™•ë³´ ì™„ë£Œ');
```

#### ë³€ê²½ ë‚´ìš© 3: `_ensureSubjectDocument()` ë©”ì„œë“œ ì¶”ê°€ (ì „ì²´ ì‹ ê·œ)

**ì¶”ê°€ëœ ë©”ì„œë“œ** (ë¼ì¸ 217-271):
```dart
/// subjects ë¬¸ì„œ ì´ˆê¸°í™” ë° ë¦¬ë§ˆì¸ë“œ í•„ë“œ ì„¤ì •
/// ì‹ ê·œ ì‚¬ìš©ì: nextReminderAtì„ ì˜¤ëŠ˜/ë‚´ì¼ 19:00ìœ¼ë¡œ ì„¤ì •
/// ê¸°ì¡´ ì‚¬ìš©ì: í•„ë“œê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
Future<void> _ensureSubjectDocument(String uid) async {
  try {
    final subjectRef = _firestore.collection('subjects').doc(uid);
    final doc = await subjectRef.get();
    
    // í˜„ì¬ ì‹œê°„ (Asia/Seoul ê¸°ì¤€)
    final now = tz.TZDateTime.now(tz.getLocation('Asia/Seoul'));
    final today = DateTime(now.year, now.month, now.day);
    final todayStr = '${now.year.toString().padLeft(4, '0')}-${now.month.toString().padLeft(2, '0')}-${now.day.toString().padLeft(2, '0')}';
    
    // 19:00 ì´ì „ì´ë©´ ì˜¤ëŠ˜ 19:00, ì´í›„ë©´ ë‚´ì¼ 19:00
    final reminderTime = now.hour < 19
        ? tz.TZDateTime(tz.getLocation('Asia/Seoul'), now.year, now.month, now.day, 19, 0)
        : tz.TZDateTime(tz.getLocation('Asia/Seoul'), now.year, now.month, now.day + 1, 19, 0);
    
    if (!doc.exists) {
      // ì‹ ê·œ ì‚¬ìš©ì: subjects ë¬¸ì„œ ìƒì„± ë° ë¦¬ë§ˆì¸ë“œ í•„ë“œ ì´ˆê¸°í™”
      await subjectRef.set({
        'nextReminderAt': Timestamp.fromDate(reminderTime),
        'reminderSentForDate': null,
        'lastResponseAt': null,
        'lastResponseDate': null,
      }, SetOptions(merge: true));
      debugPrint('_ensureSubjectDocument: ì‹ ê·œ ì‚¬ìš©ì subjects ë¬¸ì„œ ìƒì„± ì™„ë£Œ');
    } else {
      // ê¸°ì¡´ ì‚¬ìš©ì: í•„ë“œê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
      final data = doc.data();
      final needsUpdate = <String, dynamic>{};
      
      if (data == null || !data.containsKey('nextReminderAt')) {
        needsUpdate['nextReminderAt'] = Timestamp.fromDate(reminderTime);
      }
      if (data == null || !data.containsKey('reminderSentForDate')) {
        needsUpdate['reminderSentForDate'] = null;
      }
      if (data == null || !data.containsKey('lastResponseAt')) {
        needsUpdate['lastResponseAt'] = null;
      }
      if (data == null || !data.containsKey('lastResponseDate')) {
        needsUpdate['lastResponseDate'] = null;
      }
      
      if (needsUpdate.isNotEmpty) {
        await subjectRef.update(needsUpdate);
        debugPrint('_ensureSubjectDocument: ê¸°ì¡´ ì‚¬ìš©ì í•„ë“œ ì´ˆê¸°í™” ì™„ë£Œ');
      }
    }
  } catch (e) {
    debugPrint('_ensureSubjectDocument ì˜¤ë¥˜: $e');
    // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ë¡œê·¸ì¸ í”Œë¡œìš°ëŠ” ê³„ì† ì§„í–‰
  }
}
```

**ë³€ê²½ ì‚¬í•­ ìš”ì•½**:
- ë¡œê·¸ì¸ ì‹œ `subjects` ë¬¸ì„œ ìë™ ì´ˆê¸°í™”
- ì‹ ê·œ ì‚¬ìš©ì: ë¦¬ë§ˆì¸ë“œ í•„ë“œ ì´ˆê¸°ê°’ ì„¤ì •
- ê¸°ì¡´ ì‚¬ìš©ì: í•„ë“œê°€ ì—†ìœ¼ë©´ ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜

---

## nextReminderAt ì´ˆê¸°ê°’ ì„¸íŒ… ê·œì¹™

**ì‹ ê·œ ê°€ì… / subject ë¬¸ì„œ ìƒì„± ì‹œ** ë°˜ë“œì‹œ ì•„ë˜ ê·œì¹™ìœ¼ë¡œ `nextReminderAt`ì„ ì„¤ì •í•œë‹¤.

| ì¡°ê±´ | nextReminderAt |
|------|----------------|
| í˜„ì¬ ì‹œê°„ì´ **19:00 ì´ì „** (KST) | **ì˜¤ëŠ˜ 19:00** |
| í˜„ì¬ ì‹œê°„ì´ **19:00 ì´í›„** (KST) | **ë‚´ì¼ 19:00** |

**ì ìš© ìœ„ì¹˜**:
- `auth_service._ensureSubjectDocument`: ë¡œê·¸ì¸ ì‹œ subjects ë¬¸ì„œ ìƒì„±/ì´ˆê¸°í™”
- `guardian_service.addMeAsGuardianToSubject`: ë³´í˜¸ìê°€ ì „í™”ë²ˆí˜¸ë¡œ ëŒ€ìƒì ì¶”ê°€ ì‹œ (ë¬¸ì„œ ì‹ ê·œ ìƒì„±)
- `guardian_service.acceptInviteAsGuardian`: ì´ˆëŒ€ ë§í¬ë¡œ ë³´í˜¸ì ì—°ê²° ì‹œ (ë¬¸ì„œ ì‹ ê·œ ìƒì„±)
- `guardian_service.acceptInviteAsSubject`: ì´ˆëŒ€ ë§í¬ë¡œ ëŒ€ìƒì ì—°ê²° ì‹œ (ë¬¸ì„œ ì‹ ê·œ ìƒì„±)
- `functions.processPendingInvitesOnSignup`: ëŒ€ê¸° ì´ˆëŒ€ ê°€ì… ì‹œ ìë™ ì—°ê²° (ë¬¸ì„œ ì‹ ê·œ ìƒì„±)

ì´ ì´ˆê¸°ê°’ì´ ì—†ìœ¼ë©´ ì²«ë‚  ë¦¬ë§ˆì¸ë“œê°€ ì•ˆ ê°€ê±°ë‚˜ ë°”ë¡œ ê°€ëŠ” ë“± ì‚¬ìš©ìë³„ë¡œ ë™ì‘ì´ ë’¤ì£½ë°•ì£½ì´ ëœë‹¤.

---

## ğŸ“ ë°°í¬ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ì‚¬ì „ ì‘ì—…
- [ ] Firestore ì¸ë±ìŠ¤ ìƒì„± ì™„ë£Œ í™•ì¸
- [ ] ê¸°ì¡´ ì‚¬ìš©ì ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš” ì—¬ë¶€ í™•ì¸

### ë°°í¬ ìˆœì„œ
1. [ ] Flutter ì•± ì½”ë“œ ë°°í¬
2. [ ] Cloud Functions ë°°í¬ (`firebase deploy --only functions`)
3. [ ] ë§ˆì´ê·¸ë ˆì´ì…˜ í•¨ìˆ˜ ì‹¤í–‰ (ê¸°ì¡´ ì‚¬ìš©ì ìˆëŠ” ê²½ìš°)
   ```
   https://[region]-[project-id].cloudfunctions.net/migrateReminderFields?key=migrate_reminder_2026
   ```
4. [ ] `sendDailyReminder` í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ (ìˆ˜ë™ íŠ¸ë¦¬ê±° ë˜ëŠ” ë‹¤ìŒ 19:00 ëŒ€ê¸°)

### ë°°í¬ í›„ í™•ì¸
- [ ] ì‹ ê·œ ì‚¬ìš©ì ë¡œê·¸ì¸ ì‹œ `subjects` ë¬¸ì„œ í•„ë“œ ì´ˆê¸°í™” í™•ì¸
- [ ] ì»¨ë””ì…˜ ê¸°ë¡ ì‹œ ë¦¬ë§ˆì¸ë“œ í•„ë“œ ì—…ë°ì´íŠ¸ í™•ì¸
- [ ] 19:00 ë¦¬ë§ˆì¸ë“œ í‘¸ì‹œ ì •ìƒ ë°œì†¡ í™•ì¸
- [ ] ê¸°ë¡ ì™„ë£Œ ì‹œ ë¦¬ë§ˆì¸ë“œ ëŒ€ìƒì—ì„œ ì œì™¸ í™•ì¸

---

## ğŸ”„ ë¡¤ë°± ë°©ë²•

ë¬¸ì œ ë°œìƒ ì‹œ ë¡¤ë°± ì ˆì°¨:

1. **Cloud Function ë¹„í™œì„±í™”**
   ```bash
   firebase functions:delete sendDailyReminder
   ```

2. **Flutter ì•± ì½”ë“œ ë¡¤ë°±**
   - `MoodService.saveMoodResponse()`ì—ì„œ ë¦¬ë§ˆì¸ë“œ í•„ë“œ ì—…ë°ì´íŠ¸ ì½”ë“œ ì œê±°
   - `AuthService._ensureSubjectDocument()` í˜¸ì¶œ ì œê±°

3. **ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ ë³µêµ¬**
   - ì „ì²´ ìŠ¤ìº” ë°©ì‹ì˜ ë¦¬ë§ˆì¸ë“œ í‘¸ì‹œ í•¨ìˆ˜ë¡œ êµì²´
