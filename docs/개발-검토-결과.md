# 개발 검토 결과 및 개선 필요 사항

## ✅ 완료된 기능

1. **인증 시스템**
   - ✅ 전화번호 OTP 로그인 (Firebase Auth)
   - ✅ 사용자 모델 및 서비스

2. **일상 알림**
   - ✅ 로컬 알림 3회 스케줄링 (아침 08:00, 점심 12:00, 저녁 18:00)
   - ✅ 알림 탭 시 질문 화면으로 이동

3. **질문 및 응답**
   - ✅ 질문 화면 UI
   - ✅ 응답 저장 (Firestore)
   - ✅ 응답 완료 후 감사 메시지

4. **보호자 관리**
   - ✅ 보호자 지정 화면
   - ✅ 보호자 추가/수정/삭제
   - ✅ 보호자 대시보드 (보호 대상 목록, 상세 화면)
   - ✅ 최근 7일 응답 이력 표시
   - ✅ 추세 그래프

5. **FCM 기본 설정**
   - ✅ FCM 토큰 저장
   - ✅ 알림 권한 요청
   - ⚠️ 실제 푸시 알림 발송 기능 없음

---

## ❌ 누락된 핵심 기능 (PRD 기준)

### 1. 미회신 판단 로직 (최우선)

**PRD 요구사항:**
- Day 1: 아침 ❌ / 점심 ❌ / 저녁 ❌
- Day 2: 아침 ❌
- **Day 2 점심(12:00)에 1회 판정**
- 조건 충족 시 지정자에게 알림 발송

**현재 상태:**
- ❌ 미회신 판단 로직 없음
- ❌ Cloud Functions 폴더 없음
- ❌ Scheduler 설정 없음

**필요 작업:**
1. `functions/` 폴더 생성 및 Cloud Functions 프로젝트 초기화
2. 미회신 판단 함수 작성 (매일 12:00 실행)
3. Cloud Scheduler 설정 (Asia/Seoul 시간대, 매일 12:00)
4. Firestore에서 응답 여부 확인 로직 구현

**예상 파일:**
```
functions/
  ├── index.js (또는 TypeScript)
  ├── package.json
  └── src/
      └── checkUnreachable.ts
```

---

### 2. 지정자 알림 발송 기능

**PRD 요구사항:**
- 미회신 판단 후 지정자에게 FCM 푸시 알림 발송
- 알림 문구: "OO님과 연락이 닿지 않고 있어요."
- 알림 클릭 시 앱에서 해당 메시지 표시

**현재 상태:**
- ✅ FCM 서비스 기본 구조 있음 (`fcm_service.dart`)
- ❌ 실제 알림 발송 메서드 없음
- ❌ Cloud Functions에서 FCM Admin SDK 사용 코드 없음

**필요 작업:**
1. Cloud Functions에 FCM Admin SDK 추가
2. 지정자 FCM 토큰 조회 로직
3. 푸시 알림 발송 함수 작성
4. 앱에서 알림 수신 처리 (백그라운드/포그라운드)

---

### 3. 질문 화면 이모지 개수 불일치

**PRD 요구사항:**
- 5개 이모지: 😊 좋아, 🙂 괜찮아, 😐 보통, 🙁 별로, 😞 힘들어

**현재 상태:**
- ❌ `Mood` enum에 3개만 있음 (good, normal, bad)
- ❌ PRD의 5개 이모지와 불일치

**필요 작업:**
1. `Mood` enum을 5개로 확장:
   ```dart
   enum Mood {
     good(emoji: '😊', label: '좋아', value: 1),
     okay(emoji: '🙂', label: '괜찮아', value: 2),
     normal(emoji: '😐', label: '보통', value: 3),
     bad(emoji: '🙁', label: '별로', value: 4),
     hard(emoji: '😞', label: '힘들어', value: 5);
   }
   ```
2. `question_screen.dart`에서 5개 이모지 표시
3. 기존 데이터 호환성 유지 (1=좋아, 2=괜찮아/보통, 3=안좋아 등)

---

### 4. "힘들어" 선택 시 필수 입력

**PRD 요구사항:**
- 😞 선택 시: "어떤 게 힘드세요?" 텍스트 입력창 **필수 표시**
- 입력은 선택 사항이지만 입력창은 반드시 표시

**현재 상태:**
- ⚠️ `question_screen.dart`에서 모든 선택 시 입력창 표시 (조건부)
- ❌ "힘들어" 선택 시에만 입력창 표시하도록 변경 필요

**필요 작업:**
1. `question_screen.dart`에서 `_selectedMood == Mood.hard`일 때만 입력창 표시
2. 입력창 라벨: "어떤 게 힘드세요?" (PRD 명시)

---

### 5. Firestore 컬렉션 구조 확인

**PRD 요구사항:**
- `/alerts/{alertId}` 컬렉션 필요
  - type: UNREACHABLE
  - subjectId
  - guardianUids[]
  - triggerDate
  - triggeredAt

**현재 상태:**
- ❌ alerts 컬렉션 사용 코드 없음
- ⚠️ Cloud Functions에서 생성해야 함

**필요 작업:**
- Cloud Functions에서 미회신 판단 시 alerts 문서 생성

---

## ⚠️ 개선 권장 사항

### 1. 보호자 대시보드 (PRD 비범위)

**현재 상태:**
- ✅ 보호자 대시보드 구현됨 (`guardian_dashboard_screen.dart`)
- ⚠️ PRD에서는 "비범위"로 명시됨

**권장:**
- PRD 업데이트 또는 기능 유지 결정 필요

---

### 2. 에러 처리 강화

**현재 상태:**
- ⚠️ 일부 try-catch 있으나 일관성 부족
- ⚠️ 네트워크 오류 처리 부족

**권장:**
- 공통 에러 핸들러 추가
- 오프라인 상태 처리

---

### 3. 테스트 코드

**현재 상태:**
- ❌ 단위 테스트 없음
- ❌ 통합 테스트 없음

**권장:**
- MoodService, GuardianService 등 핵심 로직 테스트 추가

---

## 📋 우선순위별 작업 목록

### 🔴 최우선 (MVP 완성을 위해 필수)

1. **Cloud Functions 프로젝트 생성 및 미회신 판단 로직 구현**
   - 예상 시간: 4-6시간
   - 파일: `functions/index.ts`, `functions/src/checkUnreachable.ts`

2. **지정자 알림 발송 기능 구현**
   - 예상 시간: 2-3시간
   - 파일: `functions/src/sendGuardianAlert.ts`, `lib/services/fcm_service.dart` 수정

3. **질문 화면 이모지 5개로 확장**
   - 예상 시간: 1-2시간
   - 파일: `lib/models/mood_response_model.dart`, `lib/screens/question_screen.dart`

4. **"힘들어" 선택 시 필수 입력창 표시**
   - 예상 시간: 30분
   - 파일: `lib/screens/question_screen.dart`

### 🟡 중요 (사용자 경험 개선)

5. 에러 처리 강화
6. 오프라인 상태 처리
7. 로딩 상태 UI 개선

### 🟢 선택 (장기 개선)

8. 단위 테스트 작성
9. 통합 테스트 작성
10. 성능 최적화

---

## 📝 다음 단계

1. **Cloud Functions 프로젝트 초기화**
   ```bash
   cd functions
   npm init -y
   npm install firebase-functions firebase-admin
   ```

2. **미회신 판단 함수 작성**
   - 매일 12:00 실행
   - Day 1 + Day 2 아침 미회신 확인
   - 조건 충족 시 지정자에게 알림 발송

3. **앱에서 알림 수신 처리**
   - 백그라운드 메시지 핸들러 업데이트
   - 알림 탭 시 "연락이 닿지 않음" 화면 표시

4. **질문 화면 수정**
   - 5개 이모지로 확장
   - "힘들어" 선택 시 필수 입력창 표시

---

## 참고

- PRD 문서: `HowAreYou_PRD_v1.0.md`
- 현재 구현 상태는 대부분 완료되었으나, **미회신 판단 및 알림 발송** 기능이 핵심 누락 사항입니다.
- Cloud Functions는 별도 배포가 필요하며, Firebase Console에서 설정해야 합니다.
