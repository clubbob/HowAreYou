# 📌 Cursor 개발 지시문: 3일 무응답 시 보호자 알림 1회

## 🎯 목적
현재는 "기록 시 보호자 알림"만 구현되어 있다. 여기에 3일 연속 무응답 시 보호자에게 경고 푸시 1회 발송 기능을 추가한다.

---

## 1️⃣ 기본 규칙

- 보호대상자가 3일 연속 기록을 남기지 않으면 → 보호자에게 푸시 1회 발송
- 1~2일 무응답은 아무 알림 없음
- 3일째 되는 날 딱 1회만 발송
- 이후 계속 무응답이어도 추가 발송 없음
- 보호대상자가 다시 기록을 남기면 → 연속 무응답 카운트 0으로 초기화 → 이후 다시 3일 무응답이 되면 다시 1회 발송

---

## 2️⃣ 서버 기준

- 날짜 계산은 반드시 **서버 시간 기준**
- 타임존은 **Asia/Seoul** 기준
- 클라이언트 시간 사용 금지

---

## 3️⃣ 데이터 구조 요구사항

`subjects/{subjectUid}` 문서에 다음 필드 추가:

| 필드 | 타입 | 설명 |
|------|------|------|
| `consecutiveMissedDays` | number | 연속 무응답 일수 |
| `lastEscalationNotifiedAt` | timestamp | 마지막 경고 발송 시각 (nullable) |

`lastResponseDate` 필드 기존 활용.

---

## 4️⃣ 실행 방식

- 하루 1회 스케줄러 함수로 전체 대상 평가
- 리마인드 함수와 분리하여 **별도 평가 함수**로 구현
- **19:10 (Asia/Seoul)** 실행 권장

---

## 5️⃣ 로직 조건

```
if (lastResponseDate == today)
    consecutiveMissedDays = 0
else
    consecutiveMissedDays += 1

if (consecutiveMissedDays == 3)
    보호자에게 푸시 발송
```

**중요:**
- 조건은 반드시 `== 3` 사용
- `>= 3` 사용 금지 (중복 발송 방지)

---

## 6️⃣ 푸시 문구

- **제목:** (앱 이름)
- **내용:** "○○님이 3일째 안부를 남기지 않았습니다. 확인이 필요합니다."
- **이름 포함 필수** (보호대상자 displayName 사용)

---

## 7️⃣ 안정성 조건

- 중복 발송 방지: 발송 시 `lastEscalationNotifiedAt = today` 저장
- 발송 전 `lastEscalationNotifiedAt == today`이면 스킵 (서버 재실행 시 중복 방지)

---

## 8️⃣ 컨디션 기록 시 업데이트

보호대상자가 컨디션 저장 시 `subjects` 문서에 다음 필드 업데이트:

- `consecutiveMissedDays = 0`
- `lastResponseDate = today`
- `lastResponseAt = now`

---

## 9️⃣ 완료 기준 (테스트 시나리오)

| 시나리오 | 기대 결과 |
|----------|-----------|
| Day 0 기록 | 정상 |
| Day 1 무응답 | 알림 없음 |
| Day 2 무응답 | 알림 없음 |
| Day 3 무응답 | 보호자 푸시 1회 |
| Day 4 무응답 | 추가 푸시 없음 |
| Day 5 기록 | 카운트 초기화 |
| 이후 다시 3일 무응답 | 다시 1회 발송 |
