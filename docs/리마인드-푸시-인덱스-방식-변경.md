# 19:00 ë¦¬ë§ˆì¸ë“œ í‘¸ì‹œ ì¸ë±ìŠ¤ ë°©ì‹ ë³€ê²½ ì™„ë£Œ

## ğŸ“Œ ë³€ê²½ ëª©ì 
ì „ì²´ ìŠ¤ìº” ë°©ì‹ì—ì„œ ì¸ë±ìŠ¤ ê¸°ë°˜ ì¿¼ë¦¬ ë°©ì‹ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ í™•ì¥ì„± ë¬¸ì œ í•´ê²° ë° Firestore ë¹„ìš© ì ˆê°.

## âœ… ì™„ë£Œëœ ì‘ì—…

### 1. ë°ì´í„° ëª¨ë¸ í™•ì¥
`subjects/{subjectUid}` ë¬¸ì„œì— ë‹¤ìŒ í•„ë“œ ì¶”ê°€:
- `lastResponseAt`: Timestamp - ë§ˆì§€ë§‰ ì‘ë‹µ ì‹œê°
- `lastResponseDate`: string (YYYY-MM-DD) - ë§ˆì§€ë§‰ ì‘ë‹µ ë‚ ì§œ
- `nextReminderAt`: Timestamp - ë‹¤ìŒ ë¦¬ë§ˆì¸ë“œ ë°œì†¡ ì‹œê°
- `reminderSentForDate`: string | null - ë°œì†¡ ì™„ë£Œ ë‚ ì§œ (nullì´ë©´ ë°œì†¡ ê°€ëŠ¥)

### 2. ì»¨ë””ì…˜ ì €ì¥ ì‹œ ì—…ë°ì´íŠ¸ ë¡œì§
**íŒŒì¼**: `lib/services/mood_service.dart`
- `saveMoodResponse()` ë©”ì„œë“œì— ë¦¬ë§ˆì¸ë“œ í•„ë“œ ì—…ë°ì´íŠ¸ ì¶”ê°€
- ê¸°ë¡ ì„±ê³µ ì‹œ:
  - `lastResponseAt` = í˜„ì¬ ì‹œê°
  - `lastResponseDate` = ì˜¤ëŠ˜ ë‚ ì§œ (YYYY-MM-DD)
  - `reminderSentForDate` = ì˜¤ëŠ˜ ë‚ ì§œ (ì˜¤ëŠ˜ ë°œì†¡ ì™„ë£Œë¡œ í‘œì‹œ)
  - `nextReminderAt` = ë‚´ì¼ 19:00 (Asia/Seoul)

### 3. ì‹ ê·œ ì‚¬ìš©ì ì´ˆê¸°í™”
**íŒŒì¼**: `lib/services/auth_service.dart`
- `_ensureSubjectDocument()` ë©”ì„œë“œ ì¶”ê°€
- ë¡œê·¸ì¸ ì‹œ `subjects` ë¬¸ì„œ ìë™ ì´ˆê¸°í™”
- í˜„ì¬ ì‹œê°„ì´ 19:00 ì´ì „ì´ë©´ ì˜¤ëŠ˜ 19:00, ì´í›„ë©´ ë‚´ì¼ 19:00ìœ¼ë¡œ `nextReminderAt` ì„¤ì •
- ê¸°ì¡´ ì‚¬ìš©ìë„ í•„ë“œê°€ ì—†ìœ¼ë©´ ìë™ ì´ˆê¸°í™” (ë§ˆì´ê·¸ë ˆì´ì…˜)

### 4. Cloud Function ì¸ë±ìŠ¤ ê¸°ë°˜ ì¿¼ë¦¬
**íŒŒì¼**: `functions/index.js`
- `sendDailyReminder` í•¨ìˆ˜ ì¶”ê°€ (ë§¤ì¼ 19:00 Asia/Seoul ìŠ¤ì¼€ì¤„)
- **ì¿¼ë¦¬ ì¡°ê±´**:
  ```javascript
  .where('nextReminderAt', '<=', now)
  .where('reminderSentForDate', '==', null)
  ```
- ë°œì†¡ ì„±ê³µ í›„ í•„ë“œ ì—…ë°ì´íŠ¸:
  - `reminderSentForDate` = ì˜¤ëŠ˜ ë‚ ì§œ
  - `nextReminderAt` = ë‚´ì¼ 19:00
- ì¤‘ë³µ ë°œì†¡ ë°©ì§€ ë¡œì§ í¬í•¨
- Invalid FCM í† í° ìë™ ì •ë¦¬

### 5. ë§ˆì´ê·¸ë ˆì´ì…˜ ìœ í‹¸ë¦¬í‹°
**íŒŒì¼**: `functions/index.js`
- `migrateReminderFields` HTTP í•¨ìˆ˜ ì¶”ê°€
- ê¸°ì¡´ ì‚¬ìš©ì ì¤‘ í•„ë“œê°€ ì—†ëŠ” ê²½ìš° ì¼ê´„ ì´ˆê¸°í™”
- ë°°ì¹˜ ì²˜ë¦¬ë¡œ ëŒ€ëŸ‰ ë¬¸ì„œ ì²˜ë¦¬ ì§€ì›

## ğŸ”§ Firestore ì¸ë±ìŠ¤ ìƒì„± (í•„ìˆ˜)

ë‹¤ìŒ ë³µí•© ì¸ë±ìŠ¤ë¥¼ Firebase Consoleì—ì„œ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤:

### ì¸ë±ìŠ¤ ìƒì„± ë°©ë²•
1. Firebase Console â†’ Firestore Database â†’ Indexes íƒ­
2. "Create Index" í´ë¦­
3. Collection ID: `subjects`
4. Fields ì¶”ê°€:
   - `nextReminderAt` (Ascending)
   - `reminderSentForDate` (Ascending)
5. Query scope: Collection
6. "Create" í´ë¦­

### ì¸ë±ìŠ¤ ìƒì„¸ ì •ë³´
```
Collection: subjects
Fields:
  - nextReminderAt: Ascending
  - reminderSentForDate: Ascending
Query scope: Collection
```

**ì°¸ê³ **: ì¸ë±ìŠ¤ ìƒì„±ì€ ëª‡ ë¶„ì—ì„œ ëª‡ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìƒì„± ì™„ë£Œ ì „ê¹Œì§€ëŠ” ì¿¼ë¦¬ê°€ ì‹¤íŒ¨í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ë°°í¬ ì „ì— ë¯¸ë¦¬ ìƒì„±í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.

## ğŸ“Š ë™ì‘ íë¦„

### ì‹ ê·œ ì‚¬ìš©ì
1. ë¡œê·¸ì¸ ì„±ê³µ â†’ `_ensureSubjectDocument()` ì‹¤í–‰
2. `subjects/{uid}` ë¬¸ì„œ ìƒì„±
3. `nextReminderAt` = ì˜¤ëŠ˜/ë‚´ì¼ 19:00 ì„¤ì •
4. `reminderSentForDate` = null

### ì»¨ë””ì…˜ ê¸°ë¡ ì‹œ
1. `saveMoodResponse()` ì‹¤í–‰
2. `prompts/{date}` ë¬¸ì„œ ì €ì¥
3. `subjects/{uid}` ë¬¸ì„œ ì—…ë°ì´íŠ¸:
   - `lastResponseAt` = now
   - `lastResponseDate` = today
   - `reminderSentForDate` = today (ì˜¤ëŠ˜ ë°œì†¡ ì™„ë£Œ)
   - `nextReminderAt` = tomorrow 19:00

### 19:00 ë¦¬ë§ˆì¸ë“œ ë°œì†¡
1. Cloud Schedulerê°€ `sendDailyReminder` í•¨ìˆ˜ íŠ¸ë¦¬ê±°
2. ì¸ë±ìŠ¤ ê¸°ë°˜ ì¿¼ë¦¬ë¡œ ë°œì†¡ ëŒ€ìƒë§Œ ì¡°íšŒ:
   - `nextReminderAt <= now`
   - `reminderSentForDate == null`
3. ê° ì‚¬ìš©ìì—ê²Œ FCM ì•Œë¦¼ ë°œì†¡
4. ë°œì†¡ ì„±ê³µ í›„ í•„ë“œ ì—…ë°ì´íŠ¸:
   - `reminderSentForDate` = today
   - `nextReminderAt` = tomorrow 19:00

## ğŸ¯ íš¨ê³¼

### ë¹„ìš© ì ˆê°
- **ê¸°ì¡´**: ë§¤ì¼ ì „ì²´ ì‚¬ìš©ì ì¡°íšŒ (10ë§Œëª… = 10ë§Œ read)
- **ë³€ê²½ í›„**: ë°œì†¡ ëŒ€ìƒë§Œ ì¡°íšŒ (ì˜ˆ: 1ë§Œëª… = 1ë§Œ read)
- **ì ˆê°ìœ¨**: ì•½ 90% (ì‹¤ì œ ë°œì†¡ ëŒ€ìƒ ë¹„ìœ¨ì— ë”°ë¼ ë‹¤ë¦„)

### ì„±ëŠ¥ ê°œì„ 
- ì „ì²´ ìŠ¤ìº” ì œê±°ë¡œ Cloud Function ì‹¤í–‰ ì‹œê°„ ë‹¨ì¶•
- ì¸ë±ìŠ¤ ê¸°ë°˜ ì¿¼ë¦¬ë¡œ ë¹ ë¥¸ ì¡°íšŒ
- í™•ì¥ì„± í™•ë³´ (100ë§Œëª… ì´ìƒì—ì„œë„ ì•ˆì •ì  ë™ì‘)

## âš ï¸ ì£¼ì˜ì‚¬í•­

1. **ì¸ë±ìŠ¤ ìƒì„± í•„ìˆ˜**: ì¸ë±ìŠ¤ê°€ ìƒì„±ë˜ê¸° ì „ê¹Œì§€ëŠ” ì¿¼ë¦¬ê°€ ì‹¤íŒ¨í•©ë‹ˆë‹¤.
2. **ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰**: ê¸°ì¡´ ì‚¬ìš©ìê°€ ìˆë‹¤ë©´ `migrateReminderFields` í•¨ìˆ˜ë¥¼ í•œ ë²ˆ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤.
   ```
   https://[region]-[project-id].cloudfunctions.net/migrateReminderFields?key=migrate_reminder_2026
   ```
3. **ì‹œê°„ëŒ€**: ëª¨ë“  ì‹œê°„ ê³„ì‚°ì€ Asia/Seoul ê¸°ì¤€ì…ë‹ˆë‹¤.
4. **ì¤‘ë³µ ë°œì†¡ ë°©ì§€**: `reminderSentForDate` í•„ë“œë¡œ í•˜ë£¨ 1íšŒë§Œ ë°œì†¡ë˜ë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤.

## ğŸ“ í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] Firestore ì¸ë±ìŠ¤ ìƒì„± ì™„ë£Œ
- [ ] ì‹ ê·œ ì‚¬ìš©ì ë¡œê·¸ì¸ ì‹œ `subjects` ë¬¸ì„œ ì´ˆê¸°í™” í™•ì¸
- [ ] ì»¨ë””ì…˜ ê¸°ë¡ ì‹œ ë¦¬ë§ˆì¸ë“œ í•„ë“œ ì—…ë°ì´íŠ¸ í™•ì¸
- [ ] 19:00 ë¦¬ë§ˆì¸ë“œ í‘¸ì‹œ ë°œì†¡ í…ŒìŠ¤íŠ¸
- [ ] ê¸°ë¡ ì™„ë£Œ ì‹œ ë¦¬ë§ˆì¸ë“œ ëŒ€ìƒì—ì„œ ì œì™¸ í™•ì¸
- [ ] ë§ˆì´ê·¸ë ˆì´ì…˜ í•¨ìˆ˜ ì‹¤í–‰ (ê¸°ì¡´ ì‚¬ìš©ì ìˆëŠ” ê²½ìš°)

## ğŸ”„ ë¡¤ë°± ë°©ë²•

ë¬¸ì œ ë°œìƒ ì‹œ:
1. Cloud Function `sendDailyReminder` ë¹„í™œì„±í™”
2. ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ ë³µêµ¬ (ì „ì²´ ìŠ¤ìº” ë°©ì‹)
3. í•„ë“œ ì—…ë°ì´íŠ¸ ë¡œì§ ì œê±° (MoodService, AuthService)
