rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 사용자 문서 - 본인만 읽기/쓰기 가능
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // 보호대상 문서 (subjectId = uid로 통일)
    match /subjects/{subjectUid} {
      // 보호 대상자 본인: 읽기/쓰기 가능
      function isSubject() {
        return request.auth != null && request.auth.uid == subjectUid;
      }
      
      // 보호자: 연결된 경우에만 읽기 가능
      function isGuardian() {
        return request.auth != null
          && request.auth.uid in resource.data.pairedGuardianUids;
      }
      
      // 보호 대상자 본인은 읽기/쓰기 가능
      allow read, write: if isSubject();
      
      // 보호자는 읽기만 가능 (B안: 가족 공유형 - 상태 공유 허용)
      allow read: if isGuardian();
      
      // 알림 문서
      match /alerts/{alertId} {
        allow read: if request.auth != null && 
          request.auth.uid in resource.data.guardianUids;
      }
      
      // 응답 문서 (prompts) - B안: 보호 대상자와 보호자 모두 읽기 가능
      match /prompts/{promptId} {
        // 보호 대상자 본인: 읽기/쓰기 가능
        allow read, write: if isSubject();
        
        // 보호자: 읽기만 가능 (최근 7일 상태 공유)
        allow read: if isGuardian();
      }
    }
    
    // 알림 컬렉션
    match /alerts/{alertId} {
      allow read: if request.auth != null && 
        request.auth.uid in resource.data.guardianUids;
    }
  }
  
  // 알림 요청 컬렉션 (Cloud Functions 전용, 앱에서만 생성)
  match /notification_requests/{requestId} {
    allow create: if request.auth != null;
    allow read, update: if false; // Functions만 읽기/업데이트 가능
  }
}
