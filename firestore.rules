// 오늘 어때? (HowAreYou) - Firestore 보안 규칙
// PRD §9: users/{uid} = Auth UID, subjects/{subjectUid} = 보호대상자 Auth UID (subjectUid === uid).
// 구조: users(uid), subjects(보호대상자uid), subjects/{subjectUid}/prompts(일일 응답), notification_requests
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // users/{userId} - 문서 ID = Firebase Auth UID
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth != null;
    }

    // subjects/{subjectUid} - 문서 ID = 보호대상자 Auth UID (별도 subject 식별자 없음)
    match /subjects/{subjectUid} {
      // 보호 대상자 본인: 읽기/쓰기 가능
      function isSubject() {
        return request.auth != null && request.auth.uid == subjectUid;
      }
      
      // 보호자: 연결된 경우에만 읽기 가능
      function isGuardian() {
        return request.auth != null
          && 'pairedGuardianUids' in resource.data
          && request.auth.uid in resource.data.get('pairedGuardianUids', []);
      }
      
      // 보호자가 자신을 pairedGuardianUids에 추가하는 경우 허용
      // 조건: 본인이 아니고, 자신의 UID를 pairedGuardianUids에 추가하는 경우
      function canAddSelfAsGuardian() {
        return request.auth != null
          && request.auth.uid != subjectUid  // 본인 문서가 아님
          && 'pairedGuardianUids' in request.resource.data
          && request.auth.uid in request.resource.data.pairedGuardianUids
          && (
            // 새 문서 생성 시
            !resource.exists
            // 기존 문서 업데이트 시 - 아직 보호자 목록에 없는 경우만 허용
            || !('pairedGuardianUids' in resource.data)
            || !(request.auth.uid in resource.data.get('pairedGuardianUids', []))
          );
      }
      
      // 보호 대상자 본인은 읽기/쓰기 가능
      allow read, write: if isSubject();
      
      // 보호자는 읽기만 가능 (B안: 가족 공유형 - 상태 공유 허용)
      allow read: if isGuardian();
      
      // 보호자가 보호 대상자 추가 시 기존 문서를 읽어야 하므로: 본인이 아닌 인증 사용자는 읽기 허용
      allow read: if request.auth != null && request.auth.uid != subjectUid;
      
      // 보호자가 자신을 pairedGuardianUids에서 제거하는 경우(계정 삭제 시) 쓰기 허용
      function canRemoveSelfAsGuardian() {
        return request.auth != null
          && resource.exists
          && request.auth.uid != subjectUid
          && 'pairedGuardianUids' in resource.data
          && request.auth.uid in resource.data.get('pairedGuardianUids', []);
      }
      // 보호자가 자신을 pairedGuardianUids에 추가하는 경우 쓰기 허용
      // 변경 가능한 필드: pairedGuardianUids, guardianInfos, displayName, phone만 허용
      allow write: if canRemoveSelfAsGuardian()
        && request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['pairedGuardianUids', 'guardianInfos'])
      || canAddSelfAsGuardian()
        && (
          !resource.exists  // 문서가 없으면 모든 필드 허용
          || request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['pairedGuardianUids', 'guardianInfos'])  // update() 사용 시 이 두 필드만 업데이트
            || request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['pairedGuardianUids', 'guardianInfos', 'displayName'])
            || request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['pairedGuardianUids', 'guardianInfos', 'phone'])
            || request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['pairedGuardianUids', 'guardianInfos', 'displayName', 'phone'])
        );
      
      // 알림 문서
      match /alerts/{alertId} {
        allow read: if request.auth != null && 
          request.auth.uid in resource.data.guardianUids;
      }
      
      // 응답 문서 (prompts) — answeredAt, slot만 저장. 보호자는 "기록 여부"만 확인 가능
      match /prompts/{promptId} {
        allow read, write: if isSubject();
        allow read: if request.auth != null
          && request.auth.uid != subjectUid
          && exists(/databases/$(database)/documents/subjects/$(subjectUid))
          && request.auth.uid in get(/databases/$(database)/documents/subjects/$(subjectUid)).data.get('pairedGuardianUids', []);
      }
      // private_prompts — mood, note. 보호대상자 본인만 읽기/쓰기 (진짜 비공개)
      match /private_prompts/{promptId} {
        allow read, write: if isSubject();
      }
    }
    
    // 알림 컬렉션
    match /alerts/{alertId} {
      allow read: if request.auth != null && 
        request.auth.uid in resource.data.guardianUids;
    }

    // 대기 초대 (미가입자 등록 - 가입 시 Cloud Functions에서 자동 연결)
    match /pending_guardian_invites/{docId} {
      allow create: if request.auth != null && request.resource.data.guardianUid == request.auth.uid;
      allow read, update, delete: if false;
    }
    match /pending_subject_invites/{docId} {
      allow create: if request.auth != null && request.resource.data.subjectUid == request.auth.uid;
      allow read, update, delete: if false;
    }

    // 홈페이지 베타 대기목록 - 누구나 생성 가능 (이메일, 연락처 수집)
    match /waitlist/{docId} {
      allow create: if true;
      allow read, update, delete: if false;
    }

    // 홈페이지 공지사항 - 누구나 읽기 가능 (관리자 쓰기는 API/Admin SDK 사용)
    match /announcements/{docId} {
      allow read: if true;
      allow write: if false;
    }

    // 1:1 문의 - 사용자 본인만 생성·읽기 가능 (관리자 답변은 API/Admin SDK 사용)
    match /inquiries/{inquiryId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // 서비스 개선 피드백 - 인증 사용자만 생성 가능 (읽기는 관리자/API 전용)
    match /service_feedback/{feedbackId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if false;
    }

    // 알림 요청 컬렉션 (Cloud Functions 전용, 앱에서만 생성)
    match /notification_requests/{requestId} {
      allow create: if request.auth != null;
      allow read, update: if false; // Functions만 읽기/업데이트 가능
    }
  }
}
