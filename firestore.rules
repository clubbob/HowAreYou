// 지금 어때? (HowAreYou) - Firestore 보안 규칙
// PRD §9: users/{uid} = Auth UID, subjects/{subjectUid} = 보호대상자 Auth UID (subjectUid === uid).
// 구조: users(uid), subjects(보호대상자uid), subjects/{subjectUid}/prompts(일일 응답), notification_requests
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // users/{userId} - 문서 ID = Firebase Auth UID
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth != null;
    }

    // subjects/{subjectUid} - 문서 ID = 보호대상자 Auth UID (별도 subject 식별자 없음)
    match /subjects/{subjectUid} {
      // 보호 대상자 본인: 읽기/쓰기 가능
      function isSubject() {
        return request.auth != null && request.auth.uid == subjectUid;
      }
      
      // 보호자: 연결된 경우에만 읽기 가능
      function isGuardian() {
        return request.auth != null
          && resource.data.pairedGuardianUids != null
          && request.auth.uid in resource.data.pairedGuardianUids;
      }
      
      // 보호자가 자신을 pairedGuardianUids에 추가하는 경우 허용
      // 조건: 본인이 아니고, 자신의 UID를 pairedGuardianUids에 추가하는 경우
      function canAddSelfAsGuardian() {
        return request.auth != null
          && request.auth.uid != subjectUid  // 본인 문서가 아님
          && (
            // 새 문서 생성 시
            (!resource.exists 
             && request.resource.data.pairedGuardianUids != null 
             && request.auth.uid in request.resource.data.pairedGuardianUids)
            // 기존 문서 업데이트 시 - pairedGuardianUids에 자신이 추가되는 경우
            || (resource.exists 
                && request.resource.data.pairedGuardianUids != null 
                && request.auth.uid in request.resource.data.pairedGuardianUids
                && (resource.data.pairedGuardianUids == null 
                    || !(request.auth.uid in resource.data.pairedGuardianUids)))
          );
      }
      
      // 보호 대상자 본인은 읽기/쓰기 가능
      allow read, write: if isSubject();
      
      // 보호자는 읽기만 가능 (B안: 가족 공유형 - 상태 공유 허용)
      allow read: if isGuardian();
      
      // 보호자가 보호 대상자 추가 시 기존 문서를 읽어야 하므로: 본인이 아닌 인증 사용자는 읽기 허용
      allow read: if request.auth != null && request.auth.uid != subjectUid;
      
      // 보호자가 자신을 pairedGuardianUids에 추가하는 경우 쓰기 허용
      // 변경 가능한 필드: pairedGuardianUids, guardianInfos, displayName, phone만 허용
      allow write: if canAddSelfAsGuardian()
        && (
          !resource.exists  // 문서가 없으면 모든 필드 허용
          || request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['pairedGuardianUids', 'guardianInfos'])  // update() 사용 시 이 두 필드만 업데이트
            || request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['pairedGuardianUids', 'guardianInfos', 'displayName'])
            || request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['pairedGuardianUids', 'guardianInfos', 'phone'])
            || request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['pairedGuardianUids', 'guardianInfos', 'displayName', 'phone'])
        );
      
      // 알림 문서
      match /alerts/{alertId} {
        allow read: if request.auth != null && 
          request.auth.uid in resource.data.guardianUids;
      }
      
      // 응답 문서 (prompts) - 보호 대상자: 읽기/쓰기, 보호자: 읽기만 (상태 공유)
      match /prompts/{promptId} {
        // 보호 대상자 본인: 읽기/쓰기 가능
        allow read, write: if isSubject();
        // 보호자: 부모 subject 문서의 pairedGuardianUids에 포함된 경우에만 읽기 (서브컬렉션은 resource가 prompt 문서이므로 get()으로 부모 조회)
        // pairedGuardianUids 필드 없음 시 빈 배열로 처리하여 null 오류 방지
        allow read: if request.auth != null
          && request.auth.uid != subjectUid
          && request.auth.uid in get(/databases/$(database)/documents/subjects/$(subjectUid)).data.get('pairedGuardianUids', []);
      }
    }
    
    // 알림 컬렉션
    match /alerts/{alertId} {
      allow read: if request.auth != null && 
        request.auth.uid in resource.data.guardianUids;
    }
  }
  
  // 알림 요청 컬렉션 (Cloud Functions 전용, 앱에서만 생성)
  match /notification_requests/{requestId} {
    allow create: if request.auth != null;
    allow read, update: if false; // Functions만 읽기/업데이트 가능
  }
}
