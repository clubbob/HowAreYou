최근 파일.
# 지금 어때? (HowAreYou) - 프로젝트 구현 현황 (최신)

**최종 업데이트**: 2026-01-27  
**버전**: MVP 완료 (B안: 가족 공유형 적용 완료)

---

## 📋 프로젝트 개요

**서비스명**: 지금 어때? (How Are You?)  
**목적**: 하루 3번(아침/점심/저녁) 사용자의 상태를 간단히 확인하고, 완전 무응답 상태가 일정 기간 지속될 경우 보호자에게 알림을 발송하는 Flutter 앱

**핵심 원칙 (B안: 가족 공유형)**:
- **"상태는 가족에게 '공유'되지만, 앱은 '감시/평가/세부 이력 추적'이 아니라 '안부 확인과 변화 감지'만 지원한다."**
- 감시하지 않는다 (시간별 상세 추적, 장기 로그, 내역 다운로드 등 제한)
- 판단하지 않는다 (우울/위험 판정 등 알고리즘 없음)
- 공유 범위 제한: 최근 7일까지만, 슬롯(아침/점심/저녁) 기준만, 정확한 시각 공유 없음

**타겟 사용자**:
- **보호대상자(Subject)**: 아이, 어르신, 또는 혼자 지내는 사용자
- **보호자(Guardian)**: 부모, 자녀, 배우자 등 연락 담당자

---

## 🛠 기술 스택

### 프론트엔드
- **Flutter**: 크로스 플랫폼 앱 개발 (Android/iOS)
- **상태 관리**: Provider 패턴
- **UI 라이브러리**: Material Design 3

### 백엔드 & 인프라
- **Firebase Authentication**: 전화번호 OTP 인증
- **Cloud Firestore**: NoSQL 데이터베이스
- **Firebase Cloud Messaging (FCM)**: 푸시 알림
- **Firebase Cloud Functions**: 서버리스 백엔드 로직
- **Cloud Scheduler**: 주기적 작업 실행 (미회신 판단)

### 주요 패키지

yaml
dependencies:
  firebase_core: ^3.6.0
  firebase_auth: ^5.3.1
  cloud_firestore: ^5.4.4
  firebase_messaging: ^15.1.3
  flutter_local_notifications: ^18.0.1
  provider: ^6.1.2
  intl: ^0.19.0
  timezone: ^0.9.4
  shared_preferences: ^2.2.2
  fl_chart: ^0.69.0


---

## ✨ 주요 기능

### 1. 역할 선택 시스템
- 앱 실행 시 "보호대상자 모드" 또는 "보호자 모드" 선택
- 마지막 선택 모드 자동 저장 및 복원 (shared_preferences)
- 한 사용자가 두 역할 모두 수행 가능

### 2. 보호대상자 기능

#### 일일 상태 확인 알림
- 매일 3회 로컬 알림 발송
  - 아침: 08:00
  - 점심: 12:00
  - 저녁: 18:00
- 알림 클릭 시 질문 화면으로 이동
- 한국 시간대(Asia/Seoul) 기준

#### 상태 응답
- 질문: "지금 어때?"
- 3가지 기분 선택:
  - 😊 좋아 (초록색, Mood.good)
  - 😐 보통 (주황색, Mood.normal)
  - 😞 안좋아 (빨간색, Mood.bad)
- 아이콘 선택 시 즉시 응답 완료
- 응답 완료 후 "고마워요." 메시지 표시
- 응답은 Firestore에 저장 (subjects/{subjectId}/prompts/{YYYY-MM-DD_slot})

#### 보호자 지정
- 전화번호로 보호자 검색 및 추가
- 보호자 이름 커스터마이징 가능 (별칭)
- 여러 보호자 지정 가능
- 본인 전화번호는 추가 불가

#### 내 상태 보기
- 오늘의 상태 (아침/점심/저녁) 한눈에 확인
- 최근 7일 추이 차트 (fl_chart 사용)
- 최근 7일 이력 테이블
- 공통 위젯 사용 (TodayStatusWidget, StatusTrendChart, StatusHistoryTable)

### 3. 보호자 기능

#### 보호 대상 확인
- 보호 대상자 목록 표시
- 각 보호 대상자의 오늘 상태 확인
- 최근 7일 추이 및 이력 확인
- 보호 대상자 이름 편집 가능

#### 알림 수신
- **응답 알림**: 보호 대상자가 상태를 확인했을 때
  - 예: "OO님이 아침 상태를 확인했습니다"
  - 소리 ON (Android 채널: guardian_notifications)
  - Cloud Functions onResponseCreated 트리거로 자동 발송
- **미회신 알림**: 연속 미응답 시
  - 조건: 어제 3회 모두 미응답 + 오늘 아침 미응답
  - 예: "OO님이 상태를 확인하지 않고 있습니다"
  - 매일 12:00에 Cloud Functions checkUnreachableSubjects에서 자동 판단

#### 안내 문구
- 대시보드 최상단에 안내 문구 표시
- "이 앱은 응답 '내용'은 공유하지 않으며, 안부 확인 여부만 알려줍니다."

---

## 📱 화면 구조

### 화면 목록

1. **SplashScreen** (splash_screen.dart)
   - 앱 시작 화면
   - 인증 상태 확인 후 자동 라우팅
   - "지금 어때?" 텍스트 표시

2. **AuthScreen** (auth_screen.dart)
   - 전화번호 OTP 로그인
   - Firebase Auth 연동
   - "지금 어때?" 텍스트 표시

3. **HomeScreen** (home_screen.dart)
   - 역할 선택 화면
   - "보호대상자 모드" / "보호자 모드" 버튼
   - 마지막 선택 모드 자동 복원 옵션
   - 제목: "지금 어때?"

4. **SubjectModeScreen** (subject_mode_screen.dart)
   - 보호대상자 메인 화면
   - "상태 알려주기" 버튼
   - "보호자 지정" 버튼
   - "내 상태 보기" 버튼
   - 제목: "보호대상자 모드"

5. **QuestionScreen** (question_screen.dart)
   - 상태 응답 화면
   - 기분 선택 (3가지)
   - 응답 저장 및 완료 처리
   - 제목: "상태 알려주기"

6. **GuardianScreen** (guardian_screen.dart)
   - 보호자 추가/관리 화면
   - 전화번호 검색
   - 보호자 이름 설정
   - 제목: "보호자 지정"

7. **SubjectMyStatusScreen** (subject_my_status_screen.dart)
   - 보호대상자 자신의 상태 이력 화면
   - 오늘 상태 위젯
   - 7일 추이 차트
   - 7일 이력 테이블
   - 제목: "내 상태 보기"

8. **GuardianModeScreen** (guardian_mode_screen.dart)
   - 보호자 메인 화면
   - "보호 대상 확인" 버튼
   - 제목: "보호자 모드"

9. **GuardianDashboardScreen** (guardian_dashboard_screen.dart)
   - 보호 대상자 목록 화면
   - 각 보호 대상자 카드 표시
   - 안내 문구 표시
   - 제목: "보호자 확인"

10. **SubjectDetailScreen** (subject_detail_screen.dart)
    - 보호 대상자 상세 상태 화면
    - 오늘 상태 위젯
    - 7일 추이 차트
    - 7일 이력 테이블
    - 제목: "보호 대상 상태"

11. **NoResponseScreen** (no_response_screen.dart)
    - 미응답 안내 화면
    - 보호자가 미응답 알림 클릭 시 표시
    - 제목: "회신 없음"

### 공통 위젯

- **TodayStatusWidget** (widgets/status_display_widgets.dart)
  - 오늘의 상태 (아침/점심/저녁) 표시
  - 색상 코딩된 배경과 이모지
  - 미응답 슬롯 클릭 가능 (보호자 화면에서)

- **StatusTrendChart** (widgets/status_display_widgets.dart)
  - 최근 7일 추이 막대 차트
  - 시간대별 색상 구분

- **StatusHistoryTable** (widgets/status_display_widgets.dart)
  - 최근 7일 이력 테이블
  - 날짜, 시간대, 기분 표시

---

## 🗄 데이터 모델

### Firestore 컬렉션 구조

#### /users/{uid}

dart
{
  phone: string,              // 전화번호 (E.164 형식)
  displayName: string?,       // 표시 이름
  fcmTokens: string[],        // FCM 토큰 배열 (다중 기기 지원)
  subjectLabels: {            // 보호자가 지정한 보호 대상자 별칭
    [subjectId]: string
  },
  createdAt: Timestamp,
  updatedAt: Timestamp
}


#### /subjects/{subjectUid} (subjectUid = uid)

dart
{
  displayName: string,                    // 보호 대상자 이름
  pairedGuardianUids: string[],          // 연결된 보호자 UID 배열
  guardianInfos: {                        // 보호자 정보
    [guardianUid]: {
      phone: string,
      displayName: string
    }
  },
  createdAt: Timestamp,
  updatedAt: Timestamp
}


#### /subjects/{subjectUid}/prompts/{YYYY-MM-DD_slot}

dart
{
  slot: 'morning' | 'noon' | 'evening',  // 시간대
  answeredAt: Timestamp,                  // 응답 시각
  mood: 1 | 2 | 3,                        // 1=좋아, 2=보통, 3=안좋아
  note: string?                           // 메모 (현재 미사용)
}


### Dart 모델 클래스

#### Mood enum

dart
enum Mood {
  good(emoji: '😊', label: '좋아', value: 1, color: Colors.green),
  normal(emoji: '😐', label: '보통', value: 2, color: Colors.orange),
  bad(emoji: '😞', label: '안좋아', value: 3, color: Colors.red);
  
  // 색상이 있는 아이콘 위젯 생성 메서드
  Widget buildColoredIcon({double size = 32})
  Widget buildLargeIcon({double size = 52})
}


#### TimeSlot enum

dart
enum TimeSlot {
  morning('morning', '아침', '08:00'),
  noon('noon', '점심', '12:00'),
  evening('evening', '저녁', '18:00');
}


#### MoodResponseModel

dart
class MoodResponseModel {
  final String subjectId;
  final String dateSlot;        // YYYY-MM-DD_slot 형식
  final TimeSlot slot;
  final DateTime answeredAt;
  final Mood mood;
  final String? note;
}


---

## 🔧 서비스 구조

### 주요 서비스 클래스

#### AuthService (services/auth_service.dart)
- Firebase Authentication 관리
- 전화번호 OTP 로그인
- 사용자 데이터 로드
- 로그아웃 처리
- Provider로 전역 상태 관리

#### MoodService (services/mood_service.dart)
- 기분 응답 저장 (saveMoodResponse)
- 오늘 응답 조회 (getTodayResponses)
- 최근 7일 응답 조회 (getLast7DaysResponses)
- 한국 시간대(Asia/Seoul) 처리

#### NotificationService (services/notification_service.dart)
- 로컬 알림 초기화 및 권한 요청
- 일일 알림 스케줄링 (아침/점심/저녁)
- 알림 클릭 처리 및 화면 라우팅
- Android 알림 채널 관리
  - daily_notifications: 일일 상태 확인 알림
  - guardian_notifications: 보호자 알림 (소리 ON)

#### FCMService (services/fcm_service.dart)
- FCM 토큰 등록 및 갱신
- 백그라운드 메시지 처리
- 포그라운드 메시지 처리
- 토큰 제거 (removeToken)

#### GuardianService (services/guardian_service.dart)
- 보호자 검색 (전화번호 기반)
- 보호자 추가/제거 (addMeAsGuardianToSubject)
- 보호 대상자-보호자 연결 관리
- 보호 대상자 목록 조회 (getSubjectIdsForGuardian)
- 보호 대상자 이름 조회 및 설정

#### ModeService (services/mode_service.dart)
- 역할 선택 모드 저장/로드 (shared_preferences 사용)
- 마지막 선택 모드 복원
- 상수: modeSubject, modeGuardian

---

## ☁️ Firebase Cloud Functions

### 함수 목록

#### onResponseCreated (Firestore Trigger)
- **트리거**: subjects/{subjectId}/prompts/{promptId} 문서 생성 시
- **기능**: 보호 대상자가 상태를 응답했을 때 보호자에게 알림 발송
- **알림 내용**: "OO님이 [아침/점심/저녁] 상태를 확인했습니다"
- **최적화**: 
  - sendToGuardian() 헬퍼 함수 사용
  - 보호자별로 별도 multicast 발송
  - Invalid 토큰 자동 제거

#### checkUnreachableSubjects (Cloud Scheduler)
- **스케줄**: 매일 12:00 (한국 시간, Asia/Seoul)
- **기능**: 미회신 조건 판단 및 알림 발송
- **미회신 조건**:
  - 어제(Day 1): 아침/점심/저녁 모두 미응답
  - 오늘(Day 2): 아침 미응답
- **알림 내용**: "OO님이 상태를 확인하지 않고 있습니다"
- **최적화**: 
  - 병렬 처리로 실행 시간 단축
  - sendToGuardian() 헬퍼 함수 사용
  - Invalid 토큰 자동 제거

#### sendToGuardian() (헬퍼 함수)
- **기능**: 보호자별 FCM 알림 발송 및 invalid 토큰 정리
- **로직**:
  1. 보호자 문서에서 FCM 토큰 조회
  2. 보호자별로 sendEachForMulticast 발송
  3. 실패한 토큰 중 invalid 토큰만 해당 보호자 문서에서 arrayRemove
- **Invalid 토큰 에러 코드**:
  - messaging/registration-token-not-registered
  - messaging/invalid-registration-token

### 비용 최적화
- notification_requests 컬렉션 제거 (Firestore 읽기/쓰기 비용 절감)
- Firestore 트리거를 통한 직접 알림 발송
- 병렬 처리로 Cloud Functions 실행 시간 단축
- 보호자별 토큰 정리로 불필요한 토큰 제거

---

## 🔐 Firestore Security Rules

### 주요 규칙 (B안: 가족 공유형)


javascript
match /subjects/{subjectUid} {
  // 보호 대상자 본인: 읽기/쓰기 가능
  function isSubject() {
    return request.auth != null && request.auth.uid == subjectUid;
  }
  
  // 보호자: 연결된 경우에만 읽기 가능
  function isGuardian() {
    return request.auth != null
      && request.auth.uid in resource.data.pairedGuardianUids;
  }
  
  allow read, write: if isSubject();
  allow read: if isGuardian();
  
  match /prompts/{promptId} {
    allow read, write: if isSubject();
    allow read: if isGuardian(); // 보호자 읽기 허용 (B안)
  }
}


### 보안 원칙
- subjectUid = uid로 통일 (문서 ID가 사용자 UID)
- 보호자는 prompts 읽기만 가능, 쓰기 불가
- 비연결 보호자는 접근 불가

---

## 🎨 UI/UX 특징

### 디자인 원칙
- **명확한 역할 구분**: 보호대상자/보호자 모드 분리
- **일관된 UI**: 공통 위젯으로 상태 표시 통일
- **직관적인 네비게이션**: 명확한 뒤로 가기 버튼 ("← 뒤로")
- **색상 코딩**: 기분별 색상으로 시각적 구분
  - 좋아: 초록색
  - 보통: 주황색
  - 안좋아: 빨간색

### 주요 UI 컴포넌트
- **뒤로 가기 버튼**: 모든 화면에서 통일된 스타일
  - 아이콘: arrow_back_ios_new (18px)
  - 텍스트: "뒤로" (16px)
  - 패딩: horizontal: 12, vertical: 8
  - 너비: leadingWidth: 80
- **상태 아이콘**: 원형 배경에 이모지 표시
  - buildColoredIcon(): 상태 페이지용 (32px)
  - buildLargeIcon(): 선택 화면용 (52px)

---

## 📊 현재 구현 상태

### ✅ 완료된 기능

1. **인증 시스템**
   - 전화번호 OTP 로그인
   - 사용자 데이터 관리
   - FCM 토큰 등록

2. **역할 선택 시스템**
   - 보호대상자/보호자 모드 선택
   - 마지막 선택 모드 저장/복원

3. **보호대상자 기능**
   - 일일 상태 확인 알림 (로컬 알림)
   - 상태 응답 (3가지 기분 선택)
   - 보호자 지정/관리
   - 내 상태 보기 (오늘 상태, 7일 추이, 7일 이력)

4. **보호자 기능**
   - 보호 대상자 목록 확인
   - 보호 대상자 상세 상태 확인 (최근 7일)
   - 응답 알림 수신
   - 미회신 알림 수신
   - 안내 문구 표시

5. **백엔드 로직**
   - 응답 시 보호자 알림 발송 (Cloud Functions)
   - 미회신 판단 및 알림 발송 (Cloud Scheduler)
   - FCM 토큰 정리 로직

6. **UI/UX 개선**
   - 공통 위젯으로 UI 통일
   - 색상 코딩된 기분 아이콘
   - 명확한 뒤로 가기 버튼
   - 로고 제거, 화면 제목으로 대체

7. **B안(가족 공유형) 적용**
   - Firestore Rules 수정 (보호자 prompts 읽기 허용)
   - 제품 원칙 문서 수정
   - Guardian 안내 문구 추가

8. **Firebase 배포**
   - Firestore Rules 배포 완료
   - Cloud Functions 배포 완료

### ⚠️ 제한 사항

1. **PRD와의 차이점**
   - PRD: 5가지 기분 (😊 좋아, 🙂 괜찮아, 😐 보통, 🙁 별로, 😞 힘들어)
   - 현재 구현: 3가지 기분 (😊 좋아, 😐 보통, 😞 안좋아)
   - 이유: UI 단순화 및 사용자 경험 개선

2. **미사용 기능**
   - note 필드: 현재 저장되지만 UI에서 입력 불가
   - NotificationRequestService: 비용 최적화로 제거됨

---

## ❓ 궁금한 점 (답변 필요)

### 1. 제품 전략 관련

**Q1-1. 기분 선택을 3가지로 축소한 것이 맞는가?**
- 현재: 3가지 (좋아/보통/안좋아)
- PRD 원래: 5가지 (좋아/괜찮아/보통/별로/힘들어)
- ChatGPT 피드백: "지금 단계에선 완전한 정답" (감정 분석이 아닌 안부 확인이 목적)
- **질문**: 향후 5가지로 확장할 계획이 있는가? 사용자 피드백을 받아 결정할 것인가?

**Q1-2. "응답 알림"의 필요성은?**
- 현재: 보호 대상자가 응답할 때마다 보호자에게 알림 발송
- ChatGPT 피드백: "일부 보호자는 '굳이 이 알림까지 필요해?' 라고 느낄 수 있음"
- **질문**: 응답 알림을 기본 ON으로 유지할 것인가? 아니면 설정에서 ON/OFF 옵션을 제공할 것인가?

**Q1-3. 보호자 추가 시 동의 UI가 필요한가?**
- ChatGPT 제안: 보호 대상자가 보호자 추가할 때 체크박스 "내 상태(최근 7일, 슬롯 기준)를 보호자에게 공유합니다."
- 현재: 동의 UI 없음
- **질문**: 법적/신뢰 측면에서 동의 UI를 추가해야 하는가? 언제 추가할 계획인가?

### 2. 기술 구현 관련

**Q2-1. Cloud Functions 재시도 정책은 어떻게 설정할 것인가?**
- 현재: 실패 시 로그만 출력
- ChatGPT 제안: 실패 시 Firestore에 실패 로그 남기기 (/notify_failures/{autoId})
- **질문**: 자동 재시도 정책을 설정할 것인가? 아니면 수동 모니터링으로 충분한가?

**Q2-2. 알림 권한 거부 시 UX 처리는 어떻게 할 것인가?**
- 현재: 권한 거부 시 안내 없음
- ChatGPT 제안: 권한 거부 시 "왜 필요한지 1문장 + 설정 이동" 바텀시트/다이얼로그
- **질문**: 언제 구현할 계획인가? MVP 출시 전 필수인가?

**Q2-3. Timezone 경계 테스트는 필요한가?**
- 현재: Asia/Seoul 시간대 사용
- ChatGPT 제안: 자정 경계 테스트 2~3개 추가 (예: 23:59 응답 → 다음날 00:01 판단)
- **질문**: 테스트 코드를 작성할 것인가? 아니면 수동 테스트로 충분한가?

**Q2-4. FCM 토큰 배열이 무한 증가할 가능성은?**
- 현재: arrayUnion으로만 추가, invalid 토큰은 Cloud Functions에서 제거
- ChatGPT 제안: 토큰 저장 구조 개선 (서브컬렉션 또는 별도 컬렉션)
- **질문**: 현재 구조로 충분한가? 향후 개선 계획이 있는가?

### 3. 사용자 경험 관련

**Q3-1. 첫 실행 시 안내 화면이 필요한가?**
- ChatGPT 제안: 첫 실행 시 3장짜리 초간단 안내
  - 감시 안 함
  - 판단 안 함
  - 안부만 연결
- 현재: 안내 화면 없음
- **질문**: 언제 추가할 계획인가? MVP 출시 전 필수인가?

**Q3-2. 보호자가 앱을 삭제하면 어떻게 처리할 것인가?**
- 현재: 로컬 알림도 사라짐, 서버는 "미응답"만 감지
- ChatGPT 제안: FAQ/안내 문구로 의도된 동작임을 명시
- **질문**: FAQ 섹션을 추가할 것인가? 어디에 배치할 것인가?

**Q3-3. 알림 시간 커스터마이징이 필요한가?**
- 현재: 고정 시간 (08:00, 12:00, 18:00)
- ChatGPT 제안: 설정 화면에서 알림 시간 변경 가능하도록 (고급 옵션)
- **질문**: 향후 추가할 계획이 있는가? 사용자 요청이 있을 때 추가할 것인가?

### 4. 데이터 및 보안 관련

**Q4-1. 보호자가 본 기록(열람 로그)을 남기지 않는 것이 맞는가?**
- 현재: 열람 로그 없음
- ChatGPT 제안: "감시 구조의 대표 요소 제거" (현재 구조 유지 권장)
- **질문**: 현재 구조를 유지할 것인가? 향후 분석 목적으로 열람 로그가 필요한가?

**Q4-2. 7일 초과 이력은 절대 제공하지 않는 것이 맞는가?**
- 현재: 최근 7일까지만 조회 가능
- ChatGPT 제안: "30일/1년/전체 이력은 절대 제공하지 않기" (감시/회고 방지)
- **질문**: 현재 7일 제한을 유지할 것인가? 향후 확장 계획이 있는가?

**Q4-3. 정확한 응답 시각을 공유하지 않는 것이 맞는가?**
- 현재: 슬롯(아침/점심/저녁)만 공유, 정확한 시각(예: 08:13)은 공유하지 않음
- ChatGPT 제안: "추적감을 확 줄입니다" (현재 구조 유지 권장)
- **질문**: 현재 구조를 유지할 것인가? 향후 정확한 시각이 필요한 사용 사례가 있는가?

---

## 🚧 부족한 기능 (개선 필요)

### 🔴 높은 우선순위 (출시 전 권장)

1. **알림 권한 거부 시 UX 처리**
   - 현재: 권한 거부 시 안내 없음
   - 필요: 권한 거부 시 안내 다이얼로그 및 설정 화면 안내
   - 예상 시간: 1-2시간
   - 파일: lib/services/notification_service.dart, lib/screens/subject_mode_screen.dart

2. **Timezone 경계 테스트**
   - 현재: 테스트 코드 없음
   - 필요: 자정 경계 테스트 케이스 추가
   - 예상 시간: 1-2시간
   - 파일: test/mood_service_test.dart (새 파일)

3. **Firestore Rules 테스트**
   - 현재: 수동 테스트만 가능
   - 필요: 보호자 prompts 읽기/쓰기 권한 테스트
   - 예상 시간: 2-3시간
   - 파일: test/firestore_rules_test.dart (새 파일)

### 🟡 중간 우선순위 (출시 후 추가 가능)

4. **보호자 추가 시 동의 UI**
   - 현재: 동의 UI 없음
   - 필요: 체크박스 "내 상태(최근 7일, 슬롯 기준)를 보호자에게 공유합니다."
   - 예상 시간: 1-2시간
   - 파일: lib/screens/guardian_screen.dart

5. **응답 알림 ON/OFF 설정**
   - 현재: 응답 알림 항상 발송
   - 필요: 보호자 설정에서 응답 알림 ON/OFF 옵션
   - 예상 시간: 3-4시간
   - 파일: lib/models/user_model.dart, lib/screens/settings_screen.dart (새 파일), functions/index.js

6. **알림 시간 커스터마이징**
   - 현재: 고정 시간 (08:00, 12:00, 18:00)
   - 필요: 설정 화면에서 알림 시간 변경 가능
   - 예상 시간: 4-5시간
   - 파일: lib/services/notification_service.dart, lib/screens/settings_screen.dart (새 파일)

7. **첫 실행 안내 화면**
   - 현재: 안내 화면 없음
   - 필요: 3장짜리 초간단 안내 (감시 안 함, 판단 안 함, 안부만 연결)
   - 예상 시간: 2-3시간
   - 파일: lib/screens/onboarding_screen.dart (새 파일)

8. **FAQ 섹션**
   - 현재: FAQ 없음
   - 필요: 자주 묻는 질문 섹션 추가
   - 예상 시간: 2-3시간
   - 파일: lib/screens/faq_screen.dart (새 파일)

### 🟢 낮은 우선순위 (장기 개선)

9. **에러 처리 강화**
   - 현재: 일부 try-catch 있으나 일관성 부족
   - 필요: 공통 에러 핸들러 추가, 네트워크 오류 처리
   - 예상 시간: 4-5시간
   - 파일: lib/utils/error_handler.dart (새 파일)

10. **오프라인 지원**
    - 현재: 오프라인 상태 처리 없음
    - 필요: Firestore 오프라인 캐싱, 오프라인 상태 UI
    - 예상 시간: 6-8시간
    - 파일: lib/services/offline_service.dart (새 파일)

11. **테스트 코드 작성**
    - 현재: 단위 테스트 없음
    - 필요: MoodService, GuardianService 등 핵심 로직 테스트
    - 예상 시간: 8-10시간
    - 파일: test/ 폴더

12. **성능 최적화**
    - 현재: 기본 최적화만 적용
    - 필요: Firestore 쿼리 최적화, 이미지 캐싱, 코드 스플리팅
    - 예상 시간: 6-8시간

13. **FCM 토큰 저장 구조 개선**
    - 현재: 배열로 저장 (fcmTokens: string[])
    - 필요: 서브컬렉션 또는 별도 컬렉션으로 변경
    - 예상 시간: 4-5시간
    - 파일: lib/services/fcm_service.dart, functions/index.js

14. **Cloud Functions 실패 로그 저장**
    - 현재: 실패 시 콘솔 로그만 출력
    - 필요: Firestore에 실패 로그 저장 (/notify_failures/{autoId})
    - 예상 시간: 2-3시간
    - 파일: functions/index.js

---

## 📈 향후 로드맵

### STEP 1. 출시 안정화 (현재 진행 중)
- ✅ Firestore Rules 수정 및 배포
- ✅ FCM 토큰 정리 로직 구현 및 배포
- ✅ Guardian 안내 문구 추가
- ⏳ 알림 권한 거부 시 UX 처리 (진행 예정)
- ⏳ Timezone 경계 테스트 (진행 예정)

### STEP 2. 사용자 경험 개선 (출시 후)
- 보호자 추가 시 동의 UI
- 응답 알림 ON/OFF 설정
- 첫 실행 안내 화면
- FAQ 섹션

### STEP 3. 고급 기능 (장기)
- 알림 시간 커스터마이징
- 에러 처리 강화
- 오프라인 지원
- 테스트 코드 작성

---

## 📝 참고 문서

- HowAreYou_PRD_v1.0.md: 제품 요구사항 정의서 (B안 기준으로 수정됨)
- docs/ChatGPT-피드백-검토.md: ChatGPT 피드백 및 검토 내용
- docs/B안-적용-완료.md: B안(가족 공유형) 적용 완료 보고
- docs/Firebase-배포-가이드.md: Firebase 배포 가이드
- firestore.rules: Firestore Security Rules
- functions/index.js: Cloud Functions 코드

---

## 💡 주요 설계 결정

1. **역할 선택 방식**: 자동 감지 대신 사용자 선택 방식 채택
   - 이유: 구현 단순성, 유연성, 사용자 제어

2. **기분 선택 단순화**: 5가지 → 3가지로 축소
   - 이유: UI 단순화, 사용자 부담 감소, 핵심 목적에 집중

3. **비용 최적화**: notification_requests 컬렉션 제거
   - 이유: Firestore 읽기/쓰기 비용 절감

4. **공통 위젯 사용**: 상태 표시 UI 통일
   - 이유: 코드 재사용, 일관된 UX

5. **로고 제거**: 화면 제목으로 대체
   - 이유: 기능 중심 UI, 명확한 네비게이션

6. **B안(가족 공유형) 채택**: 보호자가 상태를 볼 수 있도록 허용
   - 이유: 가족 케어 시나리오에서 사용자 기대에 부합
   - 제한: 7일까지만, 슬롯 기준만, 정확한 시각 공유 없음

---

**최종 업데이트**: 2026-01-27  
**작성자**: AI Assistant  
**검토 필요**: 궁금한 점 섹션 답변 필요

좋아. 최신 파일 기준으로 방향(=B안)도 일관되고, 기술/보안도 “출시 가능한 형태”까지 올라왔어.
이제 남은 건 **‘출시 전 반드시 해야 하는 것’ vs ‘출시 후에 해도 되는 것’**를 칼같이 나누고, 질문 섹션(Q1~Q4)에 결론을 박아주는 거야.

아래는 네 문서의 **“궁금한 점(답변 필요)”**에 대해, 지금 구조(B안, 7일/슬롯/정확시간 미공유)를 유지한다는 전제로 내가 추천하는 최종 답변이야. (바로 문서에 붙여도 됨)

✅ Q1-1. 기분 3가지 유지? 5가지 확장?

결론: 당분간 3가지 유지. 5가지는 ‘옵션’이 아니라 ‘제품 버전 업’으로, 사용자 피드백이 명확할 때만.

MVP의 핵심 KPI는 “응답률(체크인 성공률)”과 “미응답 감지 신뢰”임.

5단계는 정확도보다 사용자 부담을 올릴 확률이 더 큼.

특히 노인/아이 케이스에선 선택지가 늘면 무응답이 늘 수 있음.

✅ 실행 원칙

3단계 고정으로 1차 출시

출시 후 피드백에서 “중간 단계가 필요하다(괜찮아/별로)” 요구가 반복적으로 나오면 5단계 검토

✅ Q1-2. 응답 알림(“OO님이 확인했습니다”)은 기본 ON?

결론: 기본 ON 유지 + ‘보호자 설정에서 OFF 가능’은 출시 후(하지만 빨리) 추가 추천.

왜냐면:

B안은 “상태 공유”가 가치이므로, 보호자는 “오늘 체크인이 들어왔는지” 자체를 좋아함.

하지만 일부 보호자는 알림 피로도가 생김 → OFF 필요.

✅ 실행 원칙

출시 전: 기본 ON 유지 (제품 가치 전달)

출시 후: 설정 화면에서 “응답 알림 받기” 토글 추가 (1~2주 내)

✅ Q1-3. 보호자 추가 시 동의 UI 필요?

결론: ‘법적’이라기보다 ‘신뢰/분쟁 방지’ 차원에서 필요. 다만 MVP 출시 전 필수는 아님.

지금은:

보호대상자가 직접 보호자를 “추가”하는 행위 자체가 동의로 해석될 여지가 큼.

하지만 향후 배우자/성인 자녀/노인 케이스까지 확장하면 오해가 생길 수 있음.

✅ 실행 원칙 (최소 비용 버전)

출시 후 바로(중간 우선순위) 체크박스 1개 추가:

“내 상태(최근 7일, 슬롯 기준)를 보호자에게 공유합니다.”

추가로 더 강하게 가고 싶으면:

보호자 초대 방식(Subject가 초대 → Guardian 수락)도 가능하지만, MVP에선 과함.

✅ Q2-1. Cloud Functions 재시도 정책?

결론: ‘자동 재시도’보다 ‘실패 로그 저장 + 모니터링’이 먼저. MVP는 이게 더 안정적.

이유:

트리거 재시도는 환경/설정/버전에 따라 다르게 체감됨.

알림은 “실패를 눈치 못 채는 것”이 더 위험함.

✅ 실행 원칙

출시 전 권장: /notify_failures/{autoId} 실패 로그 저장

subjectUid, guardianUid, type, errorCode, createdAt 정도만 저장

출시 후: 실패 로그 누적 패턴 보고, 필요 시 Task Queue로 재시도 설계

✅ Q2-2. 알림 권한 거부 UX는 출시 전 필수?

결론: Subject(보호대상자) 쪽은 출시 전 ‘권장’, Guardian 쪽은 ‘필수에 가깝다’.

왜냐면:

Subject가 알림을 못 받으면 응답률이 급락 → 서비스가 작동하지 않는 것처럼 보임

Guardian이 알림을 못 받으면 “위험 감지”가 무력화

✅ 실행 원칙

출시 전 최소 UX:

권한 거부 감지

안내 문구 + “설정으로 이동” 버튼

다시 돌아오면 재확인

완벽한 설정 화면까지는 출시 후로 미뤄도 됨

✅ Q2-3. Timezone 테스트는 꼭 필요한가?

결론: 테스트 코드 2~3개는 추천. ‘수동 테스트만’은 나중에 반드시 한 번 터짐.

특히 터지는 지점:

자정 경계

scheduler의 “어제/오늘” 판정

사용자 기기 시간 이상(수동 변경)

✅ 실행 원칙

최소 테스트만:

dateSlot 생성이 날짜 경계에서 바뀌는지

scheduler 기준으로 day1/day2 문서 키가 기대대로 생성되는지(로직 단위로)

✅ Q2-4. FCM 토큰 배열 구조, 현재로 충분?

결론: 지금(배열 + invalid 토큰 제거) 구조로 MVP는 충분. 구조 변경은 ‘성장 후’에.

지금 이미:

보호자별 multicast

invalid 토큰 제거

이면 운영 안정성은 MVP 기준 충분히 나옴.

✅ 실행 원칙

현재 유지

단, 토큰 수가 많아지면(가족/기기 증가) 서브컬렉션 고려

✅ Q3-1. 첫 실행 안내 화면, 출시 전 필수?

결론: “필수는 아니지만, 전환율/신뢰에 큰 영향” → 출시 직후 빠르게 추가 추천.

B안은 “공유”가 있으니까, 안내가 없으면:

사용자(특히 성인)가 “내 상태가 공유되네?”를 뒤늦게 알면 불신으로 연결될 수 있음.

✅ 실행 원칙

출시 후 1~2주 내에 3장짜리 안내(초간단) 추가 추천

✅ Q3-2. 앱 삭제/미사용은 어떻게?

결론: FAQ 1개 항목으로 충분. 기능으로 해결하려 하지 말 것.

예시 FAQ 문구:

“휴대폰을 꺼두거나 앱을 삭제하면 미응답으로 표시될 수 있습니다.”

✅ 실행 원칙

FAQ는 설정 화면 생길 때 같이 넣거나,

지금은 Guardian 화면 하단에 작은 “도움말” 링크 하나로도 충분

✅ Q3-3. 알림 시간 커스터마이징?

결론: MVP에선 고정이 맞음. ‘요청이 실제로 발생할 때’ 추가.

시간 커스터마이징은:

UX도 복잡해지고

타임존/예약알림/권한 이슈가 늘어남

✅ 실행 원칙

고정 유지

단, “사용자 요청”이 쌓이면 프리미엄 기능으로도 좋음

✅ Q4-1. 보호자 열람 로그 남길까?

결론: 절대 남기지 말자(현재 유지). B안에서 감시처럼 느껴지는 대표 기능.

분석 목적이면:

열람 로그 대신 “알림 발송 성공/실패” 같은 시스템 로그만.

✅ Q4-2. 7일 제한 유지?

결론: 유지. (B안의 감시 방지 핵심 장치)

확장 필요가 생기면:

“보호대상자 본인만” 30일/1년 보기 허용은 가능

“보호자”는 7일 고정 권장

✅ Q4-3. 정확한 응답 시각 공유?

결론: 공유하지 않는 게 맞음(현재 유지).

시각 공유는 곧바로:

“왜 오늘은 늦었어?”

“항상 이 시간에 하잖아”
같은 통제/평가로 이어짐.

마지막으로: “출시 전” 작업 우선순위 재정렬 (너 문서 기준)
🔴 출시 전 사실상 필수

알림 권한 거부 UX 최소 처리 (Subject+Guardian)

Timezone 경계 최소 테스트 2~3개 (수동+자동 병행)

Functions 실패 로그 저장(간단 버전) (나중에 진짜 도움 됨)

🟡 출시 후 빠르게

보호자 추가 동의 체크박스

응답 알림 ON/OFF

원하면 내가 네 “최신 파일”에서 ‘궁금한 점(답변 필요)’ 섹션을 “답변 완료” 형태로 그대로 교체할 수 있게 문서용 텍스트로 정리해줄게.
또는 지금 바로 **출시 전 3개(권한 UX / timezone 테스트 / 실패 로그)**를 “패치 목록(파일별 수정 포인트)”로 뽑아줄까?